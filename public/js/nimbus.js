//Copyright NimbusBase (NimbusBase.com)
//Version 2.0
//License details at http://nimbusbase.com/pricing.html
// Generated by CoffeeScript 1.6.3
(function() {
  "use strict";
  var atob, b64chars, b64tab, btoa, btou, buffer, cb_btou, cb_decode, cb_encode, cb_utob, decode, encode, encodeURI, fromCharCode, global, noEnum, re_btou, re_utob, utob, version, _decode, _encode;

  global = this;

  if (global.Base64) {
    return;
  }

  version = "2.1.2";

  buffer = void 0;

  if (typeof module !== "undefined" && module.exports) {
    buffer = require("buffer").Buffer;
  }

  b64chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";

  b64tab = function(bin) {
    var i, l, t;
    t = {};
    i = 0;
    l = bin.length;
    while (i < l) {
      t[bin.charAt(i)] = i;
      i++;
    }
    return t;
  };

  b64chars;

  fromCharCode = String.fromCharCode;

  cb_utob = function(c) {
    var cc;
    if (c.length < 2) {
      cc = c.charCodeAt(0);
      if (cc < 0x80) {
        return c;
      } else {
        if (cc < 0x800) {
          return fromCharCode(0xc0 | (cc >>> 6)) + fromCharCode(0x80 | (cc & 0x3f));
        } else {
          return fromCharCode(0xe0 | ((cc >>> 12) & 0x0f)) + fromCharCode(0x80 | ((cc >>> 6) & 0x3f)) + fromCharCode(0x80 | (cc & 0x3f));
        }
      }
    } else {
      cc = 0x10000 + (c.charCodeAt(0) - 0xD800) * 0x400 + (c.charCodeAt(1) - 0xDC00);
      return fromCharCode(0xf0 | ((cc >>> 18) & 0x07)) + fromCharCode(0x80 | ((cc >>> 12) & 0x3f)) + fromCharCode(0x80 | ((cc >>> 6) & 0x3f)) + fromCharCode(0x80 | (cc & 0x3f));
    }
  };

  re_utob = /[\uD800-\uDBFF][\uDC00-\uDFFFF]|[^\x00-\x7F]/g;

  utob = function(u) {
    return u.replace(re_utob, cb_utob);
  };

  cb_encode = function(ccc) {
    var chars, ord, padlen;
    padlen = [0, 2, 1][ccc.length % 3];
    ord = ccc.charCodeAt(0) << 16 | ((ccc.length > 1 ? ccc.charCodeAt(1) : 0) << 8) | (ccc.length > 2 ? ccc.charCodeAt(2) : 0);
    chars = [b64chars.charAt(ord >>> 18), b64chars.charAt((ord >>> 12) & 63), (padlen >= 2 ? "=" : b64chars.charAt((ord >>> 6) & 63)), (padlen >= 1 ? "=" : b64chars.charAt(ord & 63))];
    return chars.join("");
  };

  btoa = global.btoa || function(b) {
    return b.replace(/[\s\S]{1,3}/g, cb_encode);
  };

  _encode = (buffer ? function(u) {
    return (new buffer(u)).toString("base64");
  } : function(u) {
    return btoa(utob(u));
  });

  encode = function(u, urisafe) {
    if (!urisafe) {
      return _encode(u);
    } else {
      return _encode(u).replace(/[+\/]/g, function(m0) {
        if (m0 === "+") {
          return "-";
        } else {
          return "_";
        }
      }).replace(RegExp("=", "g"), "");
    }
  };

  encodeURI = function(u) {
    return encode(u, true);
  };

  re_btou = re_btou = new RegExp(['[\xC0-\xDF][\x80-\xBF]', '[\xE0-\xEF][\x80-\xBF]{2}', '[\xF0-\xF7][\x80-\xBF]{3}'].join('|'), 'g');

  cb_btou = function(cccc) {
    var cp, offset;
    switch (cccc.length) {
      case 4:
        cp = ((0x07 & cccc.charCodeAt(0)) << 18) | ((0x3f & cccc.charCodeAt(1)) << 12) | ((0x3f & cccc.charCodeAt(2)) << 6) | (0x3f & cccc.charCodeAt(3));
        offset = cp - 0x10000;
        return fromCharCode((offset >>> 10) + 0xD800) + fromCharCode((offset & 0x3FF) + 0xDC00);
      case 3:
        return fromCharCode(((0x0f & cccc.charCodeAt(0)) << 12) | ((0x3f & cccc.charCodeAt(1)) << 6) | (0x3f & cccc.charCodeAt(2)));
      default:
        return fromCharCode(((0x1f & cccc.charCodeAt(0)) << 6) | (0x3f & cccc.charCodeAt(1)));
    }
  };

  btou = function(b) {
    return b.replace(re_btou, cb_btou);
  };

  cb_decode = function(cccc) {
    var chars, len, n, padlen;
    len = cccc.length;
    padlen = len % 4;
    n = (len > 0 ? b64tab[cccc.charAt(0)] << 18 : 0) | (len > 1 ? b64tab[cccc.charAt(1)] << 12 : 0) | (len > 2 ? b64tab[cccc.charAt(2)] << 6 : 0) | (len > 3 ? b64tab[cccc.charAt(3)] : 0);
    chars = [fromCharCode(n >>> 16), fromCharCode((n >>> 8) & 0xff), fromCharCode(n & 0xff)];
    chars.length -= [0, 0, 2, 1][padlen];
    return chars.join("");
  };

  atob = global.atob || function(a) {
    return a.replace(/[\s\S]{1,4}/g, cb_decode);
  };

  _decode = (buffer ? function(a) {
    return (new buffer(a, "base64")).toString();
  } : function(a) {
    return btou(atob(a));
  });

  decode = function(a) {
    return _decode(a.replace(/[-_]/g, function(m0) {
      if (m0 === "-") {
        return "+";
      } else {
        return "/";
      }
    }).replace(/[^A-Za-z0-9\+\/]/g, ""));
  };

  global.Base64 = {
    VERSION: version,
    atob: atob,
    btoa: btoa,
    fromBase64: decode,
    toBase64: encode,
    utob: utob,
    encode: encode,
    encodeURI: encodeURI,
    btou: btou,
    decode: decode
  };

  if (typeof Object.defineProperty === "function") {
    noEnum = function(v) {
      return {
        value: v,
        enumerable: false,
        writable: true,
        configurable: true
      };
    };
    global.Base64.extendString = function() {
      Object.defineProperty(String.prototype, "fromBase64", noEnum(function() {
        return decode(this);
      }));
      Object.defineProperty(String.prototype, "toBase64", noEnum(function(urisafe) {
        return encode(this, urisafe);
      }));
      return Object.defineProperty(String.prototype, "toBase64URI", noEnum(function() {
        return encode(this, true);
      }));
    };
  }

}).call(this);
(function(){function pathToTree(e){for(var t,n=e.shift(),o=[n.id,n.opts,[]],r=o;e.length;)n=e.shift(),t=[n.id,n.opts,[]],r[2].push(t),r=t;return o}function mergeTree(e,t){for(var n=[{tree1:e,tree2:t}],o=!1;n.length>0;){var r=n.pop(),i=r.tree1,u=r.tree2;(i[1].status||u[1].status)&&(i[1].status="available"===i[1].status||"available"===u[1].status?"available":"missing");for(var a=0;u[2].length>a;a++)if(i[2][0]){for(var s=!1,c=0;i[2].length>c;c++)i[2][c][0]===u[2][a][0]&&(n.push({tree1:i[2][c],tree2:u[2][a]}),s=!0);s||(o="new_branch",i[2].push(u[2][a]),i[2].sort())}else o="new_leaf",i[2][0]=u[2][a]}return{conflicts:o,tree:e}}function doMerge(e,t,n){var o,r=[],i=!1,u=!1;return e.length?(e.forEach(function(e){if(e.pos===t.pos&&e.ids[0]===t.ids[0])o=mergeTree(e.ids,t.ids),r.push({pos:e.pos,ids:o.tree}),i=i||o.conflicts,u=!0;else if(n!==!0){var a=e.pos<t.pos?e:t,s=e.pos<t.pos?t:e,c=s.pos-a.pos,l=[],d=[];for(d.push({ids:a.ids,diff:c,parent:null,parentIdx:null});d.length>0;){var f=d.pop();0!==f.diff?f.ids&&f.ids[2].forEach(function(e,t){d.push({ids:e,diff:f.diff-1,parent:f.ids,parentIdx:t})}):f.ids[0]===s.ids[0]&&l.push(f)}var p=l[0];p?(o=mergeTree(p.ids,s.ids),p.parent[2][p.parentIdx]=o.tree,r.push({pos:a.pos,ids:a.ids}),i=i||o.conflicts,u=!0):r.push(e)}else r.push(e)}),u||r.push(t),r.sort(function(e,t){return e.pos-t.pos}),{tree:r,conflicts:i||"internal_node"}):{tree:[t],conflicts:"new_leaf"}}function stem(e,t){var n=PouchMerge.rootToLeaf(e).map(function(e){var n=e.ids.slice(-t);return{pos:e.pos+(e.ids.length-n.length),ids:pathToTree(n)}});return n.reduce(function(e,t){return doMerge(e,t,!0).tree},[n.shift()])}function replicate(e,t,n,o){function r(o,r,i){if(n.onChange)for(var u=0;i>u;u++)n.onChange.apply(this,[P]);m-=i,P.docs_written+=i,writeCheckpoint(e,t,h,g,function(){f.notifyRequestComplete(),d()})}function i(){if(!p.length)return f.notifyRequestComplete();var e=p.length;t.bulkDocs({docs:p},{new_edits:!1},function(t,n){r(t,n,e)}),p=[]}function u(t,n){e.get(t,{revs:!0,rev:n,attachments:!0},function(e,t){P.docs_read++,f.notifyRequestComplete(),p.push(t),f.enqueue(i)})}function a(e){return function(t,r){if(f.notifyRequestComplete(),t)return y&&o.cancel(),PouchUtils.call(n.complete,t,null),void 0;if(0===Object.keys(r).length){for(var i in e)m-=e[i];return d(),void 0}var a=function(e){f.enqueue(u,[s,e])};for(var s in r){var c=e[s]-r[s].missing.length;m-=c,r[s].missing.forEach(a)}}}function s(e,n){t.revsDiff(e,a(n))}function c(e){g=e.seq,v.push(e);var t={};t[e.id]=e.changes.map(function(e){return e.rev});var n={};n[e.id]=e.changes.length,m+=e.changes.length,f.enqueue(s,[t,n])}function l(){_=!0,d()}function d(){_&&0===m&&(P.end_time=new Date,PouchUtils.call(n.complete,null,P))}var f=new RequestManager,p=[],h=genReplicationId(e,t,n),v=[],_=!1,m=0,g=0,y=n.continuous||!1,E=n.doc_ids,P={ok:!0,start_time:new Date,docs_read:0,docs_written:0};fetchCheckpoint(e,t,h,function(t,r){if(t)return PouchUtils.call(n.complete,t);if(g=r,!o.cancelled){var i={continuous:y,since:g,style:"all_docs",onChange:c,complete:l,doc_ids:E};n.filter&&(i.filter=n.filter),n.query_params&&(i.query_params=n.query_params);var u=e.changes(i);n.continuous&&(o.cancel=u.cancel)}})}function toPouch(e,t){return"string"==typeof e?new Pouch(e,t):(t(null,e),void 0)}function arrayFirst(e,t){for(var n=0;e.length>n;n++)if(t(e[n],n)===!0)return e[n];return!1}function yankError(e){return function(t,n){t||n[0].error?call(e,t||n[0]):call(e,null,n[0])}}function computeHeight(e){var t={},n=[];return PouchMerge.traverseRevTree(e,function(e,o,r,i){var u=o+"-"+r;return e&&(t[u]=0),void 0!==i&&n.push({from:i,to:u}),u}),n.reverse(),n.forEach(function(e){t[e.from]=void 0===t[e.from]?1+t[e.to]:Math.min(t[e.from],1+t[e.to])}),t}function parseUri(e){for(var t=parseUri.options,n=t.parser[t.strictMode?"strict":"loose"].exec(e),o={},r=14;r--;)o[t.key[r]]=n[r]||"";return o[t.q.name]={},o[t.key[12]].replace(t.q.parser,function(e,n,r){n&&(o[t.q.name][n]=r)}),o}function encodeDocId(e){return/^_design/.test(e)?e:encodeURIComponent(e)}function getHost(e,t){if(/http(s?):/.test(e)){var n=parseUri(e);n.remote=!0,(n.user||n.password)&&(n.auth={username:n.user,password:n.password});var o=n.path.replace(/(^\/|\/$)/g,"").split("/");if(n.db=o.pop(),n.path=o.join("/"),t=t||{},n.headers=t.headers||{},t.auth||n.auth){var r=t.auth||n.auth,i=PouchUtils.btoa(r.username+":"+r.password);n.headers.Authorization="Basic "+i}return t.headers&&(n.headers=t.headers),n}return{host:"",path:"/",db:e,auth:!1}}function genDBUrl(e,t){if(e.remote){var n=e.path?"/":"";return e.protocol+"://"+e.host+":"+e.port+"/"+e.path+n+e.db+"/"+t}return"/"+e.db+"/"+t}function genUrl(e,t){if(e.remote){var n=e.path?"/":"";return e.protocol+"://"+e.host+":"+e.port+"/"+e.path+n+t}return"/"+t}function quote(e){return"'"+e+"'"}var uuid;(function(){var e="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split("");uuid=function(t,n){var o,r=e,i=[];if(n=n||r.length,t)for(o=0;t>o;o++)i[o]=r[0|Math.random()*n];else{var u;for(i[8]=i[13]=i[18]=i[23]="-",i[14]="4",o=0;36>o;o++)i[o]||(u=0|16*Math.random(),i[o]=r[19==o?8|3&u:u])}return i.join("")}})(),"undefined"!=typeof module&&module.exports&&(module.exports=uuid);var Crypto={};(function(){Crypto.MD5=function(e){function t(e,t){return e<<t|e>>>32-t}function n(e,t){var n,o,r,i,u;return r=2147483648&e,i=2147483648&t,n=1073741824&e,o=1073741824&t,u=(1073741823&e)+(1073741823&t),n&o?2147483648^u^r^i:n|o?1073741824&u?3221225472^u^r^i:1073741824^u^r^i:u^r^i}function o(e,t,n){return e&t|~e&n}function r(e,t,n){return e&n|t&~n}function i(e,t,n){return e^t^n}function u(e,t,n){return t^(e|~n)}function a(e,r,i,u,a,s,c){return e=n(e,n(n(o(r,i,u),a),c)),n(t(e,s),r)}function s(e,o,i,u,a,s,c){return e=n(e,n(n(r(o,i,u),a),c)),n(t(e,s),o)}function c(e,o,r,u,a,s,c){return e=n(e,n(n(i(o,r,u),a),c)),n(t(e,s),o)}function l(e,o,r,i,a,s,c){return e=n(e,n(n(u(o,r,i),a),c)),n(t(e,s),o)}function d(e){for(var t,n=e.length,o=n+8,r=(o-o%64)/64,i=16*(r+1),u=Array(i-1),a=0,s=0;n>s;)t=(s-s%4)/4,a=8*(s%4),u[t]=u[t]|e.charCodeAt(s)<<a,s++;return t=(s-s%4)/4,a=8*(s%4),u[t]=u[t]|128<<a,u[i-2]=n<<3,u[i-1]=n>>>29,u}function f(e){var t,n,o="",r="";for(n=0;3>=n;n++)t=255&e>>>8*n,r="0"+t.toString(16),o+=r.substr(r.length-2,2);return o}var p,h,v,_,m,g,y,E,P,S=[],O=7,b=12,T=17,R=22,q=5,k=9,C=14,D=20,w=4,U=11,A=16,x=23,j=6,I=10,N=15,B=21;for(S=d(e),g=1732584193,y=4023233417,E=2562383102,P=271733878,p=0;S.length>p;p+=16)h=g,v=y,_=E,m=P,g=a(g,y,E,P,S[p+0],O,3614090360),P=a(P,g,y,E,S[p+1],b,3905402710),E=a(E,P,g,y,S[p+2],T,606105819),y=a(y,E,P,g,S[p+3],R,3250441966),g=a(g,y,E,P,S[p+4],O,4118548399),P=a(P,g,y,E,S[p+5],b,1200080426),E=a(E,P,g,y,S[p+6],T,2821735955),y=a(y,E,P,g,S[p+7],R,4249261313),g=a(g,y,E,P,S[p+8],O,1770035416),P=a(P,g,y,E,S[p+9],b,2336552879),E=a(E,P,g,y,S[p+10],T,4294925233),y=a(y,E,P,g,S[p+11],R,2304563134),g=a(g,y,E,P,S[p+12],O,1804603682),P=a(P,g,y,E,S[p+13],b,4254626195),E=a(E,P,g,y,S[p+14],T,2792965006),y=a(y,E,P,g,S[p+15],R,1236535329),g=s(g,y,E,P,S[p+1],q,4129170786),P=s(P,g,y,E,S[p+6],k,3225465664),E=s(E,P,g,y,S[p+11],C,643717713),y=s(y,E,P,g,S[p+0],D,3921069994),g=s(g,y,E,P,S[p+5],q,3593408605),P=s(P,g,y,E,S[p+10],k,38016083),E=s(E,P,g,y,S[p+15],C,3634488961),y=s(y,E,P,g,S[p+4],D,3889429448),g=s(g,y,E,P,S[p+9],q,568446438),P=s(P,g,y,E,S[p+14],k,3275163606),E=s(E,P,g,y,S[p+3],C,4107603335),y=s(y,E,P,g,S[p+8],D,1163531501),g=s(g,y,E,P,S[p+13],q,2850285829),P=s(P,g,y,E,S[p+2],k,4243563512),E=s(E,P,g,y,S[p+7],C,1735328473),y=s(y,E,P,g,S[p+12],D,2368359562),g=c(g,y,E,P,S[p+5],w,4294588738),P=c(P,g,y,E,S[p+8],U,2272392833),E=c(E,P,g,y,S[p+11],A,1839030562),y=c(y,E,P,g,S[p+14],x,4259657740),g=c(g,y,E,P,S[p+1],w,2763975236),P=c(P,g,y,E,S[p+4],U,1272893353),E=c(E,P,g,y,S[p+7],A,4139469664),y=c(y,E,P,g,S[p+10],x,3200236656),g=c(g,y,E,P,S[p+13],w,681279174),P=c(P,g,y,E,S[p+0],U,3936430074),E=c(E,P,g,y,S[p+3],A,3572445317),y=c(y,E,P,g,S[p+6],x,76029189),g=c(g,y,E,P,S[p+9],w,3654602809),P=c(P,g,y,E,S[p+12],U,3873151461),E=c(E,P,g,y,S[p+15],A,530742520),y=c(y,E,P,g,S[p+2],x,3299628645),g=l(g,y,E,P,S[p+0],j,4096336452),P=l(P,g,y,E,S[p+7],I,1126891415),E=l(E,P,g,y,S[p+14],N,2878612391),y=l(y,E,P,g,S[p+5],B,4237533241),g=l(g,y,E,P,S[p+12],j,1700485571),P=l(P,g,y,E,S[p+3],I,2399980690),E=l(E,P,g,y,S[p+10],N,4293915773),y=l(y,E,P,g,S[p+1],B,2240044497),g=l(g,y,E,P,S[p+8],j,1873313359),P=l(P,g,y,E,S[p+15],I,4264355552),E=l(E,P,g,y,S[p+6],N,2734768916),y=l(y,E,P,g,S[p+13],B,1309151649),g=l(g,y,E,P,S[p+4],j,4149444226),P=l(P,g,y,E,S[p+11],I,3174756917),E=l(E,P,g,y,S[p+2],N,718787259),y=l(y,E,P,g,S[p+9],B,3951481745),g=n(g,h),y=n(y,v),E=n(E,_),P=n(P,m);var M=f(g)+f(y)+f(E)+f(P);return M.toLowerCase()}})(),"undefined"!=typeof module&&module.exports&&(module.exports=Crypto),function(){if(!Object.defineProperty||!function(){try{return Object.defineProperty({},"x",{}),!0}catch(e){return!1}}()){var e=Object.defineProperty;Object.defineProperty=function(t,n,o){"use strict";if(e)try{return e(t,n,o)}catch(r){}if(t!==Object(t))throw new TypeError("Object.defineProperty called on non-object");return Object.prototype.__defineGetter__&&"get"in o&&Object.prototype.__defineGetter__.call(t,n,o.get),Object.prototype.__defineSetter__&&"set"in o&&Object.prototype.__defineSetter__.call(t,n,o.set),"value"in o&&(t[n]=o.value),t}}}(),Object.keys||(Object.keys=function(e){if(e!==Object(e))throw new TypeError("Object.keys called on non-object");var t,n=[];for(t in e)Object.prototype.hasOwnProperty.call(e,t)&&n.push(t);return n}),Array.prototype.forEach||(Array.prototype.forEach=function(e){"use strict";if(void 0===this||null===this)throw new TypeError;var t=Object(this),n=t.length>>>0;if("function"!=typeof e)throw new TypeError;var o,r=arguments[1];for(o=0;n>o;o++)o in t&&e.call(r,t[o],o,t)}),Array.prototype.map||(Array.prototype.map=function(e){"use strict";if(void 0===this||null===this)throw new TypeError;var t=Object(this),n=t.length>>>0;if("function"!=typeof e)throw new TypeError;var o=[];o.length=n;var r,i=arguments[1];for(r=0;n>r;r++)r in t&&(o[r]=e.call(i,t[r],r,t));return o});for(var class2type={},types=["Boolean","Number","String","Function","Array","Date","RegExp","Object","Error"],i=0;types.length>i;i++){var typename=types[i];class2type["[object "+typename+"]"]=typename.toLowerCase()}var core_toString=class2type.toString,core_hasOwn=class2type.hasOwnProperty,type=function(e){return null===e?e+"":"object"==typeof e||"function"==typeof e?class2type[core_toString.call(e)]||"object":typeof e},isWindow=function(e){return null!==e&&e===e.window},isPlainObject=function(e){if(!e||"object"!==type(e)||e.nodeType||isWindow(e))return!1;try{if(e.constructor&&!core_hasOwn.call(e,"constructor")&&!core_hasOwn.call(e.constructor.prototype,"isPrototypeOf"))return!1}catch(t){return!1}var n;for(n in e);return void 0===n||core_hasOwn.call(e,n)},isFunction=function(e){return"function"===type(e)},isArray=Array.isArray||function(e){return"array"===type(e)},extend=function(){var e,t,n,o,r,i,u=arguments[0]||{},a=1,s=arguments.length,c=!1;for("boolean"==typeof u&&(c=u,u=arguments[1]||{},a=2),"object"==typeof u||isFunction(u)||(u={}),s===a&&(u=this,--a);s>a;a++)if(null!=(e=arguments[a]))for(t in e)n=u[t],o=e[t],u!==o&&(c&&o&&(isPlainObject(o)||(r=isArray(o)))?(r?(r=!1,i=n&&isArray(n)?n:[]):i=n&&isPlainObject(n)?n:{},u[t]=extend(c,i,o)):void 0!==o&&(isArray(e)&&isFunction(o)||(u[t]=o)));return u};"undefined"!=typeof module&&module.exports&&(module.exports=extend);var request,extend;"undefined"!=typeof module&&module.exports&&(request=require("request"),extend=require("./extend.js"));var ajax=function ajax(e,t){function n(e,t,n){if(n){var o=new Date;o.setTime(o.getTime()+1e3*60*60*24*n);var r="; expires="+o.toGMTString()}else var r="";document.cookie=e+"="+t+r+"; path=/"}"function"==typeof e&&(t=e,e={});var o=function(e){var t=Array.prototype.slice.call(arguments,1);typeof e==typeof Function&&e.apply(this,t)},r={method:"GET",headers:{},json:!0,processData:!0,timeout:1e4};e=extend(!0,r,e);var i=function(t,n,r){if(e.binary||e.json||!e.processData||"string"==typeof t){if(!e.binary&&e.json&&"string"==typeof t)try{t=JSON.parse(t)}catch(i){return o(r,i),void 0}}else t=JSON.stringify(t);o(r,null,t,n)},u=function(e,t){var n,r={status:e.status};try{n=JSON.parse(e.responseText),r=extend(!0,{},r,n)}catch(i){}o(t,r)};if("undefined"!=typeof window&&window.XMLHttpRequest){var a,s=!1,c=new XMLHttpRequest;c.open(e.method,e.url),c.withCredentials=!0,e.json&&(e.headers.Accept="application/json",e.headers["Content-Type"]=e.headers["Content-Type"]||"application/json",e.body&&e.processData&&"string"!=typeof e.body&&(e.body=JSON.stringify(e.body))),e.binary&&(c.responseType="arraybuffer");for(var l in e.headers)if("Cookie"===l){var d=e.headers[l].split("=");n(d[0],d[1],10)}else c.setRequestHeader(l,e.headers[l]);"body"in e||(e.body=null);var f=function(){s=!0,c.abort(),o(u,c,t)};return c.onreadystatechange=function(){if(4===c.readyState&&!s)if(clearTimeout(a),c.status>=200&&300>c.status){var n;n=e.binary?new Blob([c.response||""],{type:c.getResponseHeader("Content-Type")}):c.responseText,o(i,n,c,t)}else o(u,c,t)},e.timeout>0&&(a=setTimeout(f,e.timeout)),c.send(e.body),{abort:f}}return e.json&&(e.binary||(e.headers.Accept="application/json"),e.headers["Content-Type"]=e.headers["Content-Type"]||"application/json"),e.binary&&(e.encoding=null,e.json=!1),e.processData||(e.json=!1),request(e,function(n,r,a){if(n)return n.status=r?r.statusCode:400,o(u,n,t);var s=r.headers["content-type"],c=a||"";if(e.binary||!e.json&&e.processData||"object"==typeof c||!(/json/.test(s)||/^[\s]*\{/.test(c)&&/\}[\s]*$/.test(c))||(c=JSON.parse(c)),r.statusCode>=200&&300>r.statusCode)o(i,c,r,t);else{if(e.binary)var c=JSON.parse(""+c);c.status=r.statusCode,o(t,c)}})};"undefined"!=typeof module&&module.exports&&(module.exports=ajax);var PouchUtils;"undefined"!=typeof module&&module.exports&&(PouchUtils=require("./pouch.utils.js"));var Pouch=function Pouch(e,t,n){if(!(this instanceof Pouch))return new Pouch(e,t,n);("function"==typeof t||t===void 0)&&(n=t,t={}),"object"==typeof e&&(t=e,e=void 0),n===void 0&&(n=function(){});var o=Pouch.parseAdapter(t.name||e);if(t.originalName=e,t.name=t.name||o.name,t.adapter=t.adapter||o.adapter,!Pouch.adapters[t.adapter])throw"Adapter is missing";if(!Pouch.adapters[t.adapter].valid())throw"Invalid Adapter";var r=new PouchAdapter(t,function(e,t){if(e)return n&&n(e),void 0;for(var o in Pouch.plugins){var r=Pouch.plugins[o](t);for(var i in r)i in t||(t[i]=r[i])}t.taskqueue.ready(!0),t.taskqueue.execute(t),n(null,t)});for(var i in r)this[i]=r[i];for(var u in Pouch.plugins){var a=Pouch.plugins[u](this);for(var s in a)s in this||(this[s]=a[s])}};if(Pouch.DEBUG=!1,Pouch.openReqList={},Pouch.adapters={},Pouch.plugins={},Pouch.prefix="_pouch_",Pouch.parseAdapter=function(e){var t,n=e.match(/([a-z\-]*):\/\/(.*)/);if(n){if(e=/http(s?)/.test(n[1])?n[1]+"://"+n[2]:n[2],t=n[1],!Pouch.adapters[t].valid())throw"Invalid adapter";return{name:e,adapter:n[1]}}for(var o=["idb","leveldb","websql"],r=0;o.length>r;++r)if(o[r]in Pouch.adapters){t=Pouch.adapters[o[r]];var i="use_prefix"in t?t.use_prefix:!0;return{name:i?Pouch.prefix+e:e,adapter:o[r]}}throw"No valid adapter found"},Pouch.destroy=function(e,t,n){("function"==typeof t||t===void 0)&&(n=t,t={}),"object"==typeof e&&(t=e,e=void 0),n===void 0&&(n=function(){});var o=Pouch.parseAdapter(t.name||e),r=function(e){if(e)return n(e),void 0;for(var r in Pouch.plugins)Pouch.plugins[r]._delete(o.name);Pouch.DEBUG&&console.log(o.name+": Delete Database"),Pouch.adapters[o.adapter].destroy(o.name,t,n)};Pouch.removeFromAllDbs(o,r)},Pouch.removeFromAllDbs=function(e,t){if(!Pouch.enableAllDbs)return t(),void 0;var n=e.adapter;return"http"===n||"https"===n?(t(),void 0):(new Pouch(Pouch.allDBName(e.adapter),function(n,o){if(n)return console.error(n),t(),void 0;var r=Pouch.dbName(e.adapter,e.name);o.get(r,function(e,n){e?t():o.remove(n,function(e){e&&console.error(e),t()})})}),void 0)},Pouch.adapter=function(e,t){t.valid()&&(Pouch.adapters[e]=t)},Pouch.plugin=function(e,t){Pouch.plugins[e]=t},Pouch.enableAllDbs=!1,Pouch.ALL_DBS="_allDbs",Pouch.dbName=function(e,t){return[e,"-",t].join("")},Pouch.realDBName=function(e,t){return[e,"://",t].join("")},Pouch.allDBName=function(e){return[e,"://",Pouch.prefix+Pouch.ALL_DBS].join("")},Pouch.open=function(e,t){if(!Pouch.enableAllDbs)return t(),void 0;var n=e.adapter;return"http"===n||"https"===n?(t(),void 0):(new Pouch(Pouch.allDBName(n),function(o,r){if(o)return console.error(o),t(),void 0;var i=Pouch.dbName(n,e.name);r.get(i,function(n){n&&404===n.status?r.put({_id:i,dbname:e.originalName},function(e){e&&console.error(e),t()}):t()})}),void 0)},Pouch.allDbs=function(e){var t=function(n,o){if(0===n.length){var r=[];return o.forEach(function(e){var t=r.some(function(t){return t.id===e.id});t||r.push(e)}),e(null,r.map(function(e){return e.doc.dbname})),void 0}var i=n.shift();return"http"===i||"https"===i?(t(n,o),void 0):(new Pouch(Pouch.allDBName(i),function(r,i){return r?(e(r),void 0):(i.allDocs({include_docs:!0},function(r,i){return r?(e(r),void 0):(o.unshift.apply(o,i.rows),t(n,o),void 0)}),void 0)}),void 0)},n=Object.keys(Pouch.adapters);t(n,[])},Pouch.uuids=function(e,t){"object"!=typeof t&&(t={});for(var n=t.length,o=t.radix,r=[];e>r.push(PouchUtils.uuid(n,o)););return r},Pouch.uuid=function(e){return Pouch.uuids(1,e)[0]},Pouch.Errors={MISSING_BULK_DOCS:{status:400,error:"bad_request",reason:"Missing JSON list of 'docs'"},MISSING_DOC:{status:404,error:"not_found",reason:"missing"},REV_CONFLICT:{status:409,error:"conflict",reason:"Document update conflict"},INVALID_ID:{status:400,error:"invalid_id",reason:"_id field must contain a string"},MISSING_ID:{status:412,error:"missing_id",reason:"_id is required for puts"},RESERVED_ID:{status:400,error:"bad_request",reason:"Only reserved document ids may start with underscore."},NOT_OPEN:{status:412,error:"precondition_failed",reason:"Database not open so cannot close"},UNKNOWN_ERROR:{status:500,error:"unknown_error",reason:"Database encountered an unknown error"},BAD_ARG:{status:500,error:"badarg",reason:"Some query argument is invalid"},INVALID_REQUEST:{status:400,error:"invalid_request",reason:"Request was invalid"},QUERY_PARSE_ERROR:{status:400,error:"query_parse_error",reason:"Some query parameter is invalid"},DOC_VALIDATION:{status:500,error:"doc_validation",reason:"Bad special document member"},BAD_REQUEST:{status:400,error:"bad_request",reason:"Something wrong with the request"},NOT_AN_OBJECT:{status:400,error:"bad_request",reason:"Document must be a JSON object"}},Pouch.error=function(e,t){return PouchUtils.extend({},e,{reason:t})},"undefined"!=typeof module&&module.exports){global.Pouch=Pouch,global.PouchDB=Pouch,module.exports=Pouch,Pouch.replicate=require("./pouch.replicate.js").replicate;var PouchAdapter=require("./pouch.adapter.js");require("./adapters/pouch.http.js"),require("./adapters/pouch.idb.js"),require("./adapters/pouch.websql.js"),require("./adapters/pouch.leveldb.js"),require("./plugins/pouchdb.mapreduce.js")}else window.Pouch=Pouch,window.PouchDB=Pouch;var pouchCollate=function(e,t){var n=collationIndex(e),o=collationIndex(t);return 0!==n-o?n-o:null===e?0:"number"==typeof e?e-t:"boolean"==typeof e?t>e?-1:1:"string"==typeof e?stringCollate(e,t):Array.isArray(e)?arrayCollate(e,t):"object"==typeof e?objectCollate(e,t):void 0},stringCollate=function(e,t){return e===t?0:e>t?1:-1},objectCollate=function(e,t){for(var n=Object.keys(e),o=Object.keys(t),r=Math.min(n.length,o.length),i=0;r>i;i++){var u=pouchCollate(n[i],o[i]);if(0!==u)return u;if(u=pouchCollate(e[n[i]],t[o[i]]),0!==u)return u}return n.length===o.length?0:n.length>o.length?1:-1},arrayCollate=function(e,t){for(var n=Math.min(e.length,t.length),o=0;n>o;o++){var r=pouchCollate(e[o],t[o]);if(0!==r)return r}return e.length===t.length?0:e.length>t.length?1:-1},collationIndex=function(e){var t=["boolean","number","string","object"];return-1!==t.indexOf(typeof e)?null===e?1:t.indexOf(typeof e)+2:Array.isArray(e)?4.5:void 0};"undefined"!=typeof module&&module.exports&&(module.exports=pouchCollate);var extend;"undefined"!=typeof module&&module.exports&&(extend=require("./deps/extend"));var PouchMerge={};PouchMerge.merge=function(e,t,n){e=extend(!0,[],e),t=extend(!0,{},t);var o=doMerge(e,t);return{tree:stem(o.tree,n),conflicts:o.conflicts}},PouchMerge.winningRev=function(e){var t=[];return PouchMerge.traverseRevTree(e.rev_tree,function(e,n,o,r,i){e&&t.push({pos:n,id:o,deleted:!!i.deleted})}),t.sort(function(e,t){return e.deleted!==t.deleted?e.deleted>t.deleted?1:-1:e.pos!==t.pos?t.pos-e.pos:e.id<t.id?1:-1}),t[0].pos+"-"+t[0].id},PouchMerge.traverseRevTree=function(e,t){var n=[];for(e.forEach(function(e){n.push({pos:e.pos,ids:e.ids})});n.length>0;){var o=n.pop(),r=o.pos,i=o.ids,u=t(0===i[2].length,r,i[0],o.ctx,i[1]);i[2].forEach(function(e){n.push({pos:r+1,ids:e,ctx:u})})}},PouchMerge.collectLeaves=function(e){var t=[];return PouchMerge.traverseRevTree(e,function(e,n,o,r,i){e&&t.unshift({rev:n+"-"+o,pos:n,opts:i})}),t.sort(function(e,t){return t.pos-e.pos}),t.map(function(e){delete e.pos}),t},PouchMerge.collectConflicts=function(e){var t=PouchMerge.winningRev(e),n=PouchMerge.collectLeaves(e.rev_tree),o=[];return n.forEach(function(e){e.rev===t||e.opts.deleted||o.push(e.rev)}),o},PouchMerge.rootToLeaf=function(e){var t=[];return PouchMerge.traverseRevTree(e,function(e,n,o,r,i){if(r=r?r.slice(0):[],r.push({id:o,opts:i}),e){var u=n+1-r.length;t.unshift({pos:u,ids:r})}return r}),t},"undefined"!=typeof module&&module.exports&&(module.exports=PouchMerge);var PouchUtils;"undefined"!=typeof module&&module.exports&&(module.exports=Pouch,PouchUtils=require("./pouch.utils.js"));var Promise=function(){this.cancelled=!1,this.cancel=function(){this.cancelled=!0}},RequestManager=function(){var e=[],t={},n=!1;return t.enqueue=function(o,r){e.push({fun:o,args:r}),n||t.process()},t.process=function(){if(!n&&e.length){n=!0;var t=e.shift();t.fun.apply(null,t.args)}},t.notifyRequestComplete=function(){n=!1,t.process()},t},genReplicationId=function(e,t,n){var o=n.filter?""+n.filter:"";return"_local/"+PouchUtils.Crypto.MD5(e.id()+t.id()+o)},fetchCheckpoint=function(e,t,n,o){t.get(n,function(t,r){t&&404===t.status?o(null,0):e.get(n,function(e,t){e&&404===e.status||r.last_seq!==t.last_seq?o(null,0):o(null,t.last_seq)})})},writeCheckpoint=function(e,t,n,o,r){var i={_id:n,last_seq:o};t.put(i,function(){e.put(i,function(){r()})})};Pouch.replicate=function(e,t,n,o){n instanceof Function&&(o=n,n={}),void 0===n&&(n={}),n.complete||(n.complete=o);var r=new Promise;return toPouch(e,function(e,i){return e?PouchUtils.call(o,e):(toPouch(t,function(e,t){return e?PouchUtils.call(o,e):(replicate(i,t,n,r),void 0)}),void 0)}),r};var PouchUtils={};"undefined"!=typeof module&&module.exports?(PouchMerge=require("./pouch.merge.js"),PouchUtils.extend=require("./deps/extend"),PouchUtils.ajax=require("./deps/ajax"),PouchUtils.uuid=require("./deps/uuid"),PouchUtils.Crypto=require("./deps/md5.js")):(PouchUtils.Crypto=Crypto,PouchUtils.extend=extend,PouchUtils.ajax=ajax,PouchUtils.uuid=uuid);var reservedWords=["_id","_rev","_attachments","_deleted","_revisions","_revs_info","_conflicts","_deleted_conflicts","_local_seq","_rev_tree"],isValidId=function(e){return/^_/.test(e)?/^_(design|local)/.test(e):!0},isChromeApp=function(){return"undefined"!=typeof chrome&&chrome.storage!==void 0&&chrome.storage.local!==void 0};PouchUtils.call=function(e){if(typeof e==typeof Function){var t=Array.prototype.slice.call(arguments,1);e.apply(this,t)}},PouchUtils.isLocalId=function(e){return/^_local/.test(e)},PouchUtils.isDeleted=function(e,t){t||(t=PouchMerge.winningRev(e)),t.indexOf("-")>=0&&(t=t.split("-")[1]);var n=!1;return PouchMerge.traverseRevTree(e.rev_tree,function(e,o,r,i,u){r===t&&(n=!!u.deleted)}),n},PouchUtils.filterChange=function(e){return function(t){var n={},o=e.filter&&"function"==typeof e.filter;if(n.query=e.query_params,e.filter&&o&&!e.filter.call(this,t.doc,n))return!1;if(e.doc_ids&&-1===e.doc_ids.indexOf(t.id))return!1;if(e.include_docs)for(var r in t.doc._attachments)t.doc._attachments[r].stub=!0;else delete t.doc;return!0}},PouchUtils.processChanges=function(e,t,n){t=t.filter(PouchUtils.filterChange(e)),e.limit&&e.limit<t.length&&(t.length=e.limit),t.forEach(function(t){PouchUtils.call(e.onChange,t)}),PouchUtils.call(e.complete,null,{results:t,last_seq:n})},PouchUtils.parseDoc=function(e,t){var n,o,r,i=null,u={status:"available"};if(e._deleted&&(u.deleted=!0),t)if(e._id||(e._id=Pouch.uuid()),o=Pouch.uuid({length:32,radix:16}).toLowerCase(),e._rev){if(r=/^(\d+)-(.+)$/.exec(e._rev),!r)throw"invalid value for property '_rev'";e._rev_tree=[{pos:parseInt(r[1],10),ids:[r[2],{status:"missing"},[[o,u,[]]]]}],n=parseInt(r[1],10)+1}else e._rev_tree=[{pos:1,ids:[o,u,[]]}],n=1;else if(e._revisions&&(e._rev_tree=[{pos:e._revisions.start-e._revisions.ids.length+1,ids:e._revisions.ids.reduce(function(e,t){return null===e?[t,u,[]]:[t,{status:"missing"},[e]]},null)}],n=e._revisions.start,o=e._revisions.ids[0]),!e._rev_tree){if(r=/^(\d+)-(.+)$/.exec(e._rev),!r)return Pouch.Errors.BAD_ARG;n=parseInt(r[1],10),o=r[2],e._rev_tree=[{pos:parseInt(r[1],10),ids:[r[2],u,[]]}]}"string"!=typeof e._id?i=Pouch.Errors.INVALID_ID:isValidId(e._id)||(i=Pouch.Errors.RESERVED_ID);for(var a in e)e.hasOwnProperty(a)&&"_"===a[0]&&-1===reservedWords.indexOf(a)&&(i=PouchUtils.extend({},Pouch.Errors.DOC_VALIDATION),i.reason+=": "+a);return e._id=decodeURIComponent(e._id),e._rev=[n,o].join("-"),i?i:Object.keys(e).reduce(function(t,n){return/^_/.test(n)&&"_attachments"!==n?t.metadata[n.slice(1)]=e[n]:t.data[n]=e[n],t},{metadata:{},data:{}})},PouchUtils.isCordova=function(){return"undefined"!=typeof cordova||"undefined"!=typeof PhoneGap||"undefined"!=typeof phonegap},PouchUtils.Changes=function(){var e={},t={};return isChromeApp()?chrome.storage.onChanged.addListener(function(t){null!=t.db_name&&e.notify(t.db_name.newValue)}):"undefined"!=typeof window&&window.addEventListener("storage",function(t){e.notify(t.key)}),e.addListener=function(e,n,o,r){t[e]||(t[e]={}),t[e][n]={db:o,opts:r}},e.removeListener=function(e,n){delete t[e][n]},e.clearListeners=function(e){delete t[e]},e.notifyLocalWindows=function(e){isChromeApp()?chrome.storage.local.set({db_name:e}):localStorage[e]="a"===localStorage[e]?"b":"a"},e.notify=function(e){t[e]&&Object.keys(t[e]).forEach(function(n){var o=t[e][n].opts;t[e][n].db.changes({include_docs:o.include_docs,conflicts:o.conflicts,continuous:!1,descending:!1,filter:o.filter,since:o.since,query_params:o.query_params,onChange:function(e){e.seq>o.since&&!o.cancelled&&(o.since=e.seq,PouchUtils.call(o.onChange,e))}})})},e},PouchUtils.atob="undefined"!=typeof window&&"atob"in window?atob.bind(null):function(e){var t=new Buffer(e,"base64");if(t.toString("base64")!==e)throw"Cannot base64 encode full string";return t.toString("binary")},PouchUtils.btoa="undefined"!=typeof window&&"btoa"in window?btoa.bind(null):function(e){return new Buffer(e,"binary").toString("base64")},"undefined"!=typeof module&&module.exports&&(module.exports=PouchUtils);var PouchAdapter,PouchUtils;"undefined"!=typeof module&&module.exports&&(PouchUtils=require("./pouch.utils.js"));var call=PouchUtils.call;PouchAdapter=function(e,t){var n={},o=Pouch.adapters[e.adapter](e,function(o,r){if(o)return t&&t(o),void 0;for(var i in n)r.hasOwnProperty(i)||(r[i]=n[i]);e.name===Pouch.prefix+Pouch.ALL_DBS?t(o,r):Pouch.open(e,function(e){t(e,r)})}),r=e.auto_compaction===!0,i=function(e){return r?function(t,n){if(t)call(e,t);else{var o=n.length,r=function(){o--,o||call(e,null,n)};n.forEach(function(e){e.ok?u(e.id,1,r):r()})}}:e};n.post=function(e,t,n){return"function"==typeof t&&(n=t,t={}),"object"!=typeof e||Array.isArray(e)?call(n,Pouch.Errors.NOT_AN_OBJECT):o.bulkDocs({docs:[e]},t,i(yankError(n)))},n.put=function(e,t,n){return"function"==typeof t&&(n=t,t={}),"object"!=typeof e?call(n,Pouch.Errors.NOT_AN_OBJECT):"_id"in e?o.bulkDocs({docs:[e]},t,i(yankError(n))):call(n,Pouch.Errors.MISSING_ID)},n.putAttachment=function(e,t,o,r,i,u){function a(e){e._attachments=e._attachments||{},e._attachments[t]={content_type:i,data:r},n.put(e,u)}return n.taskqueue.ready()?("function"==typeof i&&(u=i,i=r,r=o,o=null),i===void 0&&(i=r,r=o,o=null),n.get(e,function(t,n){return t&&t.error===Pouch.Errors.MISSING_DOC.error?(a({_id:e}),void 0):t?(call(u,t),void 0):n._rev!==o?(call(u,Pouch.Errors.REV_CONFLICT),void 0):(a(n),void 0)}),void 0):(n.taskqueue.addTask("putAttachment",arguments),void 0)},n.removeAttachment=function(e,t,o,r){n.get(e,function(e,i){return e?(call(r,e),void 0):i._rev!==o?(call(r,Pouch.Errors.REV_CONFLICT),void 0):i._attachments?(delete i._attachments[t],0===Object.keys(i._attachments).length&&delete i._attachments,n.put(i,r),void 0):call(r,null)})},n.remove=function(e,t,n){"function"==typeof t&&(n=t,t={}),void 0===t&&(t={}),t.was_delete=!0;var r={_id:e._id,_rev:e._rev};return r._deleted=!0,o.bulkDocs({docs:[r]},t,yankError(n))},n.revsDiff=function(e,t,n){function r(e,t){s[e]||(s[e]={missing:[]}),s[e].missing.push(t)}function i(t,n){var o=e[t].slice(0);PouchMerge.traverseRevTree(n,function(e,n,i,u,a){var s=n+"-"+i,c=o.indexOf(s);-1!==c&&(o.splice(c,1),"available"!==a.status&&r(t,s))}),o.forEach(function(e){r(t,e)})}"function"==typeof t&&(n=t,t={});var u=Object.keys(e),a=0,s={};u.map(function(t){o._getRevisionTree(t,function(o,r){if(o&&"not_found"===o.error&&"missing"===o.reason)s[t]={missing:e[t]};else{if(o)return call(n,o);i(t,r)}return++a===u.length?call(n,null,s):void 0})})};var u=function(e,t,n){o._getRevisionTree(e,function(r,i){if(r)return call(n);var u=computeHeight(i),a=[],s=[];Object.keys(u).forEach(function(e){u[e]>t&&a.push(e)}),PouchMerge.traverseRevTree(i,function(e,t,n,o,r){var i=t+"-"+n;"available"===r.status&&-1!==a.indexOf(i)&&(r.status="missing",s.push(i))}),o._doCompaction(e,i,s,n)})};n.compact=function(e,t){"function"==typeof e&&(t=e,e={}),n.changes({complete:function(e,n){if(e)return call(t),void 0;var o=n.results.length;return o?(n.results.forEach(function(e){u(e.id,0,function(){o--,o||call(t)})}),void 0):(call(t),void 0)}})},n.get=function(e,t,r){function i(){var o=[],i=u.length;return i?(u.forEach(function(u){n.get(e,{rev:u,revs:t.revs},function(e,t){e?o.push({missing:u}):o.push({ok:t}),i--,i||call(r,null,o)})}),void 0):call(r,null,o)}if(!n.taskqueue.ready())return n.taskqueue.addTask("get",arguments),void 0;"function"==typeof t&&(r=t,t={});var u=[];{if(!t.open_revs)return o._get(e,t,function(e,n){if(e)return call(r,e);var i=n.doc,u=n.metadata,a=n.ctx;if(t.conflicts){var s=PouchMerge.collectConflicts(u);s.length&&(i._conflicts=s)}if(t.revs||t.revs_info){var c=PouchMerge.rootToLeaf(u.rev_tree),l=arrayFirst(c,function(e){return-1!==e.ids.map(function(e){return e.id}).indexOf(i._rev.split("-")[1])});if(l.ids.splice(l.ids.map(function(e){return e.id}).indexOf(i._rev.split("-")[1])+1),l.ids.reverse(),t.revs&&(i._revisions={start:l.pos+l.ids.length-1,ids:l.ids.map(function(e){return e.id})}),t.revs_info){var d=l.pos+l.ids.length;i._revs_info=l.ids.map(function(e){return d--,{rev:d+"-"+e.id,status:e.opts.status}})}}if(t.local_seq&&(i._local_seq=n.metadata.seq),t.attachments&&i._attachments){var f=i._attachments,p=Object.keys(f).length;if(0===p)return call(r,null,i);Object.keys(f).forEach(function(e){o._getAttachment(f[e],{encode:!0,ctx:a},function(t,n){i._attachments[e].data=n,--p||call(r,null,i)})})}else{if(i._attachments)for(var h in i._attachments)i._attachments[h].stub=!0;call(r,null,i)}});if("all"===t.open_revs)o._getRevisionTree(e,function(e,t){e&&(t=[]),u=PouchMerge.collectLeaves(t).map(function(e){return e.rev}),i()});else{if(!Array.isArray(t.open_revs))return call(r,Pouch.error(Pouch.Errors.UNKNOWN_ERROR,"function_clause"));u=t.open_revs;for(var a=0;u.length>a;a++){var s=u[a];if("string"!=typeof s||!/^\d+-/.test(s))return call(r,Pouch.error(Pouch.Errors.BAD_REQUEST,"Invalid rev format"))}i()}}},n.getAttachment=function(e,t,r,i){return n.taskqueue.ready()?(r instanceof Function&&(i=r,r={}),o._get(e,r,function(e,n){return e?call(i,e):n.doc._attachments&&n.doc._attachments[t]?(r.ctx=n.ctx,o._getAttachment(n.doc._attachments[t],r,i),void 0):call(i,Pouch.Errors.MISSING_DOC)
}),void 0):(n.taskqueue.addTask("getAttachment",arguments),void 0)},n.allDocs=function(e,t){if(!n.taskqueue.ready())return n.taskqueue.addTask("allDocs",arguments),void 0;if("function"==typeof e&&(t=e,e={}),"keys"in e){if("startkey"in e)return call(t,Pouch.error(Pouch.Errors.QUERY_PARSE_ERROR,"Query parameter `start_key` is not compatible with multi-get")),void 0;if("endkey"in e)return call(t,Pouch.error(Pouch.Errors.QUERY_PARSE_ERROR,"Query parameter `end_key` is not compatible with multi-get")),void 0}return e.skip===void 0&&(e.skip=0),o._allDocs(e,t)},n.changes=function(e){return n.taskqueue.ready()?(e=PouchUtils.extend(!0,{},e),e.since||(e.since=0),"latest"===e.since?(n.info(function(t,o){e.since=o.update_seq-1,n.changes(e)}),void 0):("descending"in e||(e.descending=!1),e.limit=0===e.limit?1:e.limit,o._changes(e))):(n.taskqueue.addTask("changes",arguments),void 0)},n.close=function(e){return n.taskqueue.ready()?o._close(e):(n.taskqueue.addTask("close",arguments),void 0)},n.info=function(e){return n.taskqueue.ready()?o._info(e):(n.taskqueue.addTask("info",arguments),void 0)},n.id=function(){return o._id()},n.type=function(){return"function"==typeof o._type?o._type():e.adapter},n.bulkDocs=function(e,t,r){if(!n.taskqueue.ready())return n.taskqueue.addTask("bulkDocs",arguments),void 0;if("function"==typeof t&&(r=t,t={}),t=t?PouchUtils.extend(!0,{},t):{},!e||!e.docs||1>e.docs.length)return call(r,Pouch.Errors.MISSING_BULK_DOCS);if(!Array.isArray(e.docs))return call(r,Pouch.Errors.QUERY_PARSE_ERROR);for(var u=0;e.docs.length>u;++u)if("object"!=typeof e.docs[u]||Array.isArray(e.docs[u]))return call(r,Pouch.Errors.NOT_AN_OBJECT);return e=PouchUtils.extend(!0,{},e),"new_edits"in t||(t.new_edits=!0),o._bulkDocs(e,t,i(r))};var a={};a.ready=!1,a.queue=[],n.taskqueue={},n.taskqueue.execute=function(e){a.ready&&a.queue.forEach(function(t){e[t.task].apply(null,t.parameters)})},n.taskqueue.ready=function(){return 0===arguments.length?a.ready:(a.ready=arguments[0],void 0)},n.taskqueue.addTask=function(e,t){a.queue.push({task:e,parameters:t})},n.replicate={},n.replicate.from=function(e,t,n){return"function"==typeof t&&(n=t,t={}),Pouch.replicate(e,o,t,n)},n.replicate.to=function(e,t,n){return"function"==typeof t&&(n=t,t={}),Pouch.replicate(o,e,t,n)};for(var s in n)o.hasOwnProperty(s)||(o[s]=n[s]);return e.skipSetup&&(n.taskqueue.ready(!0),n.taskqueue.execute(n)),PouchUtils.isCordova()&&cordova.fireWindowEvent(e.name+"_pouch",{}),o},"undefined"!=typeof module&&module.exports&&(module.exports=PouchAdapter);var PouchUtils;"undefined"!=typeof module&&module.exports&&(Pouch=require("../pouch.js"),PouchUtils=require("../pouch.utils.js"));var ajax=PouchUtils.ajax,HTTP_TIMEOUT=1e4;parseUri.options={strictMode:!1,key:["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"],q:{name:"queryKey",parser:/(?:^|&)([^&=]*)=?([^&]*)/g},parser:{strict:/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,loose:/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/}};var HttpPouch=function(e,t){var n=getHost(e.name,e),o=genDBUrl(n,""),r={},i={list:[],get:function(e,t){"function"==typeof e&&(t=e,e={count:10});var o=function(e,n){!e&&"uuids"in n?(i.list=i.list.concat(n.uuids),PouchUtils.call(t,null,"OK")):PouchUtils.call(t,e||Pouch.Errors.UNKNOWN_ERROR)},r="?count="+e.count;ajax({headers:n.headers,method:"GET",url:genUrl(n,"_uuids")+r},o)}},u=function(){ajax({headers:n.headers,method:"PUT",url:o},function(e){e&&401===e.status?ajax({headers:n.headers,method:"HEAD",url:o},function(e){e?PouchUtils.call(t,e):PouchUtils.call(t,null,r)}):e&&412!==e.status?PouchUtils.call(t,Pouch.Errors.UNKNOWN_ERROR):PouchUtils.call(t,null,r)})};return e.skipSetup||ajax({headers:n.headers,method:"GET",url:o},function(e){e?404===e.status?u():PouchUtils.call(t,e):PouchUtils.call(t,null,r)}),r.type=function(){return"http"},r.id=function(){return genDBUrl(n,"")},r.request=function(e,t){return r.taskqueue.ready()?(e.headers=n.headers,e.url=genDBUrl(n,e.url),ajax(e,t),void 0):(r.taskqueue.addTask("request",arguments),void 0)},r.compact=function(e,t){return r.taskqueue.ready()?("function"==typeof e&&(t=e,e={}),ajax({headers:n.headers,url:genDBUrl(n,"_compact"),method:"POST"},function(){function n(){r.info(function(o,r){r.compact_running?setTimeout(n,e.interval||200):PouchUtils.call(t,null)})}"function"==typeof t&&n()}),void 0):(r.taskqueue.addTask("compact",arguments),void 0)},r.info=function(e){return r.taskqueue.ready()?(ajax({headers:n.headers,method:"GET",url:genDBUrl(n,"")},e),void 0):(r.taskqueue.addTask("info",arguments),void 0)},r.get=function(e,t,o){if(!r.taskqueue.ready())return r.taskqueue.addTask("get",arguments),void 0;"function"==typeof t&&(o=t,t={}),void 0===t.auto_encode&&(t.auto_encode=!0);var i=[];t.revs&&i.push("revs=true"),t.revs_info&&i.push("revs_info=true"),t.local_seq&&i.push("local_seq=true"),t.open_revs&&("all"!==t.open_revs&&(t.open_revs=JSON.stringify(t.open_revs)),i.push("open_revs="+t.open_revs)),t.attachments&&i.push("attachments=true"),t.rev&&i.push("rev="+t.rev),t.conflicts&&i.push("conflicts="+t.conflicts),i=i.join("&"),i=""===i?"":"?"+i,t.auto_encode&&(e=encodeDocId(e));var u={headers:n.headers,method:"GET",url:genDBUrl(n,e+i)},a=e.split("/");(a.length>1&&"_design"!==a[0]&&"_local"!==a[0]||a.length>2&&"_design"===a[0]&&"_local"!==a[0])&&(u.binary=!0),ajax(u,function(e,t,n){return e?PouchUtils.call(o,e):(PouchUtils.call(o,null,t,n),void 0)})},r.remove=function(e,t,o){return r.taskqueue.ready()?("function"==typeof t&&(o=t,t={}),ajax({headers:n.headers,method:"DELETE",url:genDBUrl(n,encodeDocId(e._id))+"?rev="+e._rev},o),void 0):(r.taskqueue.addTask("remove",arguments),void 0)},r.getAttachment=function(e,t,n,o){"function"==typeof n&&(o=n,n={}),void 0===n.auto_encode&&(n.auto_encode=!0),n.auto_encode&&(e=encodeDocId(e)),n.auto_encode=!1,r.get(e+"/"+t,n,o)},r.removeAttachment=function(e,t,o,i){return r.taskqueue.ready()?(ajax({headers:n.headers,method:"DELETE",url:genDBUrl(n,encodeDocId(e)+"/"+t)+"?rev="+o},i),void 0):(r.taskqueue.addTask("removeAttachment",arguments),void 0)},r.putAttachment=function(e,t,o,i,u,a){if(!r.taskqueue.ready())return r.taskqueue.addTask("putAttachment",arguments),void 0;"function"==typeof u&&(a=u,u=i,i=o,o=null),u===void 0&&(u=i,i=o,o=null);var s=encodeDocId(e)+"/"+t,c=genDBUrl(n,s);o&&(c+="?rev="+o);var l={headers:n.headers,method:"PUT",url:c,processData:!1,body:i,timeout:6e4};l.headers["Content-Type"]=u,ajax(l,a)},r.put=function(e,t,o){if(!r.taskqueue.ready())return r.taskqueue.addTask("put",arguments),void 0;if("function"==typeof t&&(o=t,t={}),"object"!=typeof e)return PouchUtils.call(o,Pouch.Errors.NOT_AN_OBJECT);if(!("_id"in e))return PouchUtils.call(o,Pouch.Errors.MISSING_ID);var i=[];t&&t.new_edits!==void 0&&i.push("new_edits="+t.new_edits),i=i.join("&"),""!==i&&(i="?"+i),ajax({headers:n.headers,method:"PUT",url:genDBUrl(n,encodeDocId(e._id))+i,body:e},o)},r.post=function(e,t,n){return r.taskqueue.ready()?("function"==typeof t&&(n=t,t={}),"object"!=typeof e?PouchUtils.call(n,Pouch.Errors.NOT_AN_OBJECT):("_id"in e?r.put(e,t,n):i.list.length>0?(e._id=i.list.pop(),r.put(e,t,n)):i.get(function(o){return o?PouchUtils.call(n,Pouch.Errors.UNKNOWN_ERROR):(e._id=i.list.pop(),r.put(e,t,n),void 0)}),void 0)):(r.taskqueue.addTask("post",arguments),void 0)},r.bulkDocs=function(e,t,o){return r.taskqueue.ready()?("function"==typeof t&&(o=t,t={}),t||(t={}),t.new_edits!==void 0&&(e.new_edits=t.new_edits),ajax({headers:n.headers,method:"POST",url:genDBUrl(n,"_bulk_docs"),body:e},o),void 0):(r.taskqueue.addTask("bulkDocs",arguments),void 0)},r.allDocs=function(e,t){if(!r.taskqueue.ready())return r.taskqueue.addTask("allDocs",arguments),void 0;"function"==typeof e&&(t=e,e={});var o,i=[],u="GET";e.conflicts&&i.push("conflicts=true"),e.descending&&i.push("descending=true"),e.include_docs&&i.push("include_docs=true"),e.startkey&&i.push("startkey="+encodeURIComponent(JSON.stringify(e.startkey))),e.endkey&&i.push("endkey="+encodeURIComponent(JSON.stringify(e.endkey))),e.limit&&i.push("limit="+e.limit),e.skip!==void 0&&i.push("skip="+e.skip),i=i.join("&"),""!==i&&(i="?"+i),e.keys!==void 0&&(u="POST",o=JSON.stringify({keys:e.keys})),ajax({headers:n.headers,method:u,url:genDBUrl(n,"_all_docs"+i),body:o},t)},r.changes=function(e){var t=25;if(!r.taskqueue.ready())return r.taskqueue.addTask("changes",arguments),void 0;if("latest"===e.since)return r.info(function(t,n){e.since=n.update_seq-1,r.changes(e)}),void 0;Pouch.DEBUG&&console.log(o+": Start Changes Feed: continuous="+e.continuous);var i={},u=e.limit!==void 0?e.limit:!1;0===u&&(u=1);var a=u;if(e.style&&(i.style=e.style),(e.include_docs||e.filter&&"function"==typeof e.filter)&&(i.include_docs=!0),e.continuous&&(i.feed="longpoll"),e.conflicts&&(i.conflicts=!0),e.descending&&(i.descending=!0),e.filter&&"string"==typeof e.filter&&(i.filter=e.filter),e.query_params&&"object"==typeof e.query_params)for(var s in e.query_params)e.query_params.hasOwnProperty(s)&&(i[s]=e.query_params[s]);var c,l,d,f=function(o,r){i.since=o,i.limit=!u||a>t?t:a;var s="?"+Object.keys(i).map(function(e){return e+"="+i[e]}).join("&"),d={headers:n.headers,method:"GET",url:genDBUrl(n,"_changes"+s),timeout:null};l=o,e.aborted||(c=ajax(d,r))},p=10,h=0,v={results:[]},_=function(t,n){if(n&&n.results){v.last_seq=n.last_seq;var o={};o.query=e.query_params,n.results=n.results.filter(function(t){a--;var n=PouchUtils.filterChange(e)(t);return n&&(v.results.push(t),PouchUtils.call(e.onChange,t)),n})}n&&n.last_seq&&(l=n.last_seq);var r=n&&n.results.length||0,i=u&&0>=a||n&&!r||r&&n.last_seq===d||e.descending&&0!==l;if(e.continuous||!i){t?h+=1:h=0;var s=1<<h,c=p*s,m=e.maximumWait||3e4;c>m&&PouchUtils.call(e.complete,t||Pouch.Errors.UNKNOWN_ERROR,null),setTimeout(function(){f(l,_)},c)}else PouchUtils.call(e.complete,null,v)};return e.continuous?f(e.since||0,_):r.info(function(t,n){return t?PouchUtils.call(e.complete,t):(d=n.update_seq,f(e.since||0,_),void 0)}),{cancel:function(){Pouch.DEBUG&&console.log(o+": Cancel Changes Feed"),e.aborted=!0,c.abort()}}},r.revsDiff=function(e,t,o){return r.taskqueue.ready()?("function"==typeof t&&(o=t,t={}),ajax({headers:n.headers,method:"POST",url:genDBUrl(n,"_revs_diff"),body:e},function(e,t){PouchUtils.call(o,e,t)}),void 0):(r.taskqueue.addTask("revsDiff",arguments),void 0)},r.close=function(e){return r.taskqueue.ready()?(PouchUtils.call(e,null),void 0):(r.taskqueue.addTask("close",arguments),void 0)},r};HttpPouch.destroy=function(e,t,n){var o=getHost(e,t);ajax({headers:o.headers,method:"DELETE",url:genDBUrl(o,"")},n)},HttpPouch.valid=function(){return!0},Pouch.adapter("http",HttpPouch),Pouch.adapter("https",HttpPouch);var PouchUtils;"undefined"!=typeof module&&module.exports&&(PouchUtils=require("../pouch.utils.js"));var idbError=function(e){return function(t){PouchUtils.call(e,{status:500,error:t.type,reason:t.target})}},IdbPouch=function(opts,callback){function createSchema(e){e.createObjectStore(DOC_STORE,{keyPath:"id"}).createIndex("seq","seq",{unique:!0}),e.createObjectStore(BY_SEQ_STORE,{autoIncrement:!0}).createIndex("_doc_id_rev","_doc_id_rev",{unique:!0}),e.createObjectStore(ATTACH_STORE,{keyPath:"digest"}),e.createObjectStore(META_STORE,{keyPath:"id",autoIncrement:!1}),e.createObjectStore(DETECT_BLOB_SUPPORT_STORE)}function fixBinary(e){for(var t=e.length,n=new ArrayBuffer(t),o=new Uint8Array(n),r=0;t>r;r++)o[r]=e.charCodeAt(r);return n}function sortByBulkSeq(e,t){return e._bulk_seq-t._bulk_seq}var POUCH_VERSION=1,DOC_STORE="document-store",BY_SEQ_STORE="by-sequence",ATTACH_STORE="attach-store",META_STORE="meta-store",DETECT_BLOB_SUPPORT_STORE="detect-blob-support",name=opts.name,req=window.indexedDB.open(name,POUCH_VERSION);Pouch.openReqList&&(Pouch.openReqList[name]=req);var blobSupport=null,instanceId=null,api={},idb=null;return Pouch.DEBUG&&console.log(name+": Open Database"),req.onupgradeneeded=function(e){for(var t=e.target.result,n=e.oldVersion;n!==e.newVersion;)0===n&&createSchema(t),n++},req.onsuccess=function(e){idb=e.target.result;var t=idb.transaction([META_STORE,DETECT_BLOB_SUPPORT_STORE],"readwrite");if(idb.onversionchange=function(){idb.close()},idb.setVersion&&Number(idb.version)!==POUCH_VERSION){var n=idb.setVersion(POUCH_VERSION);return n.onsuccess=function(t){function n(){o.onsuccess(e)}t.target.result.oncomplete=n,o.onupgradeneeded(e)},void 0}var o=t.objectStore(META_STORE).get(META_STORE);o.onsuccess=function(e){var n=e.target.result||{id:META_STORE};name+"_id"in n?instanceId=n[name+"_id"]:(instanceId=Pouch.uuid(),n[name+"_id"]=instanceId,t.objectStore(META_STORE).put(n));try{t.objectStore(DETECT_BLOB_SUPPORT_STORE).put(new Blob,"key"),blobSupport=!0}catch(o){blobSupport=!1}finally{PouchUtils.call(callback,null,api)}}},req.onerror=idbError(callback),api.type=function(){return"idb"},api.id=function idb_id(){return instanceId},api._bulkDocs=function idb_bulkDocs(e,t,n){function o(e){var t=e.target.result;t.updateSeq=(t.updateSeq||0)+y,m.objectStore(META_STORE).put(t)}function r(){if(!v.length)return m.objectStore(META_STORE).get(META_STORE).onsuccess=o,void 0;var e=v.shift(),t=m.objectStore(DOC_STORE).get(e.metadata.id);t.onsuccess=function(t){var n=t.target.result;n?c(n,e):l(e)}}function i(){var e=[];g.sort(sortByBulkSeq),g.forEach(function(t){if(delete t._bulk_seq,t.error)return e.push(t),void 0;var n=t.metadata,o=PouchMerge.winningRev(n);e.push({ok:!0,id:n.id,rev:o}),PouchUtils.isLocalId(n.id)||(IdbPouch.Changes.notify(name),IdbPouch.Changes.notifyLocalWindows(name))}),PouchUtils.call(n,null,e)}function u(e,t){if(e.stub)return t();if("string"==typeof e.data){var o;try{o=atob(e.data)}catch(r){var i=Pouch.error(Pouch.Errors.BAD_ARG,"Attachments need to be base64 encoded");return PouchUtils.call(n,i)}if(e.digest="md5-"+PouchUtils.Crypto.MD5(o),blobSupport){var u=e.content_type;o=fixBinary(o),e.data=new Blob([o],{type:u})}return t()}var a=new FileReader;a.onloadend=function(){e.digest="md5-"+PouchUtils.Crypto.MD5(this.result),blobSupport||(e.data=btoa(this.result)),t()},a.readAsBinaryString(e.data)}function a(e){function t(){n++,v.length===n&&e()}if(!v.length)return e();var n=0;v.forEach(function(e){function n(){r++,r===o.length&&t()}var o=e.data&&e.data._attachments?Object.keys(e.data._attachments):[];if(!o.length)return t();var r=0;for(var i in e.data._attachments)u(e.data._attachments[i],n)})}function s(e,t){function n(e){i||(e?(i=e,PouchUtils.call(t,i)):u===a.length&&r())}function o(e){u++,n(e)}function r(){e.data._doc_id_rev=e.data._id+"::"+e.data._rev;var n=m.objectStore(BY_SEQ_STORE).put(e.data);n.onsuccess=function(n){Pouch.DEBUG&&console.log(name+": Wrote Document ",e.metadata.id),e.metadata.seq=n.target.result,delete e.metadata.rev;var o=m.objectStore(DOC_STORE).put(e.metadata);o.onsuccess=function(){g.push(e),PouchUtils.call(t)}}}var i=null,u=0;e.data._id=e.metadata.id,e.data._rev=e.metadata.rev,y++,PouchUtils.isDeleted(e.metadata,e.metadata.rev)&&(e.data._deleted=!0);var a=e.data._attachments?Object.keys(e.data._attachments):[];for(var s in e.data._attachments)if(e.data._attachments[s].stub)u++,n();else{var c=e.data._attachments[s].data;delete e.data._attachments[s].data;var l=e.data._attachments[s].digest;f(e,l,c,o)}a.length||r()}function c(e,t){var n=PouchMerge.merge(e.rev_tree,t.metadata.rev_tree[0],1e3),o=PouchUtils.isDeleted(e),i=o&&PouchUtils.isDeleted(t.metadata)||!o&&p&&"new_leaf"!==n.conflicts;return i?(g.push(d(Pouch.Errors.REV_CONFLICT,t._bulk_seq)),r()):(t.metadata.rev_tree=n.tree,s(t,r),void 0)}function l(e){return"was_delete"in t&&PouchUtils.isDeleted(e.metadata)?(g.push(Pouch.Errors.MISSING_DOC),r()):(s(e,r),void 0)}function d(e,t){return e._bulk_seq=t,e}function f(e,t,n,o){var r=m.objectStore(ATTACH_STORE);r.get(t).onsuccess=function(i){var u=i.target.result&&i.target.result.refs||{},a=[e.metadata.id,e.metadata.rev].join("@"),s={digest:t,body:n,refs:u};s.refs[a]=!0,r.put(s).onsuccess=function(){PouchUtils.call(o)}}}var p=t.new_edits,h=e.docs,v=h.map(function(e,t){var n=PouchUtils.parseDoc(e,p);return n._bulk_seq=t,n}),_=v.filter(function(e){return e.error});if(_.length)return PouchUtils.call(n,_[0]);var m,g=[],y=0;a(function(){m=idb.transaction([DOC_STORE,BY_SEQ_STORE,ATTACH_STORE,META_STORE],"readwrite"),m.onerror=idbError(n),m.ontimeout=idbError(n),m.oncomplete=i,r()})},api._get=function idb_get(e,t,n){function o(){PouchUtils.call(n,u,{doc:r,metadata:i,ctx:a})}var r,i,u,a;a=t.ctx?t.ctx:idb.transaction([DOC_STORE,BY_SEQ_STORE,ATTACH_STORE],"readonly"),a.objectStore(DOC_STORE).get(e).onsuccess=function(e){if(i=e.target.result,!i)return u=Pouch.Errors.MISSING_DOC,o();if(PouchUtils.isDeleted(i)&&!t.rev)return u=Pouch.error(Pouch.Errors.MISSING_DOC,"deleted"),o();var n=PouchMerge.winningRev(i),s=i.id+"::"+(t.rev?t.rev:n),c=a.objectStore(BY_SEQ_STORE).index("_doc_id_rev");c.get(s).onsuccess=function(e){return r=e.target.result,r&&r._doc_id_rev&&delete r._doc_id_rev,r?(o(),void 0):(u=Pouch.Errors.MISSING_DOC,o())}}},api._getAttachment=function(e,t,n){var o,r;r=t.ctx?t.ctx:idb.transaction([DOC_STORE,BY_SEQ_STORE,ATTACH_STORE],"readonly");var i=e.digest,u=e.content_type;r.objectStore(ATTACH_STORE).get(i).onsuccess=function(e){var r=e.target.result.body;if(t.encode)if(blobSupport){var i=new FileReader;i.onloadend=function(){o=btoa(this.result),PouchUtils.call(n,null,o)},i.readAsBinaryString(r)}else o=r,PouchUtils.call(n,null,o);else blobSupport?o=r:(r=fixBinary(atob(r)),o=new Blob([r],{type:u})),PouchUtils.call(n,null,o)}},api._allDocs=function idb_allDocs(e,t){var n="startkey"in e?e.startkey:!1,o="endkey"in e?e.endkey:!1,r="descending"in e?e.descending:!1;r=r?"prev":null;var i=n&&o?window.IDBKeyRange.bound(n,o):n?window.IDBKeyRange.lowerBound(n):o?window.IDBKeyRange.upperBound(o):null,u=idb.transaction([DOC_STORE,BY_SEQ_STORE],"readonly");u.oncomplete=function(){"keys"in e&&(e.keys.forEach(function(e){e in l?c.push(l[e]):c.push({key:e,error:"not_found"})}),e.descending&&c.reverse()),PouchUtils.call(t,null,{total_rows:c.length,offset:e.skip,rows:"limit"in e?c.slice(e.skip,e.limit+e.skip):e.skip>0?c.slice(e.skip):c})};var a=u.objectStore(DOC_STORE),s=r?a.openCursor(i,r):a.openCursor(i),c=[],l={};s.onsuccess=function(t){function n(t,n){if(PouchUtils.isLocalId(t.id))return o["continue"]();var r={id:t.id,key:t.id,value:{rev:PouchMerge.winningRev(t)}};if(e.include_docs){r.doc=n,r.doc._rev=PouchMerge.winningRev(t),r.doc._doc_id_rev&&delete r.doc._doc_id_rev,e.conflicts&&(r.doc._conflicts=PouchMerge.collectConflicts(t));for(var i in r.doc._attachments)r.doc._attachments[i].stub=!0}"keys"in e?e.keys.indexOf(t.id)>-1&&(PouchUtils.isDeleted(t)&&(r.value.deleted=!0,r.doc=null),l[r.id]=r):PouchUtils.isDeleted(t)||c.push(r),o["continue"]()}if(t.target.result){var o=t.target.result,r=o.value;if(e.include_docs){var i=u.objectStore(BY_SEQ_STORE).index("_doc_id_rev"),a=PouchMerge.winningRev(r),s=r.id+"::"+a;i.get(s).onsuccess=function(e){n(o.value,e.target.result)}}else n(r)}}},api._info=function idb_info(e){function t(e){r=e.target.result&&e.target.result.updateSeq||0}function n(e){var n=e.target.result;return n?(n.value.deleted!==!0&&o++,n["continue"](),void 0):(i.objectStore(META_STORE).get(META_STORE).onsuccess=t,void 0)}var o=0,r=0,i=idb.transaction([DOC_STORE,META_STORE],"readonly");i.oncomplete=function(){e(null,{db_name:name,doc_count:o,update_seq:r})},i.objectStore(DOC_STORE).openCursor().onsuccess=n},api._changes=function idb_changes(opts){function fetchChanges(){txn=idb.transaction([DOC_STORE,BY_SEQ_STORE]),txn.oncomplete=onTxnComplete;var e;e=descending?txn.objectStore(BY_SEQ_STORE).openCursor(window.IDBKeyRange.lowerBound(opts.since,!0),descending):txn.objectStore(BY_SEQ_STORE).openCursor(window.IDBKeyRange.lowerBound(opts.since,!0)),e.onsuccess=onsuccess,e.onerror=onerror}function onsuccess(e){if(!e.target.result){for(var t=0,n=results.length;n>t;t++){var o=results[t];o&&dedupResults.push(o)}return!1}var r=e.target.result,i=r.value._id,u=resultIndices[i];if(void 0!==u)return results[u].seq=r.key,results.push(results[u]),results[u]=null,resultIndices[i]=results.length-1,r["continue"]();var a=txn.objectStore(DOC_STORE);a.get(r.value._id).onsuccess=function(e){var t=e.target.result;if(PouchUtils.isLocalId(t.id))return r["continue"]();t.seq>last_seq&&(last_seq=t.seq);var n=PouchMerge.winningRev(t),o=t.id+"::"+n,i=txn.objectStore(BY_SEQ_STORE).index("_doc_id_rev");i.get(o).onsuccess=function(e){var o=e.target.result;delete o._doc_id_rev;var i=[{rev:n}];"all_docs"===opts.style&&(i=PouchMerge.collectLeaves(t.rev_tree).map(function(e){return{rev:e.rev}}));var u={id:t.id,seq:r.key,changes:i,doc:o};PouchUtils.isDeleted(t,n)&&(u.deleted=!0),opts.conflicts&&(u.doc._conflicts=PouchMerge.collectConflicts(t));var a=u.id,s=resultIndices[a];void 0!==s&&(results[s]=null),results.push(u),resultIndices[a]=results.length-1,r["continue"]()}}}function onTxnComplete(){PouchUtils.processChanges(opts,dedupResults,last_seq)}function onerror(){PouchUtils.call(opts.complete)}if(Pouch.DEBUG&&console.log(name+": Start Changes Feed: continuous="+opts.continuous),opts.continuous){var id=name+":"+Pouch.uuid();return opts.cancelled=!1,IdbPouch.Changes.addListener(name,id,api,opts),IdbPouch.Changes.notify(name),{cancel:function(){Pouch.DEBUG&&console.log(name+": Cancel Changes Feed"),opts.cancelled=!0,IdbPouch.Changes.removeListener(name,id)}}}var descending=opts.descending?"prev":null,last_seq=0;opts.since=opts.since&&!descending?opts.since:0;var results=[],resultIndices={},dedupResults=[],txn;if(opts.filter&&"string"==typeof opts.filter){var filterName=opts.filter.split("/");api.get("_design/"+filterName[0],function(err,ddoc){var filter=eval("(function() { return "+ddoc.filters[filterName[1]]+" })()");opts.filter=filter,fetchChanges()})}else fetchChanges()},api._close=function(e){return null===idb?PouchUtils.call(e,Pouch.Errors.NOT_OPEN):(idb.close(),PouchUtils.call(e,null),void 0)},api._getRevisionTree=function(e,t){var n=idb.transaction([DOC_STORE],"readonly"),o=n.objectStore(DOC_STORE).get(e);o.onsuccess=function(e){var n=e.target.result;n?PouchUtils.call(t,null,n.rev_tree):PouchUtils.call(t,Pouch.Errors.MISSING_DOC)}},api._doCompaction=function(e,t,n,o){var r=idb.transaction([DOC_STORE,BY_SEQ_STORE],"readwrite"),i=r.objectStore(DOC_STORE);i.get(e).onsuccess=function(o){var i=o.target.result;i.rev_tree=t;var u=n.length;n.forEach(function(t){var n=r.objectStore(BY_SEQ_STORE).index("_doc_id_rev"),o=e+"::"+t;n.getKey(o).onsuccess=function(e){var t=e.target.result;t&&(r.objectStore(BY_SEQ_STORE)["delete"](t),u--,u||r.objectStore(DOC_STORE).put(i))}})},r.oncomplete=function(){PouchUtils.call(o)}},api};IdbPouch.valid=function idb_valid(){return"undefined"!=typeof window&&!!window.indexedDB},IdbPouch.destroy=function idb_destroy(e,t,n){Pouch.DEBUG&&console.log(e+": Delete Database"),IdbPouch.Changes.clearListeners(e),Pouch.openReqList[e]&&Pouch.openReqList[e].result&&Pouch.openReqList[e].result.close();var o=window.indexedDB.deleteDatabase(e);o.onsuccess=function(){Pouch.openReqList[e]&&(Pouch.openReqList[e]=null),PouchUtils.call(n,null)},o.onerror=idbError(n)},IdbPouch.Changes=new PouchUtils.Changes,Pouch.adapter("idb",IdbPouch);var PouchUtils;"undefined"!=typeof module&&module.exports&&(PouchUtils=require("../pouch.utils.js"));var POUCH_VERSION=1,POUCH_SIZE=5242880,DOC_STORE=quote("document-store"),BY_SEQ_STORE=quote("by-sequence"),ATTACH_STORE=quote("attach-store"),META_STORE=quote("metadata-store"),unknownError=function(e){return function(t){PouchUtils.call(e,{status:500,error:t.type,reason:t.target})}},webSqlPouch=function(opts,callback){function dbCreated(){callback(null,api)}function setup(){db.transaction(function(e){var t="CREATE TABLE IF NOT EXISTS "+META_STORE+" (update_seq, dbid)",n="CREATE TABLE IF NOT EXISTS "+ATTACH_STORE+" (digest, json, body BLOB)",o="CREATE TABLE IF NOT EXISTS "+DOC_STORE+" (id unique, seq, json, winningseq)",r="CREATE TABLE IF NOT EXISTS "+BY_SEQ_STORE+" (seq INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT, doc_id_rev UNIQUE, json)";e.executeSql(n),e.executeSql(o),e.executeSql(r),e.executeSql(t);var i="SELECT update_seq FROM "+META_STORE;e.executeSql(i,[],function(e,t){if(!t.rows.length){var n="INSERT INTO "+META_STORE+" (update_seq) VALUES (?)";return e.executeSql(n,[0]),void 0}});var u="SELECT dbid FROM "+META_STORE+" WHERE dbid IS NOT NULL";e.executeSql(u,[],function(e,t){if(!t.rows.length){var n="UPDATE "+META_STORE+" SET dbid=?";return instanceId=Pouch.uuid(),e.executeSql(n,[instanceId]),void 0}instanceId=t.rows.item(0).dbid})},unknownError(callback),dbCreated)}function makeRevs(e){return e.map(function(e){return{rev:e.rev}})}var api={},instanceId=null,name=opts.name,db=openDatabase(name,POUCH_VERSION,name,POUCH_SIZE);return db?(PouchUtils.isCordova()&&"undefined"!=typeof window?window.addEventListener(name+"_pouch",function cordova_init(){window.removeEventListener(name+"_pouch",cordova_init,!1),setup()},!1):setup(),api.type=function(){return"websql"},api.id=function(){return instanceId},api._info=function(e){db.transaction(function(t){var n="SELECT COUNT(id) AS count FROM "+DOC_STORE;t.executeSql(n,[],function(t,n){var o=n.rows.item(0).count,r="SELECT update_seq FROM "+META_STORE;t.executeSql(r,[],function(t,n){var r=n.rows.item(0).update_seq;e(null,{db_name:name,doc_count:o,update_seq:r})})})})},api._bulkDocs=function idb_bulkDocs(e,t,n){function o(e,t){return e._bulk_seq-t._bulk_seq}function r(){var e=[];E.sort(o),E.forEach(function(t){if(delete t._bulk_seq,t.error)return e.push(t),void 0;var n=t.metadata,o=PouchMerge.winningRev(n);e.push({ok:!0,id:n.id,rev:o}),PouchUtils.isLocalId(n.id)||(_++,webSqlPouch.Changes.notify(name),webSqlPouch.Changes.notifyLocalWindows(name))});var t="SELECT update_seq FROM "+META_STORE;y.executeSql(t,[],function(t,o){var r=o.rows.item(0).update_seq+_,i="UPDATE "+META_STORE+" SET update_seq=?";t.executeSql(i,[r],function(){PouchUtils.call(n,null,e)})})}function i(e,t){if(e.stub)return t();if("string"==typeof e.data){try{e.data=atob(e.data)}catch(o){var r=Pouch.error(Pouch.Errors.BAD_ARG,"Attachments need to be base64 encoded");return PouchUtils.call(n,r)}return e.digest="md5-"+PouchUtils.Crypto.MD5(e.data),t()}var i=new FileReader;i.onloadend=function(){e.data=this.result,e.digest="md5-"+PouchUtils.Crypto.MD5(this.result),t()},i.readAsBinaryString(e.data)}function u(e){function t(){n++,m.length===n&&e()}if(!m.length)return e();var n=0,o=0;m.forEach(function(e){function n(){o++,o===r.length&&t()}var r=e.data&&e.data._attachments?Object.keys(e.data._attachments):[];if(!r.length)return t();for(var u in e.data._attachments)i(e.data._attachments[u],n)})}function a(e,t,n){function o(){var t=e.data,n="INSERT INTO "+BY_SEQ_STORE+" (doc_id_rev, json) VALUES (?, ?);";y.executeSql(n,[t._id+"::"+t._rev,JSON.stringify(t)],u)}function r(e){a||(e?(a=e,PouchUtils.call(t,a)):s===c.length&&o())}function i(e){s++,r(e)}function u(o,r){var i=e.metadata.seq=r.insertId;delete e.metadata.rev;var u=PouchMerge.winningRev(e.metadata),a=n?"UPDATE "+DOC_STORE+" SET seq=?, json=?, winningseq=(SELECT seq FROM "+BY_SEQ_STORE+" WHERE doc_id_rev=?) WHERE id=?":"INSERT INTO "+DOC_STORE+" (id, seq, winningseq, json) VALUES (?, ?, ?, ?);",s=JSON.stringify(e.metadata),c=e.metadata.id+"::"+u,l=n?[i,s,c,e.metadata.id]:[e.metadata.id,i,i,s];o.executeSql(a,l,function(){E.push(e),PouchUtils.call(t,null)})}var a=null,s=0;e.data._id=e.metadata.id,e.data._rev=e.metadata.rev,PouchUtils.isDeleted(e.metadata,e.metadata.rev)&&(e.data._deleted=!0);var c=e.data._attachments?Object.keys(e.data._attachments):[];for(var l in e.data._attachments)if(e.data._attachments[l].stub)s++,r();else{var d=e.data._attachments[l].data;delete e.data._attachments[l].data;var p=e.data._attachments[l].digest;f(e,p,d,i)}c.length||o()}function s(e,t){var n=PouchMerge.merge(e.rev_tree,t.metadata.rev_tree[0],1e3),o=PouchUtils.isDeleted(e)&&PouchUtils.isDeleted(t.metadata)||!PouchUtils.isDeleted(e)&&h&&"new_leaf"!==n.conflicts;return o?(E.push(d(Pouch.Errors.REV_CONFLICT,t._bulk_seq)),l()):(t.metadata.rev_tree=n.tree,a(t,l,!0),void 0)}function c(e){return"was_delete"in t&&PouchUtils.isDeleted(e.metadata)?(E.push(Pouch.Errors.MISSING_DOC),l()):(a(e,l,!1),void 0)}function l(){if(!m.length)return r();var e=m.shift(),t=e.metadata.id;t in P?s(P[t],e):(P[t]=e.metadata,c(e))}function d(e,t){return e._bulk_seq=t,e}function f(e,t,n,o){var r=[e.metadata.id,e.metadata.rev].join("@"),i={digest:t},u="SELECT digest, json FROM "+ATTACH_STORE+" WHERE digest=?";y.executeSql(u,[t],function(e,a){a.rows.length?(i.refs=JSON.parse(a.rows.item(0).json).refs,u="UPDATE "+ATTACH_STORE+" SET json=?, body=? WHERE digest=?",e.executeSql(u,[JSON.stringify(i),n,t],function(){PouchUtils.call(o,null)})):(i.refs={},i.refs[r]=!0,u="INSERT INTO "+ATTACH_STORE+"(digest, json, body) VALUES (?, ?, ?)",e.executeSql(u,[t,JSON.stringify(i),n],function(){PouchUtils.call(o,null)}))})}function p(e,t){for(var n=0;t.rows.length>n;n++){var o=t.rows.item(n);P[o.id]=JSON.parse(o.json)}l()}var h=t.new_edits,v=e.docs,_=0,m=v.map(function(e,t){var n=PouchUtils.parseDoc(e,h);return n._bulk_seq=t,n}),g=m.filter(function(e){return e.error});if(g.length)return PouchUtils.call(n,g[0]);var y,E=[],P={};u(function(){db.transaction(function(e){y=e;var t="("+m.map(function(e){return quote(e.metadata.id)}).join(",")+")",n="SELECT * FROM "+DOC_STORE+" WHERE id IN "+t;y.executeSql(n,[],p)},unknownError(n))})},api._get=function(e,t,n){function o(){PouchUtils.call(n,u,{doc:r,metadata:i,ctx:a})}var r,i,u;if(!t.ctx)return db.transaction(function(o){t.ctx=o,api._get(e,t,n)}),void 0;var a=t.ctx,s="SELECT * FROM "+DOC_STORE+" WHERE id=?";a.executeSql(s,[e],function(e,n){if(!n.rows.length)return u=Pouch.Errors.MISSING_DOC,o();if(i=JSON.parse(n.rows.item(0).json),PouchUtils.isDeleted(i)&&!t.rev)return u=Pouch.error(Pouch.Errors.MISSING_DOC,"deleted"),o();var s=PouchMerge.winningRev(i),c=t.rev?t.rev:s;c=i.id+"::"+c;var l="SELECT * FROM "+BY_SEQ_STORE+" WHERE doc_id_rev=?";a.executeSql(l,[c],function(e,t){return t.rows.length?(r=JSON.parse(t.rows.item(0).json),o(),void 0):(u=Pouch.Errors.MISSING_DOC,o())})})},api._allDocs=function(e,t){var n=[],o={},r="startkey"in e?e.startkey:!1,i="endkey"in e?e.endkey:!1,u="descending"in e?e.descending:!1,a="SELECT "+DOC_STORE+".id, "+BY_SEQ_STORE+".seq, "+BY_SEQ_STORE+".json AS data, "+DOC_STORE+".json AS metadata FROM "+BY_SEQ_STORE+" JOIN "+DOC_STORE+" ON "+BY_SEQ_STORE+".seq = "+DOC_STORE+".winningseq";"keys"in e?a+=" WHERE "+DOC_STORE+".id IN ("+e.keys.map(function(e){return quote(e)}).join(",")+")":(r&&(a+=" WHERE "+DOC_STORE+'.id >= "'+r+'"'),i&&(a+=(r?" AND ":" WHERE ")+DOC_STORE+'.id <= "'+i+'"'),a+=" ORDER BY "+DOC_STORE+".id "+(u?"DESC":"ASC")),db.transaction(function(t){t.executeSql(a,[],function(t,r){for(var i=0,u=r.rows.length;u>i;i++){var a=r.rows.item(i),s=JSON.parse(a.metadata),c=JSON.parse(a.data);if(!PouchUtils.isLocalId(s.id)){if(a={id:s.id,key:s.id,value:{rev:PouchMerge.winningRev(s)}},e.include_docs){a.doc=c,a.doc._rev=PouchMerge.winningRev(s),e.conflicts&&(a.doc._conflicts=PouchMerge.collectConflicts(s));for(var l in a.doc._attachments)a.doc._attachments[l].stub=!0}"keys"in e?e.keys.indexOf(s.id)>-1&&(PouchUtils.isDeleted(s)&&(a.value.deleted=!0,a.doc=null),o[a.id]=a):PouchUtils.isDeleted(s)||n.push(a)}}})},unknownError(t),function(){"keys"in e&&(e.keys.forEach(function(e){e in o?n.push(o[e]):n.push({key:e,error:"not_found"})}),e.descending&&n.reverse()),PouchUtils.call(t,null,{total_rows:n.length,offset:e.skip,rows:"limit"in e?n.slice(e.skip,e.limit+e.skip):e.skip>0?n.slice(e.skip):n})})},api._changes=function idb_changes(opts){function fetchChanges(){var e="SELECT "+DOC_STORE+".id, "+BY_SEQ_STORE+".seq, "+BY_SEQ_STORE+".json AS data, "+DOC_STORE+".json AS metadata FROM "+BY_SEQ_STORE+" JOIN "+DOC_STORE+" ON "+BY_SEQ_STORE+".seq = "+DOC_STORE+".winningseq WHERE "+DOC_STORE+".seq > "+opts.since+" ORDER BY "+DOC_STORE+".seq "+(descending?"DESC":"ASC");
db.transaction(function(t){t.executeSql(e,[],function(e,t){for(var n=0,o=0,r=t.rows.length;r>o;o++){var i=t.rows.item(o),u=JSON.parse(i.metadata);if(!PouchUtils.isLocalId(u.id)){i.seq>n&&(n=i.seq);var a=JSON.parse(i.data),s=a._rev,c=[{rev:s}];"all_docs"===opts.style&&(c=makeRevs(PouchMerge.collectLeaves(u.rev_tree)));var l={id:u.id,seq:i.seq,changes:c,doc:a};PouchUtils.isDeleted(u,s)&&(l.deleted=!0),opts.conflicts&&(l.doc._conflicts=PouchMerge.collectConflicts(u)),results.push(l)}}PouchUtils.processChanges(opts,results,n)})})}if(Pouch.DEBUG&&console.log(name+": Start Changes Feed: continuous="+opts.continuous),opts.continuous){var id=name+":"+Pouch.uuid();return opts.cancelled=!1,webSqlPouch.Changes.addListener(name,id,api,opts),webSqlPouch.Changes.notify(name),{cancel:function(){Pouch.DEBUG&&console.log(name+": Cancel Changes Feed"),opts.cancelled=!0,webSqlPouch.Changes.removeListener(name,id)}}}var descending=opts.descending;opts.since=opts.since&&!descending?opts.since:0;var results=[],txn;if(opts.filter&&"string"==typeof opts.filter){var filterName=opts.filter.split("/");api.get("_design/"+filterName[0],function(err,ddoc){var filter=eval("(function() { return "+ddoc.filters[filterName[1]]+" })()");opts.filter=filter,fetchChanges()})}else fetchChanges()},api._close=function(e){PouchUtils.call(e,null)},api._getAttachment=function(e,t,n){var o,r=t.ctx,i=e.digest,u=e.content_type,a="SELECT body FROM "+ATTACH_STORE+" WHERE digest=?";r.executeSql(a,[i],function(e,r){var i=r.rows.item(0).body;o=t.encode?btoa(i):new Blob([i],{type:u}),PouchUtils.call(n,null,o)})},api._getRevisionTree=function(e,t){db.transaction(function(n){var o="SELECT json AS metadata FROM "+DOC_STORE+" WHERE id = ?";n.executeSql(o,[e],function(e,n){if(n.rows.length){var o=JSON.parse(n.rows.item(0).metadata);PouchUtils.call(t,null,o.rev_tree)}else PouchUtils.call(t,Pouch.Errors.MISSING_DOC)})})},api._doCompaction=function(e,t,n,o){db.transaction(function(r){var i="SELECT json AS metadata FROM "+DOC_STORE+" WHERE id = ?";r.executeSql(i,[e],function(r,i){if(!i.rows.length)return PouchUtils.call(o);var u=JSON.parse(i.rows.item(0).metadata);u.rev_tree=t;var a="DELETE FROM "+BY_SEQ_STORE+" WHERE doc_id_rev IN ("+n.map(function(t){return quote(e+"::"+t)}).join(",")+")";r.executeSql(a,[],function(t){var n="UPDATE "+DOC_STORE+" SET json = ? WHERE id = ?";t.executeSql(n,[JSON.stringify(u),e],function(){o()})})})})},api):PouchUtils.call(callback,Pouch.Errors.UNKNOWN_ERROR)};webSqlPouch.valid=function(){return"undefined"!=typeof window&&!!window.openDatabase},webSqlPouch.destroy=function(e,t,n){var o=openDatabase(e,POUCH_VERSION,e,POUCH_SIZE);o.transaction(function(e){e.executeSql("DROP TABLE IF EXISTS "+DOC_STORE,[]),e.executeSql("DROP TABLE IF EXISTS "+BY_SEQ_STORE,[]),e.executeSql("DROP TABLE IF EXISTS "+ATTACH_STORE,[]),e.executeSql("DROP TABLE IF EXISTS "+META_STORE,[])},unknownError(n),function(){PouchUtils.call(n,null)})},webSqlPouch.Changes=new PouchUtils.Changes,Pouch.adapter("websql",webSqlPouch);var pouchCollate;"undefined"!=typeof module&&module.exports&&(pouchCollate=require("../pouch.collate.js"));var MapReduce=function(db){function viewQuery(fun,options){function sum(e){return e.reduce(function(e,t){return e+t},0)}if(options.complete){options.skip||(options.skip=0),fun.reduce||(options.reduce=!1);var builtInReduce={_sum:function(e,t){return sum(t)},_count:function(e,t,n){return n?sum(t):t.length},_stats:function(e,t){return{sum:sum(t),min:Math.min.apply(null,t),max:Math.max.apply(null,t),count:t.length,sumsqr:function(){var e=0;for(var n in t)"number"==typeof t[n]&&(e+=t[n]*t[n]);return e}()}}},results=[],current=null,num_started=0,completed=!1,emit=function(e,t){var n={id:current.doc._id,key:e,value:t};if(!(options.startkey&&0>pouchCollate(e,options.startkey)||options.endkey&&pouchCollate(e,options.endkey)>0||options.key&&0!==pouchCollate(e,options.key))){if(num_started++,options.include_docs){if(t&&"object"==typeof t&&t._id)return db.get(t._id,function(e,t){t&&(n.doc=t),results.push(n),checkComplete()}),void 0;n.doc=current.doc}results.push(n)}};eval("fun.map = "+(""+fun.map)+";"),fun.reduce&&(builtInReduce[fun.reduce]&&(fun.reduce=builtInReduce[fun.reduce]),eval("fun.reduce = "+(""+fun.reduce)+";"));var checkComplete=function(){if(completed&&results.length==num_started){if(results.sort(function(e,t){return pouchCollate(e.key,t.key)}),options.descending&&results.reverse(),options.reduce===!1)return options.complete(null,{total_rows:results.length,offset:options.skip,rows:"limit"in options?results.slice(options.skip,options.limit+options.skip):options.skip>0?results.slice(options.skip):results});var e=[];results.forEach(function(t){var n=e[e.length-1]||null;return n&&0===pouchCollate(n.key[0][0],t.key)?(n.key.push([t.key,t.id]),n.value.push(t.value),void 0):(e.push({key:[[t.key,t.id]],value:[t.value]}),void 0)}),e.forEach(function(e){e.value=fun.reduce(e.key,e.value),e.value=e.value===void 0?null:e.value,e.key=e.key[0][0]}),options.complete(null,{total_rows:e.length,offset:options.skip,rows:"limit"in options?e.slice(options.skip,options.limit+options.skip):options.skip>0?e.slice(options.skip):e})}};db.changes({conflicts:!0,include_docs:!0,onChange:function(e){"deleted"in e||(current={doc:e.doc},fun.map.call(this,e.doc))},complete:function(){completed=!0,checkComplete()}})}}function httpQuery(e,t,n){var o=[],r=void 0,i="GET";if(t.reduce!==void 0&&o.push("reduce="+t.reduce),t.include_docs!==void 0&&o.push("include_docs="+t.include_docs),t.limit!==void 0&&o.push("limit="+t.limit),t.descending!==void 0&&o.push("descending="+t.descending),t.startkey!==void 0&&o.push("startkey="+encodeURIComponent(JSON.stringify(t.startkey))),t.endkey!==void 0&&o.push("endkey="+encodeURIComponent(JSON.stringify(t.endkey))),t.key!==void 0&&o.push("key="+encodeURIComponent(JSON.stringify(t.key))),t.group!==void 0&&o.push("group="+t.group),t.group_level!==void 0&&o.push("group_level="+t.group_level),t.skip!==void 0&&o.push("skip="+t.skip),t.keys!==void 0&&(i="POST",r=JSON.stringify({keys:t.keys})),o=o.join("&"),o=""===o?"":"?"+o,"string"==typeof e){var u=e.split("/");return db.request({method:i,url:"_design/"+u[0]+"/_view/"+u[1]+o,body:r},n),void 0}var a=JSON.parse(JSON.stringify(e,function(e,t){return"function"==typeof t?t+"":t}));db.request({method:"POST",url:"_temp_view"+o,body:a},n)}function query(e,t,n){if("function"==typeof t&&(n=t,t={}),n&&(t.complete=n),"http"===db.type())return"function"==typeof e?httpQuery({map:e},t,n):httpQuery(e,t,n);if("object"==typeof e)return viewQuery(e,t);if("function"==typeof e)return viewQuery({map:e},t);var o=e.split("/");db.get("_design/"+o[0],function(e,r){return e?(n&&n(e),void 0):r.views[o[1]]?(viewQuery({map:r.views[o[1]].map,reduce:r.views[o[1]].reduce},t),void 0):(n&&n({error:"not_found",reason:"missing_named_view"}),void 0)})}return{query:query}};MapReduce._delete=function(){},Pouch.plugin("mapreduce",MapReduce)})(this);
(function(){var DelayedOp,DelayedSyncAnimation,Dropbox,DropboxClient,DropboxOauth,DropboxXhr,DropboxXhrCanSendForms,DropboxXhrIeMode,DropboxXhrRequest,OneOp,REALTIME_MIMETYPE,Set,add32,arrayToBase64,atob,atobNibble,base64Digits,base64HmacSha1,base64Sha1,baseUrl,btoa,btoaNibble,crypto,dropboxEncodeKey,exports,handleErrors,hmacSha1,mixpanel_token,rotateLeft32,sha1,stringToArray,_base64Digits,__hasProp={}.hasOwnProperty,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}},__slice=[].slice,__indexOf=[].indexOf||function(item){for(var i=0,l=this.length;i<l;i++){if(i in this&&this[i]===item)return i}return-1};(function(){var Nimbus,headID,newScript;if(window.Nimbus==null){window.Nimbus={}}Nimbus=window.Nimbus;window.handle_initialization=null;Nimbus.loaded=false;window.handleClientLoad=function(){console.log("loaded CALLED");Nimbus.loaded=true;if(Nimbus.gdrive_initialized){return Nimbus.Auth.initialize()}};headID=document.getElementsByTagName("head")[0];newScript=document.createElement("script");newScript.type="text/javascript";newScript.src="https://apis.google.com/js/client.js?onload=handleClientLoad";return headID.appendChild(newScript)})();Dropbox=function(){function Dropbox(options){this.client=new DropboxClient(options)}return Dropbox}();Dropbox.ApiError=function(){function ApiError(xhr,method,url){var e,text;this.method=method;this.url=url;this.status=xhr.status;if(xhr.responseType){text=xhr.response||xhr.responseText}else{text=xhr.responseText}if(text){try{this.responseText=text.toString();this.response=JSON.parse(text)}catch(_error){e=_error;this.response=null}}else{this.responseText="(no response)";this.response=null}}ApiError.prototype.toString=function(){return"Dropbox API error "+this.status+" from "+this.method+" "+this.url+" :: "+this.responseText};ApiError.prototype.inspect=function(){return this.toString()};return ApiError}();if(typeof window!=="undefined"&&window!==null){if(window.atob&&window.btoa){atob=function(string){return window.atob(string)};btoa=function(base64){return window.btoa(base64)}}else{base64Digits="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";btoaNibble=function(accumulator,bytes,result){var i,limit;limit=3-bytes;accumulator<<=limit*8;i=3;while(i>=limit){result.push(base64Digits.charAt(accumulator>>i*6&63));i-=1}i=bytes;while(i<3){result.push("=");i+=1}return null};atobNibble=function(accumulator,digits,result){var i,limit;limit=4-digits;accumulator<<=limit*6;i=2;while(i>=limit){result.push(String.fromCharCode(accumulator>>8*i&255));i-=1}return null};btoa=function(string){var accumulator,bytes,i,result,_i,_ref;result=[];accumulator=0;bytes=0;for(i=_i=0,_ref=string.length;0<=_ref?_i<_ref:_i>_ref;i=0<=_ref?++_i:--_i){accumulator=accumulator<<8|string.charCodeAt(i);bytes+=1;if(bytes===3){btoaNibble(accumulator,bytes,result);accumulator=bytes=0}}if(bytes>0){btoaNibble(accumulator,bytes,result)}return result.join("")};atob=function(base64){var accumulator,digit,digits,i,result,_i,_ref;result=[];accumulator=0;digits=0;for(i=_i=0,_ref=base64.length;0<=_ref?_i<_ref:_i>_ref;i=0<=_ref?++_i:--_i){digit=base64.charAt(i);if(digit==="="){break}accumulator=accumulator<<6|base64Digits.indexOf(digit);digits+=1;if(digits===4){atobNibble(accumulator,digits,result);accumulator=digits=0}}if(digits>0){atobNibble(accumulator,digits,result)}return result.join("")}}}else{atob=function(arg){var buffer,i;buffer=new Buffer(arg,"base64");return function(){var _i,_ref,_results;_results=[];for(i=_i=0,_ref=buffer.length;0<=_ref?_i<_ref:_i>_ref;i=0<=_ref?++_i:--_i){_results.push(String.fromCharCode(buffer[i]))}return _results}().join("")};btoa=function(arg){var buffer,i;buffer=new Buffer(function(){var _i,_ref,_results;_results=[];for(i=_i=0,_ref=arg.length;0<=_ref?_i<_ref:_i>_ref;i=0<=_ref?++_i:--_i){_results.push(arg.charCodeAt(i))}return _results}());return buffer.toString("base64")}}Dropbox.Client=function(){function Client(options){this.sandbox=options.sandbox||false;this.apiServer=options.server||this.defaultApiServer();this.authServer=options.authServer||this.defaultAuthServer();this.fileServer=options.fileServer||this.defaultFileServer();this.oauth=new DropboxOauth(options);this.uid=null;this.authState=null;this.authError=null;this._credentials=null;this.setCredentials(options);this.setupUrls()}Client.prototype.authDriver=function(driver){this.driver=driver;return this};Client.prototype.dropboxUid=function(){return this.uid};Client.prototype.credentials=function(){if(!this._credentials){this.computeCredentials()}return this._credentials};Client.prototype.authenticate=function(callback){var oldAuthState,_fsmStep,_this=this;oldAuthState=null;_fsmStep=function(){var authUrl;if(oldAuthState!==_this.authState){oldAuthState=_this.authState;if(_this.driver.onAuthStateChange){return _this.driver.onAuthStateChange(_this,_fsmStep)}}switch(_this.authState){case DropboxClient.RESET:return _this.requestToken(function(error,data){var token,tokenSecret;if(error){_this.authError=error;_this.authState=DropboxClient.ERROR}else{token=data.oauth_token;tokenSecret=data.oauth_token_secret;_this.oauth.setToken(token,tokenSecret);_this.authState=DropboxClient.REQUEST}_this._credentials=null;return _fsmStep()});case DropboxClient.REQUEST:authUrl=_this.authorizeUrl(_this.oauth.token);return _this.driver.doAuthorize(authUrl,_this.oauth.token,_this.oauth.tokenSecret,function(){_this.authState=DropboxClient.AUTHORIZED;_this._credentials=null;return _fsmStep()});case DropboxClient.AUTHORIZED:return _this.getAccessToken(function(error,data){if(error){_this.authError=error;_this.authState=DropboxClient.ERROR}else{_this.oauth.setToken(data.oauth_token,data.oauth_token_secret);_this.uid=data.uid;_this.authState=DropboxClient.DONE}_this._credentials=null;return _fsmStep()});case DropboxClient.DONE:return callback(null,_this);case Dropbox.SIGNED_OFF:_this.reset();return _fsmStep();case DropboxClient.ERROR:return callback(_this.authError)}};_fsmStep();return this};Client.prototype.signOut=function(callback){var params,url,_this=this;url=this.urls.signOut;params=this.oauth.addAuthParams("POST",url,{});return Dropbox.Xhr.request("POST",url,params,null,function(error){if(error){return callback(error)}_this.reset();_this.authState=DropboxClient.SIGNED_OFF;if(_this.driver.onAuthStateChange){return _this.driver.onAuthStateChange(_this,function(){return callback(error)})}else{return callback(error)}})};Client.prototype.signOff=function(callback){return this.signOut(callback)};Client.prototype.getUserInfo=function(callback){var params,url;url=this.urls.accountInfo;params=this.oauth.addAuthParams("GET",url,{});return Dropbox.Xhr.request("GET",url,params,null,function(error,userData){return callback(error,Dropbox.UserInfo.parse(userData),userData)})};Client.prototype.readFile=function(path,options,callback){var params,responseType,url;if(!callback&&typeof options==="function"){callback=options;options=null}url=""+this.urls.getFile+"/"+this.urlEncodePath(path);params={};responseType=null;if(options){if(options.versionTag){params.rev=options.versionTag}else if(options.rev){params.rev=options.rev}if(options.blob){responseType="blob"}if(options.binary){responseType="b"}}this.oauth.addAuthParams("GET",url,params);return Dropbox.Xhr.request2("GET",url,params,null,null,responseType,function(error,data,metadata){return callback(error,data,Dropbox.Stat.parse(metadata))})};Client.prototype.writeFile=function(path,data,options,callback){var useForm;if(!callback&&typeof options==="function"){callback=options;options=null}useForm=Dropbox.Xhr.canSendForms&&typeof data==="object";if(useForm){return this.writeFileUsingForm(path,data,options,callback)}else{return this.writeFileUsingPut(path,data,options,callback)}};Client.prototype.writeFileUsingForm=function(path,data,options,callback){var fileField,fileName,params,slashIndex,url;slashIndex=path.lastIndexOf("/");if(slashIndex===-1){fileName=path;path=""}else{fileName=path.substring(slashIndex);path=path.substring(0,slashIndex)}url=""+this.urls.postFile+"/"+this.urlEncodePath(path);params={file:fileName};if(options){if(options.noOverwrite){params.overwrite="false"}if(options.lastVersionTag){params.parent_rev=options.lastVersionTag}else if(options.parentRev||options.parent_rev){params.parent_rev=options.parentRev||options.parent_rev}}this.oauth.addAuthParams("POST",url,params);delete params.file;fileField={name:"file",value:data,fileName:fileName,contentType:"application/octet-stream"};return Dropbox.Xhr.multipartRequest(url,fileField,params,null,function(error,metadata){return callback(error,Dropbox.Stat.parse(metadata))})};Client.prototype.writeFileUsingPut=function(path,data,options,callback){var params,url;url=""+this.urls.putFile+"/"+this.urlEncodePath(path);params={};if(options){if(options.noOverwrite){params.overwrite="false"}if(options.lastVersionTag){params.parent_rev=options.lastVersionTag}else if(options.parentRev||options.parent_rev){params.parent_rev=options.parentRev||options.parent_rev}}this.oauth.addAuthParams("POST",url,params);return Dropbox.Xhr.request2("POST",url,params,null,data,null,function(error,metadata){return callback(error,Dropbox.Stat.parse(metadata))})};Client.prototype.stat=function(path,options,callback){var params,url;if(!callback&&typeof options==="function"){callback=options;options=null}url=""+this.urls.metadata+"/"+this.urlEncodePath(path);params={};if(options){if(options.version!=null){params.rev=options.version}if(options.removed||options.deleted){params.include_deleted="true"}if(options.readDir){params.list="true";if(options.readDir!==true){params.file_limit=options.readDir.toString()}}if(options.cacheHash){params.hash=options.cacheHash}}params.include_deleted||(params.include_deleted="false");params.list||(params.list="false");this.oauth.addAuthParams("GET",url,params);return Dropbox.Xhr.request("GET",url,params,null,function(error,metadata){var entries,entry,stat;stat=Dropbox.Stat.parse(metadata);if(metadata!=null?metadata.contents:void 0){entries=function(){var _i,_len,_ref,_results;_ref=metadata.contents;_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){entry=_ref[_i];_results.push(Dropbox.Stat.parse(entry))}return _results}()}else{entries=void 0}return callback(error,stat,entries)})};Client.prototype.readdir=function(path,options,callback){var statOptions;if(!callback&&typeof options==="function"){callback=options;options=null}statOptions={readDir:true};if(options){if(options.limit!=null){statOptions.readDir=options.limit}if(options.versionTag){statOptions.versionTag=options.versionTag}}return this.stat(path,statOptions,function(error,stat,entry_stats){var entries,entry_stat;if(entry_stats){entries=function(){var _i,_len,_results;_results=[];for(_i=0,_len=entry_stats.length;_i<_len;_i++){entry_stat=entry_stats[_i];_results.push(entry_stat.name)}return _results}()}else{entries=null}return callback(error,entries,stat,entry_stats)})};Client.prototype.metadata=function(path,options,callback){return this.stat(path,options,callback)};Client.prototype.makeUrl=function(path,options,callback){var isDirect,params,url;if(!callback&&typeof options==="function"){callback=options;options=null}path=this.urlEncodePath(path);if(options&&options.download){isDirect=true;url=""+this.urls.media+"/"+path}else{isDirect=false;url=""+this.urls.shares+"/"+path}if(options&&(options["long"]||options.longUrl)){params={short_url:"false"}}else{params={}}this.oauth.addAuthParams("POST",url,params);return Dropbox.Xhr.request("POST",url,params,null,function(error,urlData){return callback(error,Dropbox.PublicUrl.parse(urlData,isDirect))})};Client.prototype.history=function(path,options,callback){var params,url;if(!callback&&typeof options==="function"){callback=options;options=null}url=""+this.urls.revisions+"/"+this.urlEncodePath(path);params={};if(options&&options.limit!=null){params.rev_limit=options.limit}this.oauth.addAuthParams("GET",url,params);return Dropbox.Xhr.request("GET",url,params,null,function(error,versions){var metadata,stats;if(versions){stats=function(){var _i,_len,_results;_results=[];for(_i=0,_len=versions.length;_i<_len;_i++){metadata=versions[_i];_results.push(Dropbox.Stat.parse(metadata))}return _results}()}else{stats=void 0}return callback(error,stats)})};Client.prototype.revisions=function(path,options,callback){return this.history(path,options,callback)};Client.prototype.thumbnailUrl=function(path,options){var params,url;url=""+this.urls.thumbnails+"/"+this.urlEncodePath(path);params={};if(options){if(options.format){params.format=options.format}else if(options.png){params.format="png"}if(options.size){params.size=options.size}}this.oauth.addAuthParams("GET",url,params);return""+url+"?"+Dropbox.Xhr.urlEncode(params)};Client.prototype.readThumbnail=function(path,options,callback){var responseType,url;if(!callback&&typeof options==="function"){callback=options;options=null}url=this.thumbnailUrl(path,options);responseType="b";if(options){if(options.blob){responseType="blob"}}return Dropbox.Xhr.request2("GET",url,{},null,null,responseType,function(error,data,metadata){return callback(error,data,Dropbox.Stat.parse(metadata))})};Client.prototype.revertFile=function(path,versionTag,callback){var params,url;url=""+this.urls.restore+"/"+this.urlEncodePath(path);params={rev:versionTag};this.oauth.addAuthParams("POST",url,params);return Dropbox.Xhr.request("POST",url,params,null,function(error,metadata){return callback(error,Dropbox.Stat.parse(metadata))})};Client.prototype.restore=function(path,versionTag,callback){return this.revertFile(path,versionTag,callback)};Client.prototype.findByName=function(path,namePattern,options,callback){var params,url;if(!callback&&typeof options==="function"){callback=options;options=null}url=""+this.urls.search+"/"+this.urlEncodePath(path);params={query:namePattern};if(options){if(options.limit!=null){params.file_limit=options.limit}if(options.removed||options.deleted){params.include_deleted=true}}this.oauth.addAuthParams("GET",url,params);return Dropbox.Xhr.request("GET",url,params,null,function(error,results){var metadata,stats;if(results){stats=function(){var _i,_len,_results;_results=[];for(_i=0,_len=results.length;_i<_len;_i++){metadata=results[_i];_results.push(Dropbox.Stat.parse(metadata))}return _results}()}else{stats=void 0}return callback(error,stats)})};Client.prototype.search=function(path,namePattern,options,callback){return this.findByName(path,namePattern,options,callback)};Client.prototype.makeCopyReference=function(path,callback){var params,url;url=""+this.urls.copyRef+"/"+this.urlEncodePath(path);params=this.oauth.addAuthParams("GET",url,{});return Dropbox.Xhr.request("GET",url,params,null,function(error,refData){return callback(error,Dropbox.CopyReference.parse(refData))})};Client.prototype.copyRef=function(path,callback){return this.makeCopyReference(path,callback)};Client.prototype.pullChanges=function(cursor,callback){var params,url;if(!callback&&typeof cursor==="function"){callback=cursor;cursor=null}url=this.urls.delta;params={};if(cursor){if(cursor.cursorTag){params={cursor:cursor.cursorTag}}else{params={cursor:cursor}}}else{params={}}this.oauth.addAuthParams("POST",url,params);return Dropbox.Xhr.request("POST",url,params,null,function(error,deltaInfo){return callback(error,Dropbox.PulledChanges.parse(deltaInfo))})};Client.prototype.delta=function(cursor,callback){return this.pullChanges(cursor,callback)};Client.prototype.mkdir=function(path,callback){var params,url;url=this.urls.fileopsCreateFolder;params={root:this.fileRoot,path:this.normalizePath(path)};this.oauth.addAuthParams("POST",url,params);return Dropbox.Xhr.request("POST",url,params,null,function(error,metadata){return callback(error,Dropbox.Stat.parse(metadata))})};Client.prototype.remove=function(path,callback){var params,url;url=this.urls.fileopsDelete;params={root:this.fileRoot,path:this.normalizePath(path)};this.oauth.addAuthParams("POST",url,params);return Dropbox.Xhr.request("POST",url,params,null,function(error,metadata){return callback(error,Dropbox.Stat.parse(metadata))})};Client.prototype.unlink=function(path,callback){return this.remove(path,callback)};Client.prototype["delete"]=function(path,callback){return this.remove(path,callback)};Client.prototype.copy=function(from,toPath,callback){var options,params,url;if(!callback&&typeof options==="function"){callback=options;options=null}params={root:this.fileRoot,to_path:this.normalizePath(toPath)};if(from instanceof Dropbox.CopyReference){params.from_copy_ref=from.tag}else{params.from_path=this.normalizePath(from)}url=this.urls.fileopsCopy;this.oauth.addAuthParams("POST",url,params);return Dropbox.Xhr.request("POST",url,params,null,function(error,metadata){return callback(error,Dropbox.Stat.parse(metadata))})};Client.prototype.move=function(fromPath,toPath,callback){var options,params,url;if(!callback&&typeof options==="function"){callback=options;options=null}fromPath=this.normalizePath(fromPath);toPath=this.normalizePath(toPath);url=this.urls.fileopsMove;params={root:this.fileRoot,from_path:fromPath,to_path:toPath};this.oauth.addAuthParams("POST",url,params);return Dropbox.Xhr.request("POST",url,params,null,function(error,metadata){return callback(error,Dropbox.Stat.parse(metadata))})};Client.prototype.reset=function(){this.uid=null;this.oauth.setToken(null,"");this.authState=DropboxClient.RESET;this.authError=null;this._credentials=null;return this};Client.prototype.setCredentials=function(credentials){this.oauth.reset(credentials);this.uid=credentials.uid||null;if(credentials.authState){this.authState=credentials.authState}else{if(credentials.token){this.authState=DropboxClient.DONE}else{this.authState=DropboxClient.RESET}}this.authError=null;this._credentials=null;return this};Client.prototype.appHash=function(){return this.oauth.appHash()};Client.prototype.setupUrls=function(){this.fileRoot=this.sandbox?"sandbox":"dropbox";return this.urls={requestToken:""+this.apiServer+"/1/oauth/request_token",authorize:""+this.authServer+"/1/oauth/authorize",accessToken:""+this.apiServer+"/1/oauth/access_token",signOut:""+this.apiServer+"/1/unlink_access_token",accountInfo:""+this.apiServer+"/1/account/info",getFile:""+this.fileServer+"/1/files/"+this.fileRoot,postFile:""+this.fileServer+"/1/files/"+this.fileRoot,putFile:""+this.fileServer+"/1/files_put/"+this.fileRoot,metadata:""+this.apiServer+"/1/metadata/"+this.fileRoot,delta:""+this.apiServer+"/1/delta",revisions:""+this.apiServer+"/1/revisions/"+this.fileRoot,restore:""+this.apiServer+"/1/restore/"+this.fileRoot,search:""+this.apiServer+"/1/search/"+this.fileRoot,shares:""+this.apiServer+"/1/shares/"+this.fileRoot,media:""+this.apiServer+"/1/media/"+this.fileRoot,copyRef:""+this.apiServer+"/1/copy_ref/"+this.fileRoot,thumbnails:""+this.fileServer+"/1/thumbnails/"+this.fileRoot,fileopsCopy:""+this.apiServer+"/1/fileops/copy",fileopsCreateFolder:""+this.apiServer+"/1/fileops/create_folder",fileopsDelete:""+this.apiServer+"/1/fileops/delete",fileopsMove:""+this.apiServer+"/1/fileops/move"}};Client.ERROR=0;Client.RESET=1;Client.REQUEST=2;Client.AUTHORIZED=3;Client.DONE=4;Client.SIGNED_OFF=5;Client.prototype.urlEncodePath=function(path){return Dropbox.Xhr.urlEncodeValue(this.normalizePath(path)).replace(/%2F/gi,"/")};Client.prototype.normalizePath=function(path){var i;if(path.substring(0,1)==="/"){i=1;while(path.substring(i,i+1)==="/"){i+=1}return path.substring(i)}else{return path}};Client.prototype.requestToken=function(callback){var params;params=this.oauth.addAuthParams("POST",this.urls.requestToken,{});return Dropbox.Xhr.request("POST",this.urls.requestToken,params,null,callback)};Client.prototype.authorizeUrl=function(token){var params;params={oauth_token:token,oauth_callback:this.driver.url()};return""+this.urls.authorize+"?"+Dropbox.Xhr.urlEncode(params)};Client.prototype.getAccessToken=function(callback){var params;params=this.oauth.addAuthParams("POST",this.urls.accessToken,{});return Dropbox.Xhr.request("POST",this.urls.accessToken,params,null,callback)};Client.prototype.defaultApiServer=function(){return"https://api.dropbox.com"};Client.prototype.defaultAuthServer=function(){return this.apiServer.replace("api.","www.")};Client.prototype.defaultFileServer=function(){return this.apiServer.replace("api.","api-content.")};Client.prototype.computeCredentials=function(){var value;value={key:this.oauth.key,sandbox:this.sandbox};if(this.oauth.secret){value.secret=this.oauth.secret}if(this.oauth.token){value.token=this.oauth.token;value.tokenSecret=this.oauth.tokenSecret}if(this.uid){value.uid=this.uid}if(this.authState!==DropboxClient.ERROR&&this.authState!==DropboxClient.RESET&&this.authState!==DropboxClient.DONE&&this.authState!==DropboxClient.SIGNED_OFF){value.authState=this.authState}if(this.apiServer!==this.defaultApiServer()){value.server=this.apiServer}if(this.authServer!==this.defaultAuthServer()){value.authServer=this.authServer}if(this.fileServer!==this.defaultFileServer()){value.fileServer=this.fileServer}return this._credentials=value};return Client}();DropboxClient=Dropbox.Client;Dropbox.AuthDriver=function(){function AuthDriver(){}AuthDriver.prototype.url=function(){return"https://some.url"};AuthDriver.prototype.doAuthorize=function(authUrl,token,tokenSecret,callback){return callback("oauth-token")};AuthDriver.prototype.onAuthStateChange=function(client,done){return done()};return AuthDriver}();Dropbox.Drivers={};Dropbox.Drivers.Redirect=function(){function Redirect(options){this.rememberUser=(options!=null?options.rememberUser:void 0)||false;this.scope=(options!=null?options.scope:void 0)||"default";this.useQuery=(options!=null?options.useQuery:void 0)||false;this.receiverUrl=this.computeUrl(options);this.tokenRe=new RegExp("(#|\\?|&)oauth_token=([^&#]+)(&|#|$)")}Redirect.prototype.url=function(){return this.receiverUrl};Redirect.prototype.doAuthorize=function(authUrl){return window.location.assign(authUrl)};Redirect.prototype.onAuthStateChange=function(client,done){var credentials,_this=this;this.storageKey="dropbox-auth:"+this.scope+":"+client.appHash();switch(client.authState){case DropboxClient.RESET:if(!(credentials=this.loadCredentials())){return done()}if(credentials.authState){if(credentials.token===this.locationToken()){if(credentials.authState===DropboxClient.REQUEST){this.forgetCredentials();credentials.authState=DropboxClient.AUTHORIZED}client.setCredentials(credentials)}return done()}if(!this.rememberUser){this.forgetCredentials();return done()}client.setCredentials(credentials);return client.getUserInfo(function(error){if(error){client.reset();_this.forgetCredentials()}return done()});case DropboxClient.REQUEST:this.storeCredentials(client.credentials());return done();case DropboxClient.DONE:if(this.rememberUser){this.storeCredentials(client.credentials())}return done();case DropboxClient.SIGNED_OFF:this.forgetCredentials();return done();case DropboxClient.ERROR:this.forgetCredentials();return done();default:return done()}};Redirect.prototype.computeUrl=function(){var fragment,location,locationPair,querySuffix;querySuffix="_dropboxjs_scope="+encodeURIComponent(this.scope);location=Dropbox.Drivers.Redirect.currentLocation();if(location.indexOf("#")===-1){fragment=null}else{locationPair=location.split("#",2);location=locationPair[0];fragment=locationPair[1]}if(this.useQuery){if(location.indexOf("?")===-1){location+="?"+querySuffix}else{location+="&"+querySuffix}}else{fragment="?"+querySuffix}if(fragment){return location+"#"+fragment}else{return location}};Redirect.prototype.locationToken=function(){var location,match,scopePattern;location=Dropbox.Drivers.Redirect.currentLocation();scopePattern="_dropboxjs_scope="+encodeURIComponent(this.scope)+"&";if((typeof location.indexOf==="function"?location.indexOf(scopePattern):void 0)===-1){return null}match=this.tokenRe.exec(location);if(match){return decodeURIComponent(match[2])}else{return null}};Redirect.currentLocation=function(){return window.location.href};Redirect.prototype.storeCredentials=function(credentials){return localStorage.setItem(this.storageKey,JSON.stringify(credentials))};Redirect.prototype.loadCredentials=function(){var e,jsonString;jsonString=localStorage.getItem(this.storageKey);if(!jsonString){return null}try{return JSON.parse(jsonString)}catch(_error){e=_error;return null}};Redirect.prototype.forgetCredentials=function(){return localStorage.removeItem(this.storageKey)};return Redirect}();Dropbox.Drivers.Popup=function(){function Popup(options){this.receiverUrl=this.computeUrl(options);this.tokenRe=new RegExp("(#|\\?|&)oauth_token=([^&#]+)(&|#|$)")}Popup.prototype.doAuthorize=function(authUrl,token,tokenSecret,callback){this.listenForMessage(token,callback);return this.openWindow(authUrl)};Popup.prototype.url=function(){return this.receiverUrl};Popup.prototype.computeUrl=function(options){var fragments;if(options){if(options.receiverUrl){if(options.noFragment||options.receiverUrl.indexOf("#")!==-1){return options.receiverUrl}else{return options.receiverUrl+"#"}}else if(options.receiverFile){fragments=Dropbox.Drivers.Popup.currentLocation().split("/");fragments[fragments.length-1]=options.receiverFile;if(options.noFragment){return fragments.join("/")}else{return fragments.join("/")+"#"}}}return Dropbox.Drivers.Popup.currentLocation()};Popup.currentLocation=function(){return window.location.href};Popup.prototype.openWindow=function(url){return window.open(url,"_dropboxOauthSigninWindow",this.popupWindowSpec(980,980))};Popup.prototype.popupWindowSpec=function(popupWidth,popupHeight){var height,popupLeft,popupTop,width,x0,y0,_ref,_ref1,_ref2,_ref3;x0=(_ref=window.screenX)!=null?_ref:window.screenLeft;y0=(_ref1=window.screenY)!=null?_ref1:window.screenTop;width=(_ref2=window.outerWidth)!=null?_ref2:document.documentElement.clientWidth;height=(_ref3=window.outerHeight)!=null?_ref3:document.documentElement.clientHeight;popupLeft=Math.round(x0+(width-popupWidth)/2);popupTop=Math.round(y0+(height-popupHeight)/2.5);return"width="+popupWidth+",height="+popupHeight+","+("left="+popupLeft+",top="+popupTop)+"dialog=yes,dependent=yes,scrollbars=yes,location=yes"};Popup.prototype.listenForMessage=function(token,callback){var listener,tokenRe;tokenRe=this.tokenRe;listener=function(event){var match;match=tokenRe.exec(event.data.toString());if(match&&decodeURIComponent(match[2])===token){window.removeEventListener("message",listener);return callback()}};return window.addEventListener("message",listener,false)};return Popup}();Dropbox.Drivers.NodeServer=function(){function NodeServer(options){this.port=(options!=null?options.port:void 0)||8912;this.faviconFile=(options!=null?options.favicon:void 0)||null;this.fs=require("fs");this.http=require("http");this.open=require("open");this.callbacks={};this.urlRe=new RegExp("^/oauth_callback\\?");this.tokenRe=new RegExp("(\\?|&)oauth_token=([^&]+)(&|$)");this.createApp()}NodeServer.prototype.url=function(){return"http://localhost:"+this.port+"/oauth_callback"};NodeServer.prototype.doAuthorize=function(authUrl,token,tokenSecret,callback){this.callbacks[token]=callback;return this.openBrowser(authUrl)};NodeServer.prototype.openBrowser=function(url){if(!url.match(/^https?:\/\//)){throw new Error("Not a http/https URL: "+url)}return this.open(url)};NodeServer.prototype.createApp=function(){var _this=this;this.app=this.http.createServer(function(request,response){return _this.doRequest(request,response)});return this.app.listen(this.port)};NodeServer.prototype.closeServer=function(){return this.app.close()};NodeServer.prototype.doRequest=function(request,response){var data,match,token,_this=this;if(this.urlRe.exec(request.url)){match=this.tokenRe.exec(request.url);if(match){token=decodeURIComponent(match[2]);if(this.callbacks[token]){this.callbacks[token]();delete this.callbacks[token]}}}data="";request.on("data",function(dataFragment){return data+=dataFragment});return request.on("end",function(){if(_this.faviconFile&&request.url==="/favicon.ico"){return _this.sendFavicon(response)}else{return _this.closeBrowser(response)}})};NodeServer.prototype.closeBrowser=function(response){var closeHtml;closeHtml='<!doctype html>\n<script type="text/javascript">window.close();</script>\n<p>Please close this window.</p>';response.writeHead(200,{"Content-Length":closeHtml.length,"Content-Type":"text/html"});response.write(closeHtml);return response.end};NodeServer.prototype.sendFavicon=function(response){return this.fs.readFile(this.faviconFile,function(error,data){response.writeHead(200,{"Content-Length":data.length,"Content-Type":"image/x-icon"});response.write(data);return response.end})};return NodeServer}();base64HmacSha1=function(string,key){return arrayToBase64(hmacSha1(stringToArray(string),stringToArray(key),string.length,key.length))};base64Sha1=function(string){return arrayToBase64(sha1(stringToArray(string),string.length))};if(typeof window==="undefined"||window===null){crypto=require("crypto");base64HmacSha1=function(string,key){var hmac;hmac=crypto.createHmac("sha1",key);hmac.update(string);return hmac.digest("base64")};base64Sha1=function(string){var hash;hash=crypto.createHash("sha1");hash.update(string);return hash.digest("base64")}}hmacSha1=function(string,key,length,keyLength){var hash1,i,ipad,opad;if(key.length>16){key=sha1(key,keyLength)}ipad=function(){var _i,_results;_results=[];for(i=_i=0;_i<16;i=++_i){_results.push(key[i]^909522486)}return _results}();opad=function(){var _i,_results;_results=[];for(i=_i=0;_i<16;i=++_i){_results.push(key[i]^1549556828)}return _results}();hash1=sha1(ipad.concat(string),64+length);return sha1(opad.concat(hash1),64+20)};sha1=function(string,length){var a,a0,b,b0,c,c0,d,d0,e,e0,ft,i,j,kt,limit,state,t,_i;string[length>>2]|=1<<31-((length&3)<<3);string[(length+8>>6<<4)+15]=length<<3;state=Array(80);a=1732584193;b=-271733879;c=-1732584194;d=271733878;e=-1009589776;i=0;limit=string.length;while(i<limit){a0=a;b0=b;c0=c;d0=d;e0=e;for(j=_i=0;_i<80;j=++_i){if(j<16){state[j]=string[i+j]}else{state[j]=rotateLeft32(state[j-3]^state[j-8]^state[j-14]^state[j-16],1)}if(j<20){ft=b&c|~b&d;kt=1518500249}else if(j<40){ft=b^c^d;kt=1859775393}else if(j<60){ft=b&c|b&d|c&d;kt=-1894007588}else{ft=b^c^d;kt=-899497514}t=add32(add32(rotateLeft32(a,5),ft),add32(add32(e,state[j]),kt));e=d;d=c;c=rotateLeft32(b,30);b=a;a=t}a=add32(a,a0);b=add32(b,b0);c=add32(c,c0);d=add32(d,d0);e=add32(e,e0);i+=16}return[a,b,c,d,e]};rotateLeft32=function(value,count){return value<<count|value>>>32-count};add32=function(a,b){var high,low;low=(a&65535)+(b&65535);high=(a>>16)+(b>>16)+(low>>16);return high<<16|low&65535};arrayToBase64=function(array){var i,i2,limit,string,trit;string="";i=0;limit=array.length*4;while(i<limit){i2=i;trit=(array[i2>>2]>>(3-(i2&3)<<3)&255)<<16;i2+=1;trit|=(array[i2>>2]>>(3-(i2&3)<<3)&255)<<8;i2+=1;trit|=array[i2>>2]>>(3-(i2&3)<<3)&255;string+=_base64Digits[trit>>18&63];string+=_base64Digits[trit>>12&63];i+=1;if(i>=limit){string+="="}else{string+=_base64Digits[trit>>6&63]}i+=1;if(i>=limit){string+="="}else{string+=_base64Digits[trit&63]}i+=1}return string};_base64Digits="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";stringToArray=function(string){var array,i,mask,_i,_ref;array=[];mask=255;for(i=_i=0,_ref=string.length;0<=_ref?_i<_ref:_i>_ref;i=0<=_ref?++_i:--_i){array[i>>2]|=(string.charCodeAt(i)&mask)<<(3-(i&3)<<3)}return array};Dropbox.Oauth=function(){function Oauth(options){this.key=this.k=null;this.secret=this.s=null;this.token=null;this.tokenSecret=null;this._appHash=null;this.reset(options)}Oauth.prototype.reset=function(options){var k,s,secret,_ref;if(options.secret){this.k=this.key=options.key;this.s=this.secret=options.secret;this._appHash=null}else if(options.key){this.key=options.key;this.secret=null;secret=atob(dropboxEncodeKey(this.key).split("|",2)[1]);_ref=secret.split("?",2),k=_ref[0],s=_ref[1];this.k=decodeURIComponent(k);this.s=decodeURIComponent(s);this._appHash=null}else{if(!this.k){throw new Error("No API key supplied")}}if(options.token){return this.setToken(options.token,options.tokenSecret)
}else{return this.setToken(null,"")}};Oauth.prototype.setToken=function(token,tokenSecret){if(token&&!tokenSecret){throw new Error("No secret supplied with the user token")}this.token=token;this.tokenSecret=tokenSecret||"";this.hmacKey=DropboxXhr.urlEncodeValue(this.s)+"&"+DropboxXhr.urlEncodeValue(tokenSecret);return null};Oauth.prototype.authHeader=function(method,url,params){var header,oauth_params,param,value,_i,_len;this.addAuthParams(method,url,params);oauth_params=[];for(param in params){value=params[param];if(param.substring(0,6)==="oauth_"){oauth_params.push(param)}}oauth_params.sort();header=[];for(_i=0,_len=oauth_params.length;_i<_len;_i++){param=oauth_params[_i];header.push(DropboxXhr.urlEncodeValue(param)+'="'+DropboxXhr.urlEncodeValue(params[param])+'"');delete params[param]}return"OAuth "+header.join(",")};Oauth.prototype.addAuthParams=function(method,url,params){this.boilerplateParams(params);params.oauth_signature=this.signature(method,url,params);return params};Oauth.prototype.boilerplateParams=function(params){params.oauth_consumer_key=this.k;params.oauth_nonce=this.nonce();params.oauth_signature_method="HMAC-SHA1";if(this.token){params.oauth_token=this.token}params.oauth_timestamp=Math.floor(Date.now()/1e3);params.oauth_version="1.0";return params};Oauth.prototype.nonce=function(){return Date.now().toString(36)+Math.random().toString(36)};Oauth.prototype.signature=function(method,url,params){var string;string=method.toUpperCase()+"&"+DropboxXhr.urlEncodeValue(url)+"&"+DropboxXhr.urlEncodeValue(DropboxXhr.urlEncode(params));return base64HmacSha1(string,this.hmacKey)};Oauth.prototype.appHash=function(){if(this._appHash){return this._appHash}return this._appHash=base64Sha1(this.k).replace(/\=/g,"")};return Oauth}();if(Date.now==null){Date.now=function(){return(new Date).getTime()}}DropboxOauth=Dropbox.Oauth;dropboxEncodeKey=function(key,secret){var i,k,result,s,x,y,z,_i,_j,_ref,_ref1,_results;if(secret){secret=[encodeURIComponent(key),encodeURIComponent(secret)].join("?");key=function(){var _i,_ref,_results;_results=[];for(i=_i=0,_ref=key.length/2;0<=_ref?_i<_ref:_i>_ref;i=0<=_ref?++_i:--_i){_results.push((key.charCodeAt(i*2)&15)*16+(key.charCodeAt(i*2+1)&15))}return _results}()}else{_ref=key.split("|",2),key=_ref[0],secret=_ref[1];key=atob(key);key=function(){var _i,_ref1,_results;_results=[];for(i=_i=0,_ref1=key.length;0<=_ref1?_i<_ref1:_i>_ref1;i=0<=_ref1?++_i:--_i){_results.push(key.charCodeAt(i))}return _results}();secret=atob(secret)}s=function(){_results=[];for(_i=0;_i<256;_i++){_results.push(_i)}return _results}.apply(this);y=0;for(x=_j=0;_j<256;x=++_j){y=(y+s[i]+key[x%key.length])%256;_ref1=[s[y],s[x]],s[x]=_ref1[0],s[y]=_ref1[1]}x=y=0;result=function(){var _k,_ref2,_ref3,_results1;_results1=[];for(z=_k=0,_ref2=secret.length;0<=_ref2?_k<_ref2:_k>_ref2;z=0<=_ref2?++_k:--_k){x=(x+1)%256;y=(y+s[x])%256;_ref3=[s[y],s[x]],s[x]=_ref3[0],s[y]=_ref3[1];k=s[(s[x]+s[y])%256];_results1.push(String.fromCharCode((k^secret.charCodeAt(z))%256))}return _results1}();key=function(){var _k,_ref2,_results1;_results1=[];for(i=_k=0,_ref2=key.length;0<=_ref2?_k<_ref2:_k>_ref2;i=0<=_ref2?++_k:--_k){_results1.push(String.fromCharCode(key[i]))}return _results1}();return[btoa(key.join("")),btoa(result.join(""))].join("|")};Dropbox.PulledChanges=function(){PulledChanges.parse=function(deltaInfo){if(deltaInfo&&typeof deltaInfo==="object"){return new Dropbox.PulledChanges(deltaInfo)}else{return deltaInfo}};PulledChanges.prototype.blankSlate=void 0;PulledChanges.prototype.cursorTag=void 0;PulledChanges.prototype.changes=void 0;PulledChanges.prototype.shouldPullAgain=void 0;PulledChanges.prototype.shouldBackOff=void 0;function PulledChanges(deltaInfo){var entry;this.blankSlate=deltaInfo.reset||false;this.cursorTag=deltaInfo.cursor;this.shouldPullAgain=deltaInfo.has_more;this.shouldBackOff=!this.shouldPullAgain;if(deltaInfo.cursor&&deltaInfo.cursor.length){this.changes=function(){var _i,_len,_ref,_results;_ref=deltaInfo.entries;_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){entry=_ref[_i];_results.push(Dropbox.PullChange.parse(entry))}return _results}()}else{this.changes=[]}}return PulledChanges}();Dropbox.PullChange=function(){PullChange.parse=function(entry){if(entry&&typeof entry==="object"){return new Dropbox.PullChange(entry)}else{return entry}};PullChange.prototype.path=void 0;PullChange.prototype.wasRemoved=void 0;PullChange.prototype.stat=void 0;function PullChange(entry){this.path=entry[0];this.stat=Dropbox.Stat.parse(entry[1]);if(this.stat){this.wasRemoved=false}else{this.stat=null;this.wasRemoved=true}}return PullChange}();Dropbox.PublicUrl=function(){PublicUrl.parse=function(urlData,isDirect){if(urlData&&typeof urlData==="object"){return new Dropbox.PublicUrl(urlData,isDirect)}else{return urlData}};PublicUrl.prototype.url=void 0;PublicUrl.prototype.expiresAt=void 0;PublicUrl.prototype.isDirect=void 0;PublicUrl.prototype.isPreview=void 0;function PublicUrl(urlData,isDirect){this.url=urlData.url;this.expiresAt=new Date(Date.parse(urlData.expires));if(isDirect===true){this.isDirect=true}else if(isDirect===false){this.isDirect=false}else{this.isDirect=Date.now()-this.expiresAt<=864e5}this.isPreview=!this.isDirect}return PublicUrl}();Dropbox.CopyReference=function(){CopyReference.parse=function(refData){if(refData&&(typeof refData==="object"||typeof refData==="string")){return new Dropbox.CopyReference(refData)}else{return refData}};CopyReference.prototype.tag=void 0;CopyReference.prototype.expiresAt=void 0;function CopyReference(refData){if(typeof refData==="object"){this.tag=refData.copy_ref;this.expiresAt=new Date(Date.parse(refData.expires))}else{this.tag=refData;this.expiresAt=new Date}}return CopyReference}();Dropbox.Stat=function(){Stat.parse=function(metadata){if(metadata&&typeof metadata==="object"){return new Dropbox.Stat(metadata)}else{return metadata}};Stat.prototype.path=null;Stat.prototype.name=null;Stat.prototype.inAppFolder=null;Stat.prototype.isFolder=null;Stat.prototype.isFile=null;Stat.prototype.isRemoved=null;Stat.prototype.typeIcon=null;Stat.prototype.versionTag=null;Stat.prototype.mimeType=null;Stat.prototype.size=null;Stat.prototype.humanSize=null;Stat.prototype.hasThumbnail=null;Stat.prototype.modifiedAt=null;Stat.prototype.clientModifiedAt=null;function Stat(metadata){var lastIndex,nameSlash,_ref,_ref1;this.path=metadata.path;if(this.path.substring(0,1)!=="/"){this.path="/"+this.path}lastIndex=this.path.length-1;if(lastIndex>=0&&this.path.substring(lastIndex)==="/"){this.path=this.path.substring(0,lastIndex)}nameSlash=this.path.lastIndexOf("/");this.name=this.path.substring(nameSlash+1);this.isFolder=metadata.is_dir||false;this.isFile=!this.isFolder;this.isRemoved=metadata.is_deleted||false;this.typeIcon=metadata.icon;if((_ref=metadata.modified)!=null?_ref.length:void 0){this.modifiedAt=new Date(Date.parse(metadata.modified))}else{this.modifiedAt=null}if((_ref1=metadata.client_mtime)!=null?_ref1.length:void 0){this.clientModifiedAt=new Date(Date.parse(metadata.client_mtime))}else{this.clientModifiedAt=null}switch(metadata.root){case"dropbox":this.inAppFolder=false;break;case"app_folder":this.inAppFolder=true;break;default:this.inAppFolder=null}this.size=metadata.bytes||0;this.humanSize=metadata.size||"";this.hasThumbnail=metadata.thumb_exists||false;if(this.isFolder){this.versionTag=metadata.hash;this.mimeType=metadata.mime_type||"inode/directory"}else{this.versionTag=metadata.rev;this.mimeType=metadata.mime_type||"application/octet-stream"}}return Stat}();Dropbox.UserInfo=function(){UserInfo.parse=function(userInfo){if(userInfo&&typeof userInfo==="object"){return new Dropbox.UserInfo(userInfo)}else{return userInfo}};UserInfo.prototype.name=null;UserInfo.prototype.email=null;UserInfo.prototype.countryCode=null;UserInfo.prototype.uid=null;UserInfo.prototype.referralUrl=null;UserInfo.prototype.publicAppUrl=null;UserInfo.prototype.quota=null;UserInfo.prototype.usedQuota=null;UserInfo.prototype.privateBytes=null;UserInfo.prototype.sharedBytes=null;function UserInfo(userInfo){var lastIndex;this.name=userInfo.display_name;this.email=userInfo.email;this.countryCode=userInfo.country||null;this.uid=userInfo.uid.toString();if(userInfo.public_app_url){this.publicAppUrl=userInfo.public_app_url;lastIndex=this.publicAppUrl.length-1;if(lastIndex>=0&&this.publicAppUrl.substring(lastIndex)==="/"){this.publicAppUrl=this.publicAppUrl.substring(0,lastIndex)}}else{this.publicAppUrl=null}this.referralUrl=userInfo.referral_link;this.quota=userInfo.quota_info.quota;this.privateBytes=userInfo.quota_info.normal||0;this.sharedBytes=userInfo.quota_info.shared||0;this.usedQuota=this.privateBytes+this.sharedBytes}return UserInfo}();if(typeof window!=="undefined"&&window!==null){if(window.XDomainRequest&&!("withCredentials"in new XMLHttpRequest)){DropboxXhrRequest=window.XDomainRequest;DropboxXhrIeMode=true;DropboxXhrCanSendForms=false}else{DropboxXhrRequest=window.XMLHttpRequest;DropboxXhrIeMode=false;DropboxXhrCanSendForms=window.navigator.userAgent.indexOf("Firefox")===-1}}else{DropboxXhrRequest=require("xmlhttprequest").XMLHttpRequest;DropboxXhrIeMode=false;DropboxXhrCanSendForms=false}Dropbox.Xhr=function(){function Xhr(){}Xhr.Request=DropboxXhrRequest;Xhr.ieMode=DropboxXhrIeMode;Xhr.canSendForms=DropboxXhrCanSendForms;Xhr.request=function(method,url,params,authHeader,callback){return this.request2(method,url,params,authHeader,null,null,callback)};Xhr.request2=function(method,url,params,authHeader,body,responseType,callback){var headers,paramsInUrl,queryString;paramsInUrl=method==="GET"||body!=null||this.ieMode;if(paramsInUrl){queryString=DropboxXhr.urlEncode(params);if(queryString.length!==0){url=[url,"?",DropboxXhr.urlEncode(params)].join("")}}headers={};if(authHeader){headers["Authorization"]=authHeader}if(body!=null){if(typeof body==="string"){headers["Content-Type"]="text/plain; charset=utf8"}}else if(!paramsInUrl){headers["Content-Type"]="application/x-www-form-urlencoded";body=DropboxXhr.urlEncode(params)}return DropboxXhr.xhrRequest(method,url,headers,body,responseType,callback)};Xhr.multipartRequest=function(url,fileField,params,authHeader,callback){var body,boundary,fileData,fileType,headers,useFormData;url=[url,"?",DropboxXhr.urlEncode(params)].join("");fileData=fileField.value;useFormData=typeof fileData==="object"&&(typeof Blob!=="undefined"&&Blob!==null&&fileField.value instanceof Blob||typeof File!=="undefined"&&File!==null&&fileField.value instanceof File);if(useFormData){headers={};body=new FormData;body.append(fileField.name,fileData,fileField.fileName)}else{fileType=fileField.contentType||"application/octet-stream";boundary=this.multipartBoundary();headers={"Content-Type":"multipart/form-data; boundary="+boundary};body=["--",boundary,"\r\n",'Content-Disposition: form-data; name="',fileField.name,'"; filename="',fileField.fileName,'"\r\n',"Content-Type: ",fileType,"\r\n","Content-Transfer-Encoding: binary\r\n\r\n",fileData,"\r\n","--",boundary,"--","\r\n"].join("")}if(authHeader){headers["Authorization"]=authHeader}return DropboxXhr.xhrRequest("POST",url,headers,body,null,callback)};Xhr.multipartBoundary=function(){return[Date.now().toString(36),Math.random().toString(36)].join("----")};Xhr.xhrRequest=function(method,url,headers,body,responseType,callback){var header,value,xhr;xhr=new this.Request;if(this.ieMode){xhr.onload=function(){return DropboxXhr.onLoad(xhr,method,url,callback)};xhr.onerror=function(){return DropboxXhr.onError(xhr,method,url,callback)}}else{xhr.onreadystatechange=function(){return DropboxXhr.onReadyStateChange(xhr,method,url,responseType,callback)}}xhr.open(method,url,true);if(responseType){if(responseType==="b"){if(xhr.overrideMimeType){xhr.overrideMimeType("text/plain; charset=x-user-defined")}}else{xhr.responseType=responseType}}if(!this.ieMode){for(header in headers){if(!__hasProp.call(headers,header))continue;value=headers[header];xhr.setRequestHeader(header,value)}}if(body!=null){xhr.send(body)}else{xhr.send()}return xhr};Xhr.urlEncode=function(object){var chunks,key,value;chunks=[];for(key in object){value=object[key];chunks.push(this.urlEncodeValue(key)+"="+this.urlEncodeValue(value))}return chunks.sort().join("&")};Xhr.urlEncodeValue=function(object){return encodeURIComponent(object.toString()).replace(/\!/g,"%21").replace(/'/g,"%27").replace(/\(/g,"%28").replace(/\)/g,"%29").replace(/\*/g,"%2A")};Xhr.urlDecode=function(string){var kvp,result,token,_i,_len,_ref;result={};_ref=string.split("&");for(_i=0,_len=_ref.length;_i<_len;_i++){token=_ref[_i];kvp=token.split("=");result[decodeURIComponent(kvp[0])]=decodeURIComponent(kvp[1])}return result};Xhr.onReadyStateChange=function(xhr,method,url,responseType,callback){var apiError,bytes,dirtyText,e,i,metadata,metadataJson,text,_i,_ref;if(xhr.readyState!==4){return true}if(xhr.status<200||xhr.status>=300){apiError=new Dropbox.ApiError(xhr,method,url);callback(apiError);return true}metadataJson=xhr.getResponseHeader("x-dropbox-metadata");if(metadataJson!=null?metadataJson.length:void 0){try{metadata=JSON.parse(metadataJson)}catch(_error){e=_error;metadata=void 0}}else{metadata=void 0}if(responseType){if(responseType==="b"){dirtyText=xhr.responseText!=null?xhr.responseText:xhr.response;bytes=[];for(i=_i=0,_ref=dirtyText.length;0<=_ref?_i<_ref:_i>_ref;i=0<=_ref?++_i:--_i){bytes.push(String.fromCharCode(dirtyText.charCodeAt(i)&255))}text=bytes.join("");callback(null,text,metadata)}else{callback(null,xhr.response,metadata)}return true}text=xhr.responseText!=null?xhr.responseText:xhr.response;switch(xhr.getResponseHeader("Content-Type")){case"application/x-www-form-urlencoded":callback(null,DropboxXhr.urlDecode(text),metadata);break;case"application/json":case"text/javascript":callback(null,JSON.parse(text),metadata);break;default:callback(null,text,metadata)}return true};Xhr.onLoad=function(xhr,method,url,callback){var text;text=xhr.responseText;switch(xhr.contentType){case"application/x-www-form-urlencoded":callback(null,DropboxXhr.urlDecode(text),void 0);break;case"application/json":case"text/javascript":callback(null,JSON.parse(text),void 0);break;default:callback(null,text,void 0)}return true};Xhr.onError=function(xhr,method,url,callback){var apiError;apiError=new Dropbox.ApiError(xhr,method,url);callback(apiError);return true};return Xhr}();DropboxXhr=Dropbox.Xhr;if((typeof module!=="undefined"&&module!==null?module.exports:void 0)!=null){module.exports=Dropbox}else if(typeof window!=="undefined"&&window!==null){window.Dropbox=Dropbox}else{throw new Error("This library only supports node.js and modern browsers.")}Dropbox.atob=atob;Dropbox.btoa=btoa;Dropbox.hmac=base64HmacSha1;Dropbox.sha1=base64Sha1;Dropbox.encodeKey=dropboxEncodeKey;(function(){var $,Auth,Binary,Class,Client,DB,Events,Model,Nimbus,Share,isArray,makeArray,moduleKeywords;if(window.Nimbus==null){Nimbus=winodw.Nimbus={}}Nimbus=window.Nimbus;Nimbus.version="0.0.1";$=Nimbus.$=this.jQuery||this.Zepto||function(){return arguments[0]};Nimbus.dictModel={};makeArray=function(args){return Array.prototype.slice.call(args,0)};isArray=function(value){return Object.prototype.toString.call(value)==="[object Array]"};if(typeof Array.prototype.indexOf==="undefined"){Array.prototype.indexOf=function(value){var i;i=0;while(i<this.length){if(this[i]===value){return i}i++}return-1}}Events={bind:function(ev,callback){var calls,evs,i;evs=ev.split(" ");calls=this._callbacks||(this._callbacks={});i=0;while(i<evs.length){(this._callbacks[evs[i]]||(this._callbacks[evs[i]]=[])).push(callback);i++}return this},trigger:function(){var args,calls,ev,i,l,list;args=makeArray(arguments);ev=args.shift();if(!(calls=this._callbacks)){return false}if(!(list=this._callbacks[ev])){return false}i=0;l=list.length;while(i<l){if(list[i].apply(this,args)===false){return false}i++}return true},unbind:function(ev,callback){var calls,i,l,list;if(!ev){this._callbacks={};return this}if(!(calls=this._callbacks)){return this}if(!(list=calls[ev])){return this}if(!callback){delete this._callbacks[ev];return this}i=0;l=list.length;while(i<l){if(callback===list[i]){list=list.slice();list.splice(i,1);calls[ev]=list;break}i++}return this}};if(typeof Object.create!=="function"){Object.create=function(o){var F;F=function(){};F.prototype=o;return new F}}moduleKeywords=["included","extended"];Class={inherited:function(){},created:function(){},prototype:{initialize:function(){},init:function(){}},create:function(include,extend){var object;object=Object.create(this);object.parent=this;object.prototype=object.fn=Object.create(this.prototype);if(include){object.include(include)}if(extend){object.extend(extend)}object.created();this.inherited(object);return object},init:function(){var instance;instance=Object.create(this.prototype);instance.parent=this;instance.initialize.apply(instance,arguments);instance.init.apply(instance,arguments);return instance},proxy:function(func){var thisObject;thisObject=this;return function(){return func.apply(thisObject,arguments)}},proxyAll:function(){var functions,i,_results;functions=makeArray(arguments);i=0;_results=[];while(i<functions.length){this[functions[i]]=this.proxy(this[functions[i]]);_results.push(i++)}return _results},include:function(obj){var included,key;for(key in obj){if(moduleKeywords.indexOf(key)===-1){this.fn[key]=obj[key]}}included=obj.included;if(included){included.apply(this)}return this},extend:function(obj){var extended,key;for(key in obj){if(moduleKeywords.indexOf(key)===-1){this[key]=obj[key]}}extended=obj.extended;if(extended){extended.apply(this)}return this}};Class.prototype.proxy=Class.proxy;Class.prototype.proxyAll=Class.proxyAll;Class.inst=Class.init;Class.sub=Class.create;Nimbus.guid=function(){var id,verified,verify_guide;verify_guide=function(g_id){var x,y,_ref;_ref=Nimbus.dictModel;for(x in _ref){y=_ref[x];if(y.exists(g_id)){return false}}return true};verified=false;while(!verified){id="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(c){var r,v;r=Math.random()*16|0;v=c==="x"?r:r&3|8;return v.toString(16)}).toUpperCase();verified=verify_guide(id)}return id};Auth=Nimbus.Auth=Class.create();Auth.extend({reinitialize:function(){var sync_service;log("reintialize called");if(localStorage["last_sync_object"]!=null){log("the service exists",localStorage["service"]);sync_service=JSON.parse(localStorage["last_sync_object"]);this.setup(sync_service);return this.initialize()}},setup:function(sync_service){var key,service,value;if(typeof sync_service==="string"){console.log("Current sync service",sync_service);sync_service=JSON.parse(Base64.decode(sync_service))}if(sync_service.service!=null){log("setup called on a service",sync_service.service);log("setup object",sync_service);for(key in sync_service){value=sync_service[key];this[key]=value}localStorage["last_sync_object"]=JSON.stringify(sync_service);switch(this.service){case"Dropbox":this.extend(Nimbus.Auth.Dropbox_auth);this.authorize=this.proxy(this.authenticate_dropbox);this.initialize=this.proxy(this.initialize_dropbox);this.authorized=this.proxy(this.dropbox_authorized);this.logout=this.proxy(this.logout_dropbox);return log("service is dropbox");case"GDrive":this.extend(Nimbus.Auth.GDrive);this.authorize=this.proxy(this.authenticate_gdrive);this.initialize=this.proxy(this.initialize_gdrive);this.authorized=this.proxy(this.gdrive_authorized);this.logout=this.proxy(this.logout_gdrive);log("service is GDrive");return Nimbus.Share.setup(this.service);case"Realtime":return startRealtime(key,app_name);default:return log("Invalid service name")}}else{log("new method for setup, the service is there");this.sync_services=sync_service;this.models={};if(localStorage["service"]!=null){if(localStorage["service"]==="GDrive"){service=this.sync_services["GDrive"];service["service"]="GDrive";this.setup(service)}else{service=this.sync_services["Dropbox"];service["service"]="Dropbox";this.setup(service)}}else{this.extend(Nimbus.Auth.Multi);this.authorize=this.proxy(this.authenticate_service);this.initialize=this.proxy(this.initialize_service)}}},authorized:function(){return log("authorized not yet setup")},state:function(){return localStorage["state"]},authorize:function(){return log("authorize not yet setup")},initialize:function(){return log("initialize not setup")},authorized_callback:function(){return log("authorized callback undefined")},app_ready_func:function(){log("app_ready");return this.app_ready=true},set_app_ready:function(callback){log("set app ready");if(this.app_ready!=null&&this.app_ready){return callback()}else{return this.app_ready_func=callback}},logout:function(){return log("logout not implemented")}});Client=Nimbus.Client=Class.create();Share=Nimbus.Share=Class.create();Share.extend({setup:function(sync_service){switch(sync_service){case"GDrive":log("share api with GDrive");this.extend(Nimbus.Client.GDrive);this.get_users=this.proxy(this.get_shared_users);this.add_user=this.proxy(this.add_share_user);this.remove_user=this.proxy(this.remove_share_user);this.get_me=this.proxy(this.get_current_user);this.get_spaces=this.proxy(this.get_app_folders);this.switch_spaces=this.proxy(this.switch_to_app_folder);return this.switch_file_real=this.proxy(this.switch_to_app_file_real);default:return log("share not supported with this service")}},get_users:function(){return log("users not implemented")},add_user:function(email){return log("add a user")},remove_user:function(id){return log("removed user")},get_me:function(){return log("get currently logged user")},get_spaces:function(){return log("get current spaces")},switch_spaces:function(id){return log("switch space")}});Binary=Nimbus.Binary=Class.create();Binary.extend({setup:function(sync_service){log("binary setup called");switch(sync_service){case"Dropbox":this.extend(Nimbus.Client.Dropbox.Binary);Nimbus.Client.Dropbox.Binary.binary_setup();return log("service is dropbox");case"GDrive":this.extend(Nimbus.Client.GDrive.Binary);Nimbus.Client.GDrive.Binary.binary_setup();return log("service is GDrive");case"Realtime":return log("service is  Realtime");default:return log("Invalid service name")}},upload_blob:function(blob,name,callback){return log("upload blob")},upload_file:function(file,callback){return log("upload blob")},read_file:function(binary,callback){return log("read file")},share_link:function(binary,callback){return log("share link")},direct_link:function(binary,callback){return log("direct link")},delete_file:function(binary){return log("delete file")}});DB=Nimbus.DB=Class.create();DB.extend(Events);DB.extend({setup_db:function(type){log("setup db");switch(type){case"localStorage":return Storage.prototype.setItem=function(key,value){if(this===window.localStorage){return log("local storage called")}else{return _setItem.apply(this,arguments)}}}}});Model=Nimbus.Model=Class.create();Model.extend(Events);Model.extend({loaded:false,check_loaded:function(){if(this.loaded){return true}else{console.log("The model is not loaded yet! Wait for the model to be done with setup.");return false}},service_setup:function(model){var atts;log("service setup model",model);atts=model.attributes;switch(Nimbus.Auth.service){case"Dropbox":log("extend as Dropbox");model.extend(Nimbus.Model.general_sync);model.extend(Nimbus.Model.Dropbox);atts.push("synced");atts.push("time");model.attributes=atts;break;case"GDrive":log("extend as GDrive");model.extend(Nimbus.Model.general_sync);model.extend(Nimbus.Model.Realtime);atts.push("gid");atts.push("synced");atts.push("time");atts.push("type");model.attributes=atts;window.model_initialize(model);break;default:log("Invalid service name")}return model},setup:function(name,atts,callback){var Deletion,model,_this=this;log("model setup");model=Model.sub();if(name){model.name=name}if(atts){model.attributes=atts}Nimbus.dictModel[name]=model;if(Nimbus.Auth.sync_services.synchronous!=null&&Nimbus.Auth.sync_services){model.extend(Nimbus.Model.LocalSync)}else{model.extend(Nimbus.Model.Local)}if(Nimbus.Auth.service!=null||Nimbus.Auth.sync_services!=null||name==="binary"||name==="binary_Deletion"){log("model 1",model);if(name.indexOf("_Deletion")<0){model=this.service_setup(model)}}else{log("name:",name);log("Please setup Nimbus.Auth first before creating models")}if(name.indexOf("_Deletion")<0){Deletion=Nimbus.Model.setup(name+"_"+"Deletion",["deletion_id","listid"]);Deletion.extend(Nimbus.Model.Local);Deletion.fetch();model.DeletionStorage=Deletion}log(model);if(callback!=null){model.fetch(function(){_this.loaded=true;return callback()})}else{model.fetch(function(){return _this.loaded=true})}if(name.indexOf("_Deletion")<0){Nimbus.dictModel[name]=model}else{delete Nimbus.dictModel[name]}return model},created:function(sub){this.records={};return this.attributes=this.attributes?makeArray(this.attributes):[]},find:function(id){var record;record=this.records[id];if(!record){throw"Unknown record"}return record.clone()},exists:function(id){var e;try{return this.find(id)}catch(_error){e=_error;return false}},refresh:function(values){var i,il,record;values=this.fromJSON(values);this.records={};i=0;il=values.length;while(i<il){record=values[i];record.newRecord=false;this.records[record.id]=record;i++}this.trigger("refresh");return this},select:function(callback){var key,result;result=[];for(key in this.records){if(callback(this.records[key])){result.push(this.records[key])}}return this.cloneArray(result)},findByAttribute:function(name,value){var key;for(key in this.records){if(this.records[key][name]===value){return this.records[key].clone()}}},findAllByAttribute:function(name,value){return this.select(function(item){return item[name]===value})},each:function(callback){var key,_results;_results=[];for(key in this.records){_results.push(callback(this.records[key]))}return _results},all:function(){return this.cloneArray(this.recordsValues())},first:function(){var record;record=this.recordsValues()[0];return record&&record.clone()},last:function(){var record,values;values=this.recordsValues();record=values[values.length-1];return record&&record.clone()},count:function(){return this.recordsValues().length},deleteAll:function(){var key,_results;_results=[];for(key in this.records){_results.push(delete this.records[key])}return _results},destroyAll:function(){var key,_results;_results=[];for(key in this.records){_results.push(this.records[key].destroy())}return _results},update:function(id,atts){return this.find(id).updateAttributes(atts)},create:function(atts){var record;record=this.init(atts);return record.save()},destroy:function(id){return this.find(id).destroy()},sync:function(callback){return this.bind("change",callback)},fetch:function(callbackOrParams){if(!this.loaded&&callbackOrParams!=null){this.loadLocal(callbackOrParams)}if(typeof callbackOrParams==="function"){return this.bind("fetch",callbackOrParams)}else{return this.trigger.apply(this,["fetch"].concat(makeArray(arguments)))}},toJSON:function(){return this.recordsValues()},fromJSON:function(objects){var i,results;if(!objects){return}if(typeof objects==="string"){objects=JSON.parse(objects)}if(isArray(objects)){results=[];i=0;while(i<objects.length){results.push(this.init(objects[i]));i++}return results}else{return this.init(objects)}},recordsValues:function(){var key,result;result=[];for(key in this.records){result.push(this.records[key])}return result},cloneArray:function(array){var i,result;result=[];i=0;while(i<array.length){result.push(array[i].clone());i++}return result}});return Model.include({model:true,newRecord:true,init:function(atts){var parent_type;if(atts){this.load(atts)}parent_type=this.parent.name;this.parent=function(){return Nimbus.dictModel[parent_type]};return this.trigger("init",this)},isNew:function(){return this.newRecord},isValid:function(){return!this.validate()},validate:function(){},load:function(atts){var name,_results;_results=[];for(name in atts){_results.push(this[name]=atts[name])}return _results},attributes:function(){var attr,i,result;result={};i=0;while(i<this.parent().attributes.length){attr=this.parent().attributes[i];result[attr]=this[attr];i++}result.id=this.id;return result},eql:function(rec){return rec&&rec.id===this.id&&rec.parent()===this.parent()},save:function(){var error;error=this.validate();if(error){this.trigger("error",this,error);return false}this.trigger("beforeSave",this);if(this.newRecord){this.create()}else{this.update()}this.trigger("save",this);return this},updateAttribute:function(name,value){this[name]=value;return this.save()},updateAttributes:function(atts){this.load(atts);return this.save()},destroy:function(){this.trigger("beforeDestroy",this);delete this.parent().records[this.id];this.destroyed=true;this.trigger("destroy",this);return this.trigger("change",this,"destroy")},dup:function(){var result;result=this.parent().init(this.attributes());result.newRecord=this.newRecord;return result},clone:function(){return Object.create(this)},reload:function(){var original;if(this.newRecord){return this}original=this.parent().find(this.id);this.load(original.attributes());return original},toJSON:function(){return this.attributes()},exists:function(){return this.id&&this.id in this.parent().records},update:function(){var clone,records;this.trigger("beforeUpdate",this);records=this.parent().records;records[this.id].load(this.attributes());clone=records[this.id].clone();this.trigger("update",clone);return this.trigger("change",clone,"update")},create:function(){var clone,records;this.trigger("beforeCreate",this);if(!this.id){this.id=Nimbus.guid()}this.newRecord=false;records=this.parent().records;records[this.id]=this.dup();clone=records[this.id].clone();this.trigger("create",clone);return this.trigger("change",clone,"create")},bind:function(events,callback){return this.parent().bind(events,this.proxy(function(record){if(record&&this.eql(record)){return callback.apply(this,arguments)}}))},trigger:function(){return this.parent().trigger.apply(this.parent(),arguments)}})})();Set=function(){function Set(set){this._set=set===void 0?[]:set;this.length=this._set.length;this.contains=function(element){return this._set.indexOf(element)!==-1}}Set.prototype.union=function(s){var A,B,i,set;A=s.length>this.length?s:this;B=s.length>this.length?this:s;set=A.copy();i=0;while(i<B.length){set.add(B._set[i]);i++}return set};Set.prototype.intersection=function(s){var A,B,element,i,set;set=new Set;A=s.length>this.length?s:this;B=s.length>this.length?this:s;i=0;while(i<B.length){element=B._set[i];if(A.contains(element)){set.add(element)}i++}return set};Set.prototype.difference=function(s){var element,i,set;set=new Set;i=0;while(i<this.length){element=this._set[i];if(!s.contains(element)){set.add(element)}i++}return set};Set.prototype.symmetricDifference=function(s){return this.union(s).difference(this.intersection(s))};Set.prototype.isSuperSet=function(s){var i;i=0;while(i<s.length){if(!this.contains(s._set[i])){return false}i++}return true};Set.prototype.isSubSet=function(s){var i;i=0;while(i<this.length){if(!s.contains(this._set[i])){return false}i++}return true};Set.prototype.add=function(element){if(this._set.indexOf(element)===-1){this._set.push(element);this.length++}return this.length};Set.prototype.remove=function(element){var i;i=this._set.indexOf(element);if(i!==-1){this.length--;return this._set.splice(i,1)[0]}else{return null}};Set.prototype.copy=function(){return new Set(this._set.slice())};Set.prototype.asArray=function(){return this._set};return Set}();exports=this;exports.Set=Set;DelayedOp=function(){function DelayedOp(callback){this.callback=callback;this.ready=__bind(this.ready,this);this.ok=__bind(this.ok,this);this.wait=__bind(this.wait,this);this.count=1}DelayedOp.prototype.wait=function(){return this.count++};DelayedOp.prototype.ok=function(){if(!--this.count){return this.callback()}};DelayedOp.prototype.ready=function(){return this.ok()};return DelayedOp}();OneOp=function(){function OneOp(){this.execute_callback=__bind(this.execute_callback,this);this.add_last_call=__bind(this.add_last_call,this);this.add_call=__bind(this.add_call,this);
this.running=false;this.callbacks=[]}OneOp.prototype.add_call=function(callback){this.running=true;return this.callbacks.push(callback)};OneOp.prototype.add_last_call=function(callback){return this.last_callback=callback};OneOp.prototype.execute_callback=function(){var func,_i,_len,_ref;_ref=this.callbacks;for(_i=0,_len=_ref.length;_i<_len;_i++){func=_ref[_i];func()}this.callbacks=[];if(this.last_callback!=null){this.last_callback()}return this.running=false};return OneOp}();DelayedSyncAnimation=function(){function DelayedSyncAnimation(){this.ready=__bind(this.ready,this);this.ok=__bind(this.ok,this);this.wait=__bind(this.wait,this);this.count=1}DelayedSyncAnimation.prototype.wait=function(){return this.count++};DelayedSyncAnimation.prototype.ok=function(){if(!--this.count){return log("ok executed")}};DelayedSyncAnimation.prototype.ready=function(){return this.ok()};return DelayedSyncAnimation}();exports=this;exports.DelayedOp=DelayedOp;exports.OneOp=OneOp;exports.DelayedSyncAnimation=DelayedSyncAnimation;window.debug=false;window.log=function(){var stuff;stuff=1<=arguments.length?__slice.call(arguments,0):[];if(window.debug){return console.log(stuff)}};window.one_time_sync=false;window.keys=function(item){var key,keys,value;keys=[];for(key in item){value=item[key];keys.push(key)}return keys};Nimbus.Model.general_sync={cloudcache:{},create_object_dictionary:function(){var dict,obj,_i,_len,_ref;dict={};log("object:",this);_ref=this.all();for(_i=0,_len=_ref.length;_i<_len;_i++){obj=_ref[_i];dict[obj.id]=obj}return dict},sync_model_base_algo:function(){var cloud,cloud_set,cloud_time,d_array,deleted_set,dlist,eq,id,local,local_item,local_set,local_time,utc,utl,_i,_j,_k,_l,_len,_len1,_len2,_len3,_ref,_ref1,_ref2,_ref3;if(!navigator.onLine||this.is_cloud_available===false){return}log("#ONE TIME SYNC ALGO RUNNING",this.name);window.one_time_sync=true;window.currently_syncing=true;local=this.create_object_dictionary();cloud=this.cloudcache;local_set=new Set(keys(local));cloud_set=new Set(keys(cloud));log("local_set",local_set);log("cloud_set",cloud_set);d_array=[];_ref=this.DeletionStorage.all();for(_i=0,_len=_ref.length;_i<_len;_i++){dlist=_ref[_i];this.delete_from_cloud(dlist.id);d_array.push(dlist.id);dlist.destroy()}deleted_set=new Set(d_array);log("deleted set",deleted_set);log("#the set of ids that are there locally but not there on the cloud",local_set.difference(cloud_set)._set);_ref1=local_set.difference(cloud_set)._set;for(_j=0,_len1=_ref1.length;_j<_len1;_j++){id=_ref1[_j];local_item=local[id];if(local_item["synced"]!=null&&local_item.synced){log("id for deletion",id);local[id].destroy()}else{this.add_to_cloud(local_item)}}log("#the set of ids that are there on the cloud but not there locally minus deletions",cloud_set.difference(local_set).difference(deleted_set)._set);_ref2=cloud_set.difference(local_set).difference(deleted_set)._set;for(_k=0,_len2=_ref2.length;_k<_len2;_k++){id=_ref2[_k];this.add_from_cloud(id)}log("#the set of ids that are there in the cloud and locally",cloud_set.intersection(local_set)._set);utc=[];utl=[];eq=[];_ref3=cloud_set.intersection(local_set)._set;for(_l=0,_len3=_ref3.length;_l<_len3;_l++){id=_ref3[_l];local_time=new Date(local[id].time);cloud_time=new Date(cloud[id].time);log("local_time",local_time.toString());log("cloud_time",cloud_time.toString());if(local_time-cloud_time===0){log("equal time stamp do nothin",cloud[id].title);eq.push(id)}else if(local_time-cloud_time>0){this.update_to_cloud(local[id]);utc.push(id)}else{this.update_to_local(local[id]);utl.push(id)}}window.currently_syncing=false;window.one_time_sync=false;log("updated to cloud",utc.length,utc);log("updated to local",utl.length,utl);return log("equal timestamp",eq.length,eq)},real_time_sync:function(record,method,e){var d,syncable;log("method",method);log("record",record);this.saveLocal(record,method);if(window.currently_syncing){return true}else{if(method==="update"){this.records[record.id].time=(new Date).toString()}}syncable=navigator.onLine&&(localStorage["state"]==="Working"||Nimbus.Client.GDrive.check_auth());if(!syncable){console.log("syncing is not setup correctly or the instance is not online");return true}switch(method){case"destroy":if(record.synced){if(syncable){log("deletion in cloud");return this.delete_from_cloud(record.id)}else{d=Deletion.init({id:record.id});return d.save()}}break;case"create":return this.add_to_cloud(record,function(){});case"update":return this.update_to_cloud(record,function(){});case"read":return this.update_to_local(record,function(){});default:return log("REAL TIME SYNCING FAILED, THIS METHOD NOT IMPLEMENTED")}},delta_update:function(){var change;return change=this.get_delta}};Nimbus.Model.Local={classname:"Nimbus.Model.Local",extended:function(){this.sync(this.proxy(this.saveLocal));return this.fetch(this.proxy(this.loadLocal))},saveLocal:function(record,method){var db,result,self,_data,_i,_len,_ref;if(!window._indexdb&&Nimbus.Auth.app_name){window._indexdb=new PouchDB(Nimbus.Auth.app_name)}if(!window._indexdb){result=JSON.stringify(this);localStorage[this.name]=result;return}db=window._indexdb;self=this;if(record){_data={_id:record.id,type:this.name,data:JSON.stringify(record)};db.get(record.id,function(err,res){if(!err){return db.remove(res,function(e,r){if(method==="destroy"){return}return db.put(_data)})}else{return db.put(_data)}})}else{_ref=this.records;for(_i=0,_len=_ref.length;_i<_len;_i++){record=_ref[_i];_data={_id:key,type:this.name,data:JSON.stringify(record)};db.get(key,function(err,res){if(!err){_data._rev=res._rev}return db.put(_data)})}}},loadLocal:function(callback){var db,result,self;if(!window._indexdb&&Nimbus.Auth.app_name){window._indexdb=new PouchDB(Nimbus.Auth.app_name)}if(!window._indexdb){result=localStorage[this.name];if(!result){return}result=JSON.parse(result);this.refresh(result);return}self=this;db=window._indexdb;db.allDocs({include_docs:true},function(err,response){var doc,one,rows,_i,_len;if(!err){rows=response.rows;result=[];for(_i=0,_len=rows.length;_i<_len;_i++){one=rows[_i];doc=one.doc;if(doc["type"]===self.name){result.push(JSON.parse(doc.data))}}self.refresh(result);if(callback!=null){return callback()}}})}};Nimbus.Model.LocalSync={classname:"Nimbus.Model.LocalSync",extended:function(){this.sync(this.proxy(this.saveLocal));return this.fetch(this.proxy(this.loadLocal))},saveLocal:function(){var result;result=JSON.stringify(this);return localStorage[this.name]=result},loadLocal:function(callback){var result;result=localStorage[this.name];if(!result){return}result=JSON.parse(result);this.refresh(result);if(callback!=null){return callback()}}};Nimbus.Model.Dropbox={cloudcache:{},last_hash:"",hash:"",toCloudStructure:function(object){log("local to cloud structure");return JSON.stringify(object)},fromCloudStructure:function(value){log("changes cloud to local data in the form a dictionary");return value},diff_objects:function(previous,current){var diff,f,v;diff={};for(f in previous){v=previous[f];if(current[f]!==previous[f]){diff[f]=[current[f],previous[f]]}}if(previous["parent_id"]!=null!==(current["parent_id"]!=null)){diff["parent_id"]=["one of them is null"]}return diff},add_to_cloud:function(object,callback){log("add to cloud",object.name);return Nimbus.Client.Dropbox.putFileContents("/"+Nimbus.Auth.app_name+("/"+this.name+"/"+object.id+".txt"),this.toCloudStructure(object),function(resp){log(object.name,"finished being added to cloud");log("resp",resp);window.currently_syncing=true;object.time=resp.modified;object.synced=true;object.save();window.currently_syncing=false;if(callback!=null){return callback(resp)}})},delete_from_cloud:function(object_id,callback){log("delete from cloud",object_id);log("delete route","/"+Nimbus.Auth.app_name+("/"+this.name+"/"+object_id+".txt"));return Nimbus.Client.Dropbox.deletePath("/"+Nimbus.Auth.app_name+("/"+this.name+"/"+object_id+".txt"),function(){log("finished delete from cloud",object_id);if(callback!=null){return callback()}})},update_to_cloud:function(object,callback){log("updated to cloud",object.name);return Nimbus.Client.Dropbox.putFileContents("/"+Nimbus.Auth.app_name+("/"+this.name+"/"+object.id+".txt"),this.toCloudStructure(object),function(resp){log(object.name,"finished being updated to cloud");window.currently_syncing=true;object.time=resp.modified;object.synced=true;object.save();window.currently_syncing=false;if(callback!=null){return callback(resp)}})},add_from_cloud:function(object_id,callback){var _this=this;log("add from cloud",object_id);return Nimbus.Client.Dropbox.getFileContents("/"+Nimbus.Auth.app_name+("/"+this.name+"/"+object_id+".txt"),function(data){var converted,x;log("cloud read data",data);window.currently_syncing=true;converted=_this.fromCloudStructure(data);x=_this.init(converted);x.synced=true;x.time=_this.cloudcache[object_id].time;x.save();window.currently_syncing=false;if(callback!=null){return callback(data)}})},update_to_local:function(object,callback){var _this=this;log("update to local",object.name);return Nimbus.Client.Dropbox.getFileContents("/"+Nimbus.Auth.app_name+("/"+this.name+"/"+object.id+".txt"),function(data){var converted,x;log("cloud read data",data);window.currently_syncing=true;converted=_this.fromCloudStructure(data);x=_this.find(object.id);converted.time=_this.cloudcache[object.id].time;x.updateAttributes(converted);return window.currently_syncing=false})},sync_all:function(cb){var _this=this;log("syncs all the data, normally happens at the start of a program or coming back from offline");window.current_syncing=new DelayedOp(function(){log("call back sync called");window.current_syncing=new DelayedOp(function(){window.current_syncing=null;if(cb!=null){return cb()}});_this.sync_model_base_algo();return window.current_syncing.ready()});this.load_all_from_cloud();return window.current_syncing.ready()},load_all_from_cloud:function(){var error,_this=this;log("loads all the data from the cloud locally, probably not feasible with dropbox and changes need to happen");this.cloudcache={};try{return Nimbus.Client.Dropbox.getMetadataList("/"+Nimbus.Auth.app_name+"/"+this.name,function(data){var id,title,x,_i,_len,_ref;log("call back load called");log("data",data);_ref=data.contents;for(_i=0,_len=_ref.length;_i<_len;_i++){x=_ref[_i];title=x.path;id=title.replace("/"+Nimbus.Auth.app_name+"/"+(""+_this.name+"/"),"").replace(".txt","");_this.cloudcache[id]={id:id,time:x.modified}}return _this.is_cloud_available=true},function(error){console.log("ERROR: error called for metadataList, folder should be created");_this.is_cloud_available=false;Nimbus.Client.Dropbox.createFolder("/"+Nimbus.Auth.app_name+"/"+_this.name,function(data){return log("call back create folder called",data)});return _this.cloudcache={}})}catch(_error){error=_error;_this.is_cloud_available=false;return log("trying to get the folder failed, probably cuz it don't exist",error)}},get_delta:function(){return log("get the delta for ",this.name," since last synced")},extended:function(){this.sync(this.proxy(this.real_time_sync));return this.fetch(this.proxy(this.loadLocal))}};Nimbus.Auth.Dropbox_auth={authenticate_dropbox:function(){localStorage["key"]=this.key;localStorage["secret"]=this.secret;localStorage["state"]="Auth";return Nimbus.Client.Dropbox.get_request_token(this.key,this.secret,Nimbus.Client.Dropbox.authorize_token)},initialize_dropbox:function(){log("initialization called");if(location.protocol==="chrome-extension:"){log("Chrome edition authentication");chrome.tabs.onUpdated.addListener(function(tabId,changeInfo,tab){if(tab.title==="API Request Authorized"){chrome.tabs.remove(tabId);return Nimbus.Client.Dropbox.get_access_token(function(data){localStorage["state"]="Working";if(Nimbus.Auth.authorized_callback!=null){Nimbus.Auth.authorized_callback()}Nimbus.Auth.app_ready_func();console.log("NimbusBase is working! Chrome edition.");return Nimbus.track.google.registered_user()})}})}if(localStorage["state"]!=null&&localStorage["state"]==="Auth"){return Nimbus.Client.Dropbox.get_access_token(function(data){localStorage["state"]="Working";if(Nimbus.Auth.authorized_callback!=null){Nimbus.Auth.authorized_callback()}Nimbus.Auth.app_ready_func();console.log("NimbusBase is working!");return Nimbus.track.google.registered_user()})}else{return Nimbus.Auth.app_ready_func()}},dropbox_authorized:function(){if(Nimbus.Auth.service==="Dropbox"){if(localStorage["state"]==="Working"){return true}else{return false}}else{return false}},logout_dropbox:function(callback){var k,v,_ref;localStorage.clear();if(Nimbus.dictModel!=null){_ref=Nimbus.dictModel;for(k in _ref){v=_ref[k];v.records={}}}if(this.sync_services!=null){Nimbus.Auth.setup(this.sync_services)}if(callback!=null){return callback()}}};REALTIME_MIMETYPE="application/vnd.google-apps.drive-sdk";Nimbus.Model.Realtime={cloudcache:{},toCloudStructure:function(object){log("local to cloud structure");object["type"]=this.name;return JSON.stringify(object)},fromCloudStructure:function(value){log("changes cloud to local data in the form a dictionary");return JSON.parse(value)},diff_objects:function(previous,current){var diff,f,v;diff={};for(f in previous){v=previous[f];if(current[f]!==previous[f]){diff[f]=[current[f],previous[f]]}}if(previous["parent_id"]!=null!==(current["parent_id"]!=null)){diff["parent_id"]=["one of them is null"]}return diff},add_to_cloud:function(object,callback){var content;log("add to cloud",object);window.currently_syncing=true;object.time=(new Date).toString();object.type=this.name;object.synced=true;object.save();window.currently_syncing=false;content=this.toCloudStructure(object);return window.todo.set(object.id,content)},delete_from_cloud:function(object_id,callback){log("delete from cloud",object_id,window.todo.has(object_id));if(window.todo.has(object_id)){return window.todo["delete"](object_id)}},update_to_cloud:function(object,callback){var content;log("updated to cloud",object.id);content=this.toCloudStructure(object);return window.todo.set(object.id,content)},add_from_cloud:function(object_id,callback){var converted,data,x;log("add from cloud GDrive",object_id);data=window.todo.get(object_id);window.currently_syncing=true;converted=this.fromCloudStructure(data);x=this.init(converted);x.synced=true;x.save();return window.currently_syncing=false},update_to_local:function(object,callback){var converted,data,x;log("update to local",object);data=window.todo.get(object.id);window.currently_syncing=true;converted=this.fromCloudStructure(data);x=this.init(converted);x.synced=true;x.save();return window.currently_syncing=false},sync_all:function(cb){var _this=this;log("syncs all the data, normally happens at the start of a program or coming back from offline");this.load_all_from_cloud();this.sync_model_base_algo();window.current_syncing=new DelayedOp(function(){log("call back sync called");window.current_syncing=new DelayedOp(function(){window.current_syncing=null;if(cb!=null){return cb()}});_this.sync_model_base_algo();return window.current_syncing.ready()});this.load_all_from_cloud();return window.current_syncing.ready()},load_all_from_cloud:function(){var content,x,_i,_len,_ref,_results;log("loads all the data from the cloud locally");this.cloudcache={};_ref=window.todo.keys();_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){x=_ref[_i];content=this.fromCloudStructure(window.todo.get(x));if(content.type===this.name){_results.push(this.cloudcache[x]=content)}else{_results.push(void 0)}}return _results},get_delta:function(){return log("get the delta for ",this.name," since last synced")},extended:function(){this.sync(this.proxy(this.real_time_sync));return this.fetch(this.proxy(this.loadLocal))}};window.initializeModel=function(model){var field;log("model initialization",model);field=model.createMap({});return model.getRoot().set("todo",field)};window.onFileLoaded=function(doc){var process_event,todo;log("file loaded",doc);window.doc=doc;process_event=function(event){var a,current_event,model,obj;log("PROCESS EVENT");log(event);current_event="NONE";if(event.oldValue!=null){obj=JSON.parse(event.oldValue)}if(event.newValue!=null){obj=JSON.parse(event.newValue)}log("object",obj);window.obj=obj;model=Nimbus.dictModel[obj.type];if(event.oldValue===null){log("add event");model.add_from_cloud(obj.id);current_event="CREATE"}else if(event.newValue===null){log("delete event");window.currently_syncing=true;if(model.exists(obj.id)){a=model.find(obj.id);a.destroy()}window.currently_syncing=false;current_event="DELETE"}else{log("changing the data inside a entry event");model.update_to_local(obj);current_event="UPDATE"}log("EVENT: ",current_event," OBJ: ",obj);if(window.realtime_update_handler!=null){return window.realtime_update_handler(current_event,obj,event.isLocal)}};todo=doc.getModel().getRoot().get("todo");window.todo=todo;if(window.real_time_callback!=null){window.real_time_callback()}return todo.addEventListener(gapi.drive.realtime.EventType.VALUE_CHANGED,process_event)};window.create_share_client=function(){var share_client;share_client=new gapi.drive.share.ShareClient(Nimbus.Auth.app_id);share_client.setItemIds(c_file.id);share_client.showSettingsDialog();return window.share_client=share_client};window.handleErrors=handleErrors=function(e){if(e.type===gapi.drive.realtime.ErrorType.TOKEN_REFRESH_REQUIRED){return authorizer.authorize()}else if(e.type===gapi.drive.realtime.ErrorType.CLIENT_ERROR){return alert("An Error happened: "+e.message)}else if(e.type===gapi.drive.realtime.ErrorType.NOT_FOUND){return alert("The file was not found. It does not exist or you do not have read access to the file.")}};window.startRealtime=function(callback){if(callback!=null){window.real_time_callback=callback}return gapi.load("auth:client,drive-realtime,drive-share",function(){log("gapi for everything loaded");return Nimbus.Client.GDrive.getMetadataList("title = '"+Nimbus.Auth.app_name+"'",function(data){var c_file,i,x,_i,_len,_ref;console.log("drive apps",data);window.app_files=data.items;i=[];_ref=data.items;for(_i=0,_len=_ref.length;_i<_len;_i++){x=_ref[_i];log(x.mimeType);if(x.mimeType.indexOf("application/vnd.google-apps.drive-sdk")>=0){i.push(x)}}log("index",i);if(i.length>0){log("file there");c_file=i[0];window.c_file=c_file;return gapi.drive.realtime.load(c_file.id,onFileLoaded,initializeModel,handleErrors)}else{log("file not there");Nimbus.Client.GDrive.insertFile("",Nimbus.Auth.app_name,"application/vnd.google-apps.drive-sdk",null,function(data){log("finished insertFile",data);window.c_file=data;return gapi.drive.realtime.load(data.id,onFileLoaded,initializeModel,handleErrors)});return log("need to create file for app")}})})};window.load_new_file=function(file_id,callback,exception_handle){if(callback!=null){window.real_time_callback=callback}return Nimbus.Share.getFile(file_id,function(data){window.c_file=data;if(!data.id){return}if(exception_handle&&exception_handle instanceof Function){return gapi.drive.realtime.load(file_id,onFileLoaded,initializeModel,exception_handle)}else{return gapi.drive.realtime.load(file_id,onFileLoaded,initializeModel,handleErrors)}})};Nimbus.Client.Dropbox={get_request_token:function(key,secret,callback){var header,xhr;xhr=new XMLHttpRequest;xhr.open("POST","https://api.dropbox.com/1/oauth/request_token",true);header='OAuth oauth_version="1.0",oauth_signature_method="PLAINTEXT",oauth_consumer_key="'+key+'",oauth_signature="'+secret+'&"';log(header);xhr.setRequestHeader("Authorization",header);xhr.onreadystatechange=function(){var data,i,k,pair,pairs,request_token,result,v,_i,_len;if(this.readyState===4){if(this.status===200){data=this.response;log(data);pairs=data.split(/&/);request_token={};for(_i=0,_len=pairs.length;_i<_len;_i++){i=pairs[_i];pair=i.split(RegExp("="),2);request_token[pair[0]]=pair[1]}log("Token result",request_token);for(k in request_token){v=request_token[k];localStorage[k]=v}window.request_token=request_token;if(callback!=null){return callback(request_token)}}else{try{result=JSON.parse(result)}catch(_error){}return error(result,this.status,this)}}};return xhr.send()},authorize_token:function(request_token){var auth_url,ref,return_url;log("authorize url",document.URL);if(document.URL.slice(0,4)==="file"&&(typeof cordova!=="undefined"&&cordova!==null)){log("Phonegap login");auth_url="https://www.dropbox.com/1/oauth/authorize?oauth_token="+request_token.oauth_token;ref=window.open(auth_url,"_blank","location=yes");window.ref=ref;window.auth_count=0;ref.addEventListener("loadstop",function(event){console.log(event);console.log("event",event.url.indexOf("https://www.dropbox.com/1/oauth/authorize"));if(event.url.indexOf("https://www.dropbox.com/1/oauth/authorize")>=0){window.auth_count=window.auth_count+1;if(window.auth_count===2){Nimbus.Auth.Dropbox_auth.initialize_dropbox();return window.ref.close()}}});return ref.addEventListener("exit",function(event){return Nimbus.Auth.logout_dropbox()})}else if(document.URL.slice(0,4)==="http"){return_url="&oauth_callback="+encodeURIComponent(document.URL);auth_url="https://www.dropbox.com/1/oauth/authorize?oauth_token="+request_token.oauth_token+return_url;return location.replace(auth_url)}else if(document.URL.slice(0,6)==="chrome"){log("chrome app!");auth_url="https://www.dropbox.com/1/oauth/authorize?oauth_token="+request_token.oauth_token;return chrome.tabs.create({url:auth_url,selected:true},function(tab){return log("tab created",tab.id)})}else{auth_url="https://www.dropbox.com/1/oauth/authorize?oauth_token="+request_token.oauth_token;return location.replace(auth_url)}},get_access_token:function(callback){var auth_string,oauth_token,oauth_token_secret,xhr;oauth_token=localStorage["oauth_token"];oauth_token_secret=localStorage["oauth_token_secret"];auth_string='OAuth oauth_version="1.0",oauth_signature_method="PLAINTEXT",oauth_consumer_key="'+Nimbus.Auth.key+'",oauth_token="'+oauth_token+'",oauth_signature="'+Nimbus.Auth.secret+"&"+oauth_token_secret+'"';log("auth_string:",auth_string);xhr=new XMLHttpRequest;xhr.open("POST","https://api.dropbox.com/1/oauth/access_token",true);xhr.setRequestHeader("Authorization",auth_string);xhr.onreadystatechange=function(){var access_token,data,i,k,pair,pairs,result,v,_i,_len;if(this.readyState===4){if(this.status===200){data=this.response;log(data);pairs=data.split(/&/);access_token={};for(_i=0,_len=pairs.length;_i<_len;_i++){i=pairs[_i];pair=i.split(RegExp("="),2);access_token[pair[0]]=pair[1]}log("Access result",access_token);for(k in access_token){v=access_token[k];localStorage[k]=v}window.access_token=access_token;if(callback!=null){return callback(access_token)}}else{try{result=JSON.parse(result)}catch(_error){}return log(result,this.status,this)}}};return xhr.send()},send_request:function(method,url,body,success,failure){var auth_string,key,oauth_token,oauth_token_secret,pList,xhr;oauth_token=localStorage["oauth_token"];oauth_token_secret=localStorage["oauth_token_secret"];auth_string='OAuth oauth_version="1.0",oauth_signature_method="PLAINTEXT",oauth_consumer_key="'+Nimbus.Auth.key+'",oauth_token="'+oauth_token+'",oauth_signature="'+Nimbus.Auth.secret+"&"+oauth_token_secret+'"';log("auth_string:",auth_string);xhr=new XMLHttpRequest;xhr.open(method,url,true);xhr.setRequestHeader("Authorization",auth_string);xhr.onreadystatechange=function(){var result;if(this.readyState===4){if(this.status===200){result=this.response;try{result=JSON.parse(result)}catch(_error){}log("REQUEST RESULT",result);if(success!=null){success(result)}}else{try{result=JSON.parse(result)}catch(_error){}log(result,this.status,this);if(failure!=null){failure(result)}}if(window.current_syncing!=null){return window.current_syncing.ok()}}};if(method==="POST"){xhr.setRequestHeader("Content-Type","application/x-www-form-urlencoded");if(body){pList=[];for(key in body){pList.push(encodeURIComponent(key)+"="+encodeURIComponent(body[key]))}body=pList.length>0?pList.join("&").replace(/%20/g,"+"):null}log(body)}log("send request params",method,url,body,success,failure);if(window.current_syncing!=null){window.current_syncing.wait()}xhr.send(body);return window.xhr=xhr},send_request_without_delay:function(method,url,body,success,failure){var auth_string,key,oauth_token,oauth_token_secret,pList,xhr;oauth_token=localStorage["oauth_token"];oauth_token_secret=localStorage["oauth_token_secret"];auth_string='OAuth oauth_version="1.0",oauth_signature_method="PLAINTEXT",oauth_consumer_key="'+Nimbus.Auth.key+'",oauth_token="'+oauth_token+'",oauth_signature="'+Nimbus.Auth.secret+"&"+oauth_token_secret+'"';log("auth_string:",auth_string);xhr=new XMLHttpRequest;xhr.open(method,url,true);xhr.setRequestHeader("Authorization",auth_string);xhr.onreadystatechange=function(){var result;if(this.readyState===4){if(this.status===200){result=this.response;try{result=JSON.parse(result)}catch(_error){}log("REQUEST RESULT",result);if(success!=null){return success(result)}}else{try{result=JSON.parse(result)}catch(_error){}log(result,this.status,this);if(failure!=null){return failure(result)}}}};if(method==="POST"){xhr.setRequestHeader("Content-Type","application/x-www-form-urlencoded");if(body){pList=[];for(key in body){pList.push(encodeURIComponent(key)+"="+encodeURIComponent(body[key]))}body=pList.length>0?pList.join("&").replace(/%20/g,"+"):null}log(body)}log("send request params",method,url,body,success,failure);return xhr.send(body)},putFileContents:function(path,content,success,error){log("putFileContents");return Nimbus.Client.Dropbox.send_request("PUT","https://api-content.dropbox.com/1/files_put/sandbox"+path,content,success,error)},createFolder:function(path,success,error){log("createFolder");return Nimbus.Client.Dropbox.send_request("POST","https://api.dropbox.com/1/fileops/create_folder",{root:"sandbox",path:path},success,error)},deletePath:function(path,success,error){log("deletePath");return Nimbus.Client.Dropbox.send_request("POST","https://api.dropbox.com/1/fileops/delete",{root:"sandbox",path:path},success,error)},getFileContents:function(path,success,error){log("getFileContents");return Nimbus.Client.Dropbox.send_request("GET","https://api-content.dropbox.com/1/files/sandbox"+path,"",success,error)},getMetadataList:function(path,success,error){log("getMetadataList");return Nimbus.Client.Dropbox.send_request("GET","https://api.dropbox.com/1/metadata/sandbox"+path,"",success,error)},getAccountInfo:function(success,error){log("getAccountInfo");return Nimbus.Client.Dropbox.send_request_without_delay("GET","https://api.dropbox.com/1/account/info","",success,error)}};window.client=null;Nimbus.Client.Dropbox.Binary={binary_setup:function(){return window.binary=Nimbus.Model.setup("binary",["name","path","copied","directlink","sharelink","expiration"])},initialize_client:function(){log("initializing second client");if(Nimbus.Auth.key!=null){if(window.client==null){window.client=new Dropbox.Client({key:Nimbus.Auth.key,secret:Nimbus.Auth.secret,sandbox:true});return window.client.oauth.setToken(localStorage["oauth_token"],localStorage["oauth_token_secret"])}else{}}else{return log("can't upload file with no dropbox credentials")}},upload_blob:function(blob,name,callback){var come_back,new_file;log("upload new blob");Nimbus.Client.Dropbox.Binary.initialize_client();if(window.client!=null){new_file=binary.create({name:name,copied:false});come_back=function(error,stat){console.log("wrote file to cloud");console.log(error,stat);new_file.copied=true;new_file.path=stat.path;new_file.save();if(callback!=null){return callback(new_file)}};log("file name",name);return window.client.writeFile(name,blob,come_back)}else{return log("client won't initialize")}},upload_file:function(file,callback){var come_back,new_file;log("upload new file");Nimbus.Client.Dropbox.Binary.initialize_client();if(window.client!=null){new_file=binary.create({name:file.name,copied:false});come_back=function(error,stat){console.log("wrote file to cloud");console.log(error,stat);new_file.copied=true;new_file.path=stat.path;new_file.save();if(callback!=null){return callback(new_file)}};log("file name",file.name);return window.client.writeFile(file.name,file,come_back)}else{return log("client won't initialize")}},read_file:function(binary,callback){var come_back;log("read a binary file from the server");Nimbus.Client.Dropbox.Binary.initialize_client();if(window.client!=null){come_back=function(error,data,stat){console.log(error,data,stat);return callback(data)};return window.client.readFile(binary.path,{blob:true},come_back)}else{return log("client won't initialize")}},share_link:function(binary,callback){var come_back;log("get the share link");Nimbus.Client.Dropbox.Binary.initialize_client();if(window.client!=null){come_back=function(error,data){console.log(error,data);binary.sharelink=data.url;binary.save();return callback(data)};console.log(binary.path);return window.client.makeUrl(binary.path,{},come_back)}},direct_link:function(binary,callback){var come_back;log("get the share link");Nimbus.Client.Dropbox.Binary.initialize_client();if(window.client!=null){if(binary.directlink!=null&&new Date(binary.expiration)>new Date){return callback({url:binary.directlink,expiresAt:binary.expiration})}else{come_back=function(error,url){console.log(error,url);binary.directlink=url.url;binary.expiration=url.expiresAt.toString();binary.save();return callback(url)};return window.client.makeUrl(binary.path,{download:true,downloadHack:true},come_back)}}},delete_file:function(binary){var come_back;log("delete file");Nimbus.Client.Dropbox.Binary.initialize_client();if(window.client!=null){come_back=function(error,stat){return binary.destroy()};return window.client.remove(binary.path,come_back)}else{return log("client won't initialize")}}};Nimbus.Client.GDrive={check_auth:function(){var token;log("checking if this is authenticated");if(location.protocol==="chrome-extension:"){if(typeof gapi!=="undefined"&&gapi!==null&&gapi.auth!=null&&gapi.auth.getToken()===null&&window.todo!=null){token=Nimbus.Auth.GDrive.getLocalOauth2Token();if(token==null||Nimbus.Auth.GDrive.isTokenExpires(token)){return false}else{gapi.auth.setToken(token);return true}}}return typeof gapi!=="undefined"&&gapi!==null&&gapi.auth!=null&&gapi.auth.getToken()!==null&&Object.keys(gapi.auth.getToken()).length!==0&&window.todo!=null},authorize:function(client_id,scopes,callback){log("authorized called");return gapi.auth.authorize({client_id:client_id,scope:scopes,immediate:false},callback)},insertFile:function(content,title,contentType,parent,callback){var base64Data,boundary,close_delim,delimiter,metadata,multipartRequestBody,params;log("putFileContents");boundary="-------314159265358979323846";delimiter="\r\n--"+boundary+"\r\n";close_delim="\r\n--"+boundary+"--";base64Data=btoa(content);metadata={title:title,mimeType:contentType};if(parent!=null){metadata["parents"]=[{kind:"drive#fileLink",id:parent}]}multipartRequestBody=delimiter+"Content-Type: application/json\r\n\r\n"+JSON.stringify(metadata)+delimiter+"Content-Type: "+contentType+"\r\n"+"Content-Transfer-Encoding: base64\r\n"+"\r\n"+base64Data+close_delim;log("MULTI: ",multipartRequestBody);if(!callback){callback=function(file){return log("Update Complete ",file)}}params={path:"/upload/drive/v2/files",method:"POST",params:{uploadType:"multipart"},headers:{"Content-Type":'multipart/mixed; boundary="'+boundary+'"'},body:multipartRequestBody};return this.make_request(params,callback)},deleteFile:function(file_id,callback){var params,_this=this;log("deletePath");if(!callback){callback=function(resp){var params;params={path:"/drive/v2/files/"+file_id,method:"DELETE"};_this.make_request(params,function(data){return log("delete complete",data)});return log("Delete Complete ",resp)}}params={path:"/drive/v2/files/"+file_id+"/trash",method:"POST"};return this.make_request(params,callback)},getFile:function(file_id,callback){var params;log("getFileContents");if(!callback){callback=function(resp){return log("Read Complete ",resp)}}params={path:"/drive/v2/files/"+file_id,method:"GET"};return this.make_request(params,callback)
},readFile:function(url,callback){var accessToken,xhr;if(!callback){callback=function(resp){return log("Read Complete ",resp)}}accessToken=gapi.auth.getToken().access_token;xhr=new XMLHttpRequest;xhr.open("GET",url);xhr.setRequestHeader("Authorization","Bearer "+accessToken);xhr.onload=function(){callback(xhr.responseText);if(window.current_syncing!=null){return window.current_syncing.ok()}};xhr.onerror=function(){return callback(null)};if(window.current_syncing!=null){window.current_syncing.wait()}return xhr.send()},updateFile:function(content,title,contentType,file_id,folder_id,callback){var base64Data,boundary,close_delim,delimiter,metadata,multipartRequestBody,params;log("updateFileContents");boundary="-------314159265358979323846";delimiter="\r\n--"+boundary+"\r\n";close_delim="\r\n--"+boundary+"--";contentType="text/html";metadata={mimeType:contentType};base64Data=btoa(content);metadata={title:title,mimeType:contentType};multipartRequestBody=delimiter+"Content-Type: application/json\r\n\r\n"+JSON.stringify(metadata)+delimiter+"Content-Type: "+contentType+"\r\n"+"Content-Transfer-Encoding: base64\r\n"+"\r\n"+base64Data+close_delim;if(!callback){callback=function(file){return log("Update Complete ",file)}}params={path:"/upload/drive/v2/files/"+file_id,method:"PUT",params:{fileId:file_id,uploadType:"multipart"},headers:{"Content-Type":'multipart/mixed; boundary="'+boundary+'"'},body:multipartRequestBody};return this.make_request(params,callback)},getMetadataList:function(query,callback){var params;log("getMetadataList");if(!callback){callback=function(file){return log("List of files",file)}}params={path:"/drive/v2/files",method:"GET",params:{q:query}};return this.make_request(params,callback)},make_request:function(params,callback){params["callback"]=function(data){if(callback!=null){callback(data)}if(window.current_syncing!=null){return window.current_syncing.ok()}};if(window.current_syncing!=null){window.current_syncing.wait()}return gapi.client.request(params)},get_current_user:function(callback){var params,process,_this=this;log("get current user");process=function(file){var user;log("About called ",file);user={};user.name=file["user"].displayName;user.id=file["user"].permissionId;if(file["user"].picture!=null){user.pic=file["user"].picture.url}if(callback!=null){return callback(user)}};params={path:"/drive/v2/about",method:"GET"};return this.make_request(params,process)},add_share_user:function(email,callback){var app_folder_id,params,process,_this=this;log("&&& add share user");process=function(person){var p;log("Add Share user Complete ",person);p={id:person.id,name:person.name,role:person.role};if(person.photoLink!=null){p["pic"]=person.photoLink}if(callback!=null){return callback(p)}};app_folder_id=window.folder[Nimbus.Auth.app_name].id;params={path:"/drive/v2/files/"+app_folder_id+"/permissions",method:"POST",params:{fileId:app_folder_id},body:{role:"writer",type:"user",value:email}};return this.make_request(params,process)},add_share_user_real:function(email,callback,file_id){var fid,params,process,_this=this;log("&&& add share user");fid=file_id?file_id:window.c_file.id;process=function(person){var p;log("Add Share user Complete ",person);p={id:person.id,name:person.name,role:person.role};if(person.photoLink!=null){p["pic"]=person.photoLink}if(callback!=null){return callback(p)}};params={path:"/drive/v2/files/"+fid+"/permissions",method:"POST",params:{fileId:fid},body:{role:"writer",type:"user",value:email}};return this.make_request(params,process)},remove_share_user:function(id,callback){var app_folder_id,params;log("&&& remove a user from sharing this app");app_folder_id=window.folder[Nimbus.Auth.app_name].id;if(!callback){callback=function(file){return log("Permission Removal Complete ",file)}}params={path:"/drive/v2/files/"+app_folder_id+"/permissions/"+id,method:"DELETE"};return this.make_request(params,callback)},remove_share_user_real:function(id,callback,file_id){var params;log("&&& remove a user from sharing this app");if(!callback){callback=function(file){return log("Permission Removal Complete ",file)}}file_id=file_id?file_id:window.c_file.id;params={path:"/drive/v2/files/"+file_id+"/permissions/"+id,method:"DELETE"};return this.make_request(params,callback)},get_user_email:function(){var access_token,data,xhr;if(window.user_email!=null){return window.user_email}access_token=gapi.auth.getToken().access_token;data=null;xhr=new XMLHttpRequest;xhr.onreadystatechange=function(){if(xhr.readyState===4){if(xhr.status===200){return data=JSON.parse(xhr.responseText)}else{return log("get user email failed with status "+xhr.status)}}};xhr.open("GET","https://www.googleapis.com/oauth2/v1/tokeninfo?access_token="+access_token,false);xhr.send(null);if((data!=null?data.email:void 0)!=null){window.user_email=data.email;return data.email}return null},get_shared_users_real:function(callback){var params,process,_this=this;log("&&& get shared users");process=function(file){var p,perm,permissions,_i,_len,_ref;log("Update Complete ",file);permissions=[];_ref=file.items;for(_i=0,_len=_ref.length;_i<_len;_i++){p=_ref[_i];perm={id:p.id,name:p.name,role:p.role};if(p.photoLink!=null){perm["pic"]=p.photoLink}permissions.push(perm)}log("permissions",permissions);if(callback!=null){return callback(permissions)}};params={path:"/drive/v2/files/"+window.c_file.id+"/permissions",method:"GET"};return this.make_request(params,process)},get_shared_users:function(callback){var app_folder_id,params,process,_this=this;log("&&& get shared users");app_folder_id=window.folder[Nimbus.Auth.app_name].id;process=function(file){var p,perm,permissions,_i,_len,_ref;log("Update Complete ",file);permissions=[];_ref=file.items;for(_i=0,_len=_ref.length;_i<_len;_i++){p=_ref[_i];perm={id:p.id,name:p.name,role:p.role};if(p.photoLink!=null){perm["pic"]=p.photoLink}permissions.push(perm)}log("permissions",permissions);if(callback!=null){return callback(permissions)}};params={path:"/drive/v2/files/"+app_folder_id+"/permissions",method:"GET"};return this.make_request(params,process)},get_app_folders:function(callback){log("&&& get app folders");return Nimbus.Client.GDrive.getMetadataList("mimeType = 'application/vnd.google-apps.folder' and title = '"+Nimbus.Auth.app_name+"'",function(data){var f,folders,s,spaces,_i,_len;log(data);folders=data.items;spaces=[];if(data.items!=null){for(_i=0,_len=folders.length;_i<_len;_i++){f=folders[_i];s={};s.id=f.id;s.owner=f.ownerNames[0];spaces.push(s)}}log(spaces);if(callback!=null){return callback(spaces)}})},switch_to_app_folder:function(id,callback){var _this=this;log("###switch to app folder");window.folder={};window.folder[Nimbus.Auth.app_name]={title:Nimbus.Auth.app_name,id:id};window.current_syncing=new DelayedOp(function(){if(callback!=null){return callback()}});localStorage["main_folder_id"]=id;Nimbus.Client.GDrive.getMetadataList("mimeType = 'application/vnd.google-apps.folder'",function(data){var a,k,v,x,_i,_len,_ref,_results;a=data.items;log("###rewriting folders",a);for(_i=0,_len=a.length;_i<_len;_i++){x=a[_i];log(x);if(x.parents.length>0&&x.parents[0].id===id){window.folder[x.title]=x}}if(Nimbus.dictModel!=null){_ref=Nimbus.dictModel;_results=[];for(k in _ref){v=_ref[k];_results.push(v.records={})}return _results}});return window.current_syncing.ready()},switch_to_app_file_real:function(id,callback){var _this=this;window.current_syncing=new DelayedOp(function(){if(callback!=null){return callback()}});Nimbus.Share.getFile(id,function(data){var k,v,_ref;if(!data.id){return}window.c_file=data;if(Nimbus.dictModel!=null){_ref=Nimbus.dictModel;for(k in _ref){v=_ref[k];v.records={}}}return gapi.drive.realtime.load(id,onFileLoaded,initializeModel,handleErrors)});return window.current_syncing.ready()},build_params:function(obj){var k,params_arr,v;params_arr=function(){var _results;_results=[];for(k in obj){v=obj[k];_results.push(""+encodeURIComponent(k)+"="+encodeURIComponent(v))}return _results}();return params_arr.join("&")},extract_params_from_url:function(){var m,params,queryString,regex;params={};queryString=location.hash.substring(1);regex=/([^&=]+)=([^&]*)/g;while(m=regex.exec(queryString)){params[decodeURIComponent(m[1])]=decodeURIComponent(m[2])}return params},request_access_token:function(){var params,params_str,url;params={response_type:"token",client_id:Nimbus.Auth.key,redirect_uri:window.location.protocol+"//"+window.location.host+window.location.pathname,scope:Nimbus.Auth.scope,state:"gdrive_get_access_token",approval_prompt:"auto"};params_str=this.build_params(params);url="https://accounts.google.com/o/oauth2/auth?"+params_str;return window.open(url,"_self")},request_validate_token:function(token){var data,xhr;xhr=new XMLHttpRequest;data=null;xhr.onreadystatechange=function(){var _ref;if(xhr.readyState===4){if((_ref=xhr.status)===200||_ref===400){return data=JSON.parse(xhr.responseText)}else{return log("validate access token failed with status "+xhr.status)}}};xhr.open("GET","https://www.googleapis.com/oauth2/v1/tokeninfo?access_token="+token,false);xhr.send(null);return data},is_token_validate:function(token){var data,result;result=false;data=this.request_validate_token(token);if(data==null){return false}if(!("error"in data)&&(data!=null?data.audience:void 0)===Nimbus.Auth.key){result=true}return result},handle_auth_redirected:function(){return typeof history.replaceState==="function"?history.replaceState("",document.title,window.location.pathname):void 0},is_auth_redirected:function(){var params;params=this.extract_params_from_url();if(params.state==="gdrive_get_access_token"&&"token_type"in params&&params.token_type==="Bearer"){return true}return false}};Nimbus.Client.GDrive.Binary={binary_setup:function(){return window.binary=Nimbus.Model.setup("binary",["name","path","copied","directlink","sharelink","expiration","file_id"])},initialize_client:function(run){log("initializing client");if(Nimbus.Auth.key!=null&&Nimbus.Auth.secret!=null){if(!Nimbus.Client.GDrive.check_auth()){return Nimbus.Client.GDrive.authorize(Nimbus.Auth.key,Nimbus.Auth.secret,function(){log("GDrive authorized");if(run){return run()}})}else{if(run){return run()}}}else{return log("can't upload file with no GDrive credentials")}},upload_blob:function(blob,name,callback){return Nimbus.Client.GDrive.Binary.initialize_client(function(){var reader;log("upload new blob");reader=new FileReader;reader.readAsBinaryString(blob);return reader.onload=function(){var come_back,content,contentType,new_file,parent;content=reader.result;contentType=blob.type||"application/octet-stream";parent=window.folder["binary_files"].id;new_file=binary.create({name:name});come_back=function(file){console.log("upload file to cloud");console.log(file);new_file.copied=true;new_file.file_id=file.id;new_file.directlink=file.webContentLink;new_file.save();if(callback!=null){return callback(new_file)}};return Nimbus.Client.GDrive.insertFile(content,name,contentType,parent,come_back)}})},upload_file:function(file,callback){return Nimbus.Client.GDrive.Binary.initialize_client(function(){var reader;log("upload new file");reader=new FileReader;reader.readAsBinaryString(file);return reader.onload=function(){var come_back,content,contentType,name,new_file,parent;name=file.name;content=reader.result;contentType=file.type||"application/octet-stream";parent=window.folder["binary_files"].id;new_file=binary.create({name:name});come_back=function(file){console.log("upload file to cloud");console.log(file);new_file.copied=true;new_file.file_id=file.id;new_file.directlink=file.webContentLink;new_file.save();if(callback!=null){return callback(new_file)}};return Nimbus.Client.GDrive.insertFile(content,name,contentType,parent,come_back)}})},read_file:function(binary,callback){return Nimbus.Client.GDrive.Binary.initialize_client(function(){var param;log("read metadata of a file from the server");param={path:"/drive/v2/files/"+binary.file_id};return Nimbus.Client.GDrive.make_request(param,function(data){console.log(data);if(callback){return callback(data)}})})},share_link:function(binary,callback){return Nimbus.Client.GDrive.Binary.initialize_client(function(){log("get the share link");if(callback){return callback("")}})},direct_link:function(binary,callback){return Nimbus.Client.GDrive.Binary.initialize_client(function(){log("get the direct link");if(callback){return callback(binary.directlink)}})},delete_file:function(binary){return Nimbus.Client.GDrive.Binary.initialize_client(function(){log("delete file",binary);return Nimbus.Client.GDrive.deleteFile(binary.file_id,function(){return binary.destroy()})})}};window.nimbus_error=[];Nimbus.Model.GDrive={cloudcache:{},last_hash:"",hash:"",toCloudStructure:function(object){log("local to cloud structure");return JSON.stringify(object)},fromCloudStructure:function(value){log("changes cloud to local data in the form a dictionary");return JSON.parse(value)},diff_objects:function(previous,current){var diff,f,v;diff={};for(f in previous){v=previous[f];if(current[f]!==previous[f]){diff[f]=[current[f],previous[f]]}}if(previous["parent_id"]!=null!==(current["parent_id"]!=null)){diff["parent_id"]=["one of them is null"]}return diff},add_to_cloud:function(object,callback){var parent,parent_name;log("add to cloud",object);parent_name=object.parent.name;parent=window.folder[parent_name].id;return Nimbus.Client.GDrive.insertFile(this.toCloudStructure(object),object.id,"text/plain",parent,function(data){log("logging data inserted",data);window.currently_syncing=true;object.gid=data.id;object.time=data.modifiedDate;object.synced=true;object.save();return window.currently_syncing=false})},delete_from_cloud:function(object_id,callback){log("delete from cloud",object_id);return Nimbus.Client.GDrive.getMetadataList("title = '"+object_id+"'",function(data){var id;log("data",data);if(data.items.length>0){id=data.items[0].id;Nimbus.Client.GDrive.deleteFile(id);if(callback!=null){return callback()}}else{return log("file to be deleted not there")}})},update_to_cloud:function(object,callback){var comeback,parent,parent_name,update_comback,_this=this;log("updated to cloud",object.name);parent_name=object.parent.name;parent=window.folder[parent_name].id;update_comback=function(data){log("logging data inserted",data);window.currently_syncing=true;object.time=data.modifiedDate;object.save();object.synced=true;return window.currently_syncing=false};comeback=function(data){var id;id=data.items[0].id;return Nimbus.Client.GDrive.updateFile(_this.toCloudStructure(object),object.id,"text/plain",id,parent,function(data){log("logging data inserted",data);window.currently_syncing=true;object.time=data.modifiedDate;object.save();return window.currently_syncing=false})};if(object.gid!=null){return Nimbus.Client.GDrive.updateFile(this.toCloudStructure(object),object.id,"text/plain",object.gid,parent,function(data){log("logging data updated",data);window.currently_syncing=true;object.time=data.modifiedDate;object.save();return window.currently_syncing=false})}else{return Nimbus.Client.GDrive.getMetadataList("title = '"+object.id+"'",comeback)}},add_from_cloud:function(object_id,callback){var process_data,_this=this;log("add from cloud GDrive",object_id);process_data=function(data){var converted,x;log("cloud url data",JSON.parse(data));window.currently_syncing=true;converted=_this.fromCloudStructure(data);x=_this.init(converted);x.synced=true;x.time=_this.cloudcache[object_id].time;x.save();return window.currently_syncing=false};return Nimbus.Client.GDrive.getMetadataList("title = '"+object_id+"'",function(data){var url;log("cloud read data",data);window.data=data;if(data.items!=null&&data.items.length>=1){url=window.data.items[0].downloadUrl;return Nimbus.Client.GDrive.readFile(url,process_data)}else{return log("This data is not there")}})},update_to_local:function(object,callback){var process_data,_this=this;log("update to local",object);process_data=function(data){var converted,x;log("cloud url data",JSON.parse(data));window.currently_syncing=true;converted=_this.fromCloudStructure(data);x=_this.find(object.id);converted.time=_this.cloudcache[object.id].time;x.updateAttributes(converted);return window.currently_syncing=false};return Nimbus.Client.GDrive.getMetadataList("title = '"+object.id+"'",function(data){var url;log("cloud read data",data);window.data=data;if(data.error!=null){window.nimbus_error.push({error:data.error,object:object});return console.log("##ERROR writing back to local",data.error,"object: ",object)}else{if(data.items.length>=1){url=window.data.items[0].downloadUrl;return Nimbus.Client.GDrive.readFile(url,process_data)}else{return log("This data is not there")}}})},sync_all:function(cb){var _this=this;log("syncs all the data, normally happens at the start of a program or coming back from offline");window.current_syncing=new DelayedOp(function(){log("call back sync called");window.current_syncing=new DelayedOp(function(){window.current_syncing=null;if(cb!=null){return cb()}});_this.sync_model_base_algo();return window.current_syncing.ready()});this.load_all_from_cloud();return window.current_syncing.ready()},load_all_from_cloud:function(){var fill_cache,folder_id,object_name,_this=this;log("loads all the data from the cloud locally");this.cloudcache={};object_name=this.name;log("object name",object_name);if(window.folder!=null&&window.folder[object_name]!=null){folder_id=window.folder[object_name].id;fill_cache=function(data){var x,_i,_len,_ref,_results;log("cloud read data",object_name,data);window.data=data;if(data.items!=null){_ref=data.items;_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){x=_ref[_i];_this.cloudcache[x.title]={id:x.title,time:x.modifiedDate};if(x.labels.trashed){_results.push(console.log("##### this is trashed #####",x))}else{_results.push(void 0)}}return _results}else{return log("###ERROR, no return data")}};Nimbus.Client.GDrive.getMetadataList("'"+folder_id+"' in parents",fill_cache);return _this.is_cloud_available=true}else{log("############################BIG ERROR no folder there for load from cloud");return _this.is_cloud_available=false}},get_delta:function(){return log("get the delta for ",this.name," since last synced")},extended:function(){this.sync(this.proxy(this.real_time_sync));return this.fetch(this.proxy(this.loadLocal))}};window.folder=null;window.folder_creation=new OneOp;window.creating={};window.handle_initialization=new OneOp;window.gdrive_initialized=false;window.folder_initialize=function(callback){log("&&& folder initialize");log("Nimbus.Client.GDrive.check_auth()",Nimbus.Client.GDrive.check_auth(),"Nimbus.Auth.service",Nimbus.Auth.service);if(Nimbus.Client.GDrive.check_auth()&&Nimbus.Auth.service==="GDrive"){log("this is authenticated and a GDrive app");return Nimbus.Client.GDrive.getMetadataList("mimeType = 'application/vnd.google-apps.folder'",function(data){var a,x,_i,_j,_len,_len1;log("#data: ",data);if(window.folder===null){window.folder={}}a=data.items;if(localStorage["main_folder_id"]!=null){window.folder[Nimbus.Auth.app_name]={title:Nimbus.Auth.app_name,id:localStorage["main_folder_id"]}}else{for(_i=0,_len=a.length;_i<_len;_i++){x=a[_i];if(x.title===Nimbus.Auth.app_name){window.folder[x.title]=x}}}if(window.folder[Nimbus.Auth.app_name]==null){window.folder={};return Nimbus.Client.GDrive.insertFile("",Nimbus.Auth.app_name,"application/vnd.google-apps.folder",null,function(data){log("folder data",data);window.folder[data.title]=data;if(callback!=null){callback()}if(window.folder["binary_files"]==null){return Nimbus.Client.GDrive.insertFile("","binary_files","application/vnd.google-apps.folder",window.folder[Nimbus.Auth.app_name].id,function(data){log("binary_files folder data",data);log("binary ready callback",binary_ready_callback);if(window.binary_ready_callback){return window.binary_ready_callback()}})}else{log("binary ready callback",binary_ready_callback);if(window.binary_ready_callback){return window.binary_ready_callback()}}})}else{log("base folder there: ",window.folder[Nimbus.Auth.app_name].id);for(_j=0,_len1=a.length;_j<_len1;_j++){x=a[_j];log(x);if(x.parents.length>0&&x.parents[0].id===window.folder[Nimbus.Auth.app_name].id){window.folder[x.title]=x}}if(callback!=null){callback()}if(window.folder["binary_files"]==null){return Nimbus.Client.GDrive.insertFile("","binary_files","application/vnd.google-apps.folder",window.folder[Nimbus.Auth.app_name].id,function(data){log("binary_files folder data",data);log("binary ready callback",binary_ready_callback);if(window.binary_ready_callback){return window.binary_ready_callback()}})}else{log("binary ready callback",binary_ready_callback);if(window.binary_ready_callback){return window.binary_ready_callback()}}}})}};window.model_initialize=function(model){log("initialized model",model);log("#loaded",window.loaded,window.gdrive_initialized);if(!Nimbus.loaded||!Nimbus.Client.GDrive.check_auth()){log("initialization called later");window.handle_initialization.add_call(function(){return window.model_initialize(model)});return}if(window.folder===null){log("window.folder object not present");log("#folder creation is running",window.folder_creation.running);if(window.creating[model.name]==null){window.creating[model.name]=true;if(window.folder_creation.running===false){window.folder_initialize(function(){return window.folder_creation.execute_callback()})}return window.folder_creation.add_call(function(){log("THE CALLBACK IS CALLED","model.name exists",window.folder[model.name]!=null);if(window.folder[model.name]==null){return Nimbus.Client.GDrive.insertFile("",model.name,"application/vnd.google-apps.folder",window.folder[Nimbus.Auth.app_name].id,function(data){return window.folder[data.title]=data})}})}}else{if(window.folder[model.name]!=null){return log("model folder there")}else{log("creating model folder for",model.name);return Nimbus.Client.GDrive.insertFile("",model.name,"application/vnd.google-apps.folder",window.folder[Nimbus.Auth.app_name].id,function(data){return window.folder[data.title]=data})}}};Nimbus.Auth.GDrive={get_token_from_code:function(code){var data,xhr,_this=this;xhr=new XMLHttpRequest;data="code="+code+"&client_id="+this.key+"&client_secret="+this.client_secret+"&grant_type=authorization_code&redirect_uri=urn%3Aietf%3Awg%3Aoauth%3A2.0%3Aoob";window.data=data;xhr.open("POST","https://accounts.google.com/o/oauth2/token");xhr.setRequestHeader("Content-Type","application/x-www-form-urlencoded");xhr.onreadystatechange=function(status,response){var e,result;if(xhr.readyState===4){try{result=JSON.parse(xhr.response);if(result["error"]){return console.log("error")}else{window.plugins.childBrowser.close();localStorage["phonegap_token"]=JSON.stringify(result);localStorage["state"]="Working";gapi.auth.setToken(result);_this.prepare_gdrive();return Nimbus.track.google.registered_user()}}catch(_error){e=_error;return console.log(e)}}};xhr.send(data);return window.xhr=xhr},authenticate_gdrive:function(){var auth_url,cb,url;log("this should bring up a prompt to initialize into GDrive");localStorage["d_key"]=this.key;localStorage["secret"]=this.scope;localStorage["state"]="Auth";if(document.URL.slice(0,4)==="file"&&(typeof cordova!=="undefined"&&cordova!==null)){log("Phonegap google login");auth_url="https://accounts.google.com/o/oauth2/auth?response_type=code&client_id="+this.key+"&scope="+encodeURIComponent(this.scope)+"&approval_prompt=auto&redirect_uri=urn:ietf:wg:oauth:2.0:oob";window.auth_url=auth_url;cb=window.plugins.childBrowser;if(cb!==null){cb.onLocationChange=function(loc){return locChanged(loc)};cb.onClose=function(){return onCloseBrowser()};cb.onOpenExternal=function(){return onOpenExternal()};url=auth_url+"###var sendToApp = function(_key, _val) {var iframe = document.createElement('IFRAME');iframe.setAttribute('src', _key + ':##sendToApp##' + _val);document.documentElement.appendChild(iframe);iframe.parentNode.removeChi(iframe);iframe = null;};var log=function(_mssg){sendToApp('ios-log',_mssg);}; var html = document.getElementById('code').value; log(html);";cb.onJSCallback=function(backStr){cb.code=backStr;if(backStr&&backStr!=null&&backStr!=="(null)"){cb.close();console.log("will get some toaken");return Nimbus.Auth.get_token_from_code(backStr)}};return cb.showWebPage(url)}}else if(location.protocol==="chrome-extension:"){log("chrome extension authorize");return this.oauth2_authorize()}else{return Nimbus.Client.GDrive.request_access_token()}},initialize_gdrive:function(){var _this=this;log("This part should reflect what initialization needs to be done for GDrive auth");Nimbus.gdrive_initialized=true;if(Nimbus.loaded){if(location.protocol==="chrome-extension:"){return this.oauth2_authorize_second_half()}else{if(Nimbus.Client.GDrive.is_auth_redirected()){Nimbus.Client.GDrive.handle_auth_redirected()}console.log("GDrive loaded");if(localStorage["phonegap_token"]){gapi.auth.setToken(JSON.parse(localStorage["phonegap_token"]));return _this.prepare_gdrive()}return gapi.auth.authorize({client_id:this.key,scope:this.scope,immediate:true},function(data){log("client load handled GDrive");log(data);if(data!==null){return _this.prepare_gdrive()}})}}},gdrive_authorized:function(){return Nimbus.Client.GDrive.check_auth()},logout_gdrive:function(callback){var k,v,_ref;localStorage.clear();gapi.auth.setToken(null);if(Nimbus.dictModel!=null){_ref=Nimbus.dictModel;for(k in _ref){v=_ref[k];v.records={}}}if(this.sync_services!=null){Nimbus.Auth.setup(this.sync_services)}if(callback!=null){return callback()}},prepare_gdrive:function(){window.binary_ready_callback=function(){if(Nimbus.Auth.authorized_callback!=null){return Nimbus.Auth.authorized_callback()}};return window.startRealtime(function(){log("CURRENT SYNCING CALLBACK");Nimbus.Auth.app_ready_func();return Nimbus.track.google.registered_user()})},oauth2_authorize:function(){var background,params,url;background=chrome.extension.getBackgroundPage();background.NimbusAuth2=function(background_window){var NimbusAuth2;NimbusAuth2={OAUTH2_REDIRECT_URI:"http://www.google.com/robots.txt",getExtensionId:function(){return background_window.chrome.i18n.getMessage("@@extension_id")},isOauth2AuthorizeRedirected:function(base,state){if(base===this.OAUTH2_REDIRECT_URI&&state===this.getExtensionId()){return true}return false},parseParamsString:function(queryString){var m,params,regex;params={};regex=/([^&=]+)=([^&]*)/g;while(m=regex.exec(queryString)){params[background_window.decodeURIComponent(m[1])]=background_window.decodeURIComponent(m[2])}return params},parseRedirectedURL:function(url){var base_url,hash,params,_ref;_ref=url.split("#"),base_url=_ref[0],hash=_ref[1];params=this.parseParamsString(hash);return{base_url:base_url,params:params}},generateRedirectListener:function(){var listener,_this=this;listener=function(tab_id,change_info,tab){var entension_windows,url_obj,w,_i,_len;if(change_info.status!=="loading"){return}url_obj=_this.parseRedirectedURL(tab.url);if(_this.isOauth2AuthorizeRedirected(url_obj.base_url,url_obj.params.state)){background_window.chrome.tabs.onUpdated.removeListener(listener);background_window.chrome.tabs.remove(tab_id);url_obj["saved_time"]=(new background_window.Date).getTime();background_window.localStorage["_nimbusGDriveAuthObj"]=background_window.JSON.stringify(url_obj);if(_this.isPackagedApp()){background_window.console.log("in packaged app");entension_windows=background_window.chrome.extension.getViews({type:"tab"});for(_i=0,_len=entension_windows.length;_i<_len;_i++){w=entension_windows[_i];if(w.Nimbus.Auth.GDrive.oauth_status_flag==="ongoing"){w.Nimbus.Auth.GDrive.oauth2_authorize_second_half()}}}else if(_this.isBrowserAction()){background_window.console.log("in browser action")}return null}};return listener},installRedirectedListener:function(){return background_window.chrome.tabs.onUpdated.addListener(this.generateRedirectListener())},isBrowserAction:function(){return"browser_action"in background_window.chrome.runtime.getManifest()},isPackagedApp:function(){return"app"in background_window.chrome.runtime.getManifest()}};return NimbusAuth2}(background);Nimbus.Auth.GDrive.oauth_status_flag="ongoing";background.NimbusAuth2.installRedirectedListener();url="https://accounts.google.com/o/oauth2/auth?";params={client_id:this.key,scope:this.scope,redirect_uri:this.OAUTH2_REDIRECT_URI,state:this.getExtensionId(),response_type:"token",approval_prompt:"auto"};url+=this.buildParamsString(params);return chrome.tabs.create({url:url})},oauth2_authorize_second_half:function(){var issued_at,save_token,token,url_obj;if(localStorage._nimbusGDriveAuthObj!=null){url_obj=JSON.parse(localStorage["_nimbusGDriveAuthObj"]);if("error"in url_obj){throw new Error("authorization failed with error: "+url_obj.error)}save_token=url_obj.params;issued_at=Math.round(url_obj.saved_time/1e3);save_token.client_id=this.key;save_token.scope=this.scope;save_token.response_type="token";save_token.issued_at=issued_at.toString();save_token.expires_at=(issued_at+parseInt(save_token.expires_in)).toString();save_token.state="";delete localStorage["_nimbusGDriveAuthObj"];localStorage["_chromeExtensionAuth2Token"]=JSON.stringify(save_token)}if(localStorage["_chromeExtensionAuth2Token"]){token=JSON.parse(localStorage["_chromeExtensionAuth2Token"]);gapi.auth.setToken(token);Nimbus.Auth.GDrive.oauth_status_flag="finish";return this.prepare_gdrive()}},OAUTH2_REDIRECT_URI:"http://www.google.com/robots.txt",getExtensionId:function(){return chrome.i18n.getMessage("@@extension_id")},buildParamsString:function(obj){var k,params_arr,v;params_arr=function(){var _results;_results=[];for(k in obj){v=obj[k];_results.push(""+encodeURIComponent(k)+"="+encodeURIComponent(v))}return _results}();return params_arr.join("&")},getLocalOauth2Token:function(token){if(Nimbus.Auth.GDrive._cacheToken!=null){return Nimbus.Auth.GDrive._cacheToken}if(localStorage._chromeExtensionAuth2Token!=null){token=JSON.parse(localStorage._chromeExtensionAuth2Token);Nimbus.Auth.GDrive._cacheToken=token;return token}else{return null}},isTokenExpires:function(token){var expires_at,now;if((token!=null?token.expires_at:void 0)!=null){expires_at=parseInt(token.expires_at);now=(new Date).getTime();if(expires_at*1e3>now){return true}else{return false}}return true}};Nimbus.Auth.Multi={authenticate_service:function(service){var isArray,key,user_email_scope,val,x,_ref;log("authenticate a single service",service);isArray=Array.isArray||function(value){return{}.toString.call(value)==="[object Array]"};if(this.sync_services!=null&&this.sync_services[service]!=null){x=this.sync_services[service];x["service"]=service;if(service==="Dropbox"){Nimbus.Auth.setup(x)}if(service==="GDrive"){user_email_scope="https://www.googleapis.com/auth/userinfo.email";if(isArray(x.scope)){if(__indexOf.call(x.scope,user_email_scope)<0){x.scope.push(user_email_scope)}}else{x.scope=[x.scope,user_email_scope]}x.scope=x.scope.join(" ");if(x.client_secret!=null){Nimbus.Auth.setup(x)}else{Nimbus.Auth.setup(x)}}_ref=Nimbus.dictModel;for(key in _ref){val=_ref[key];Nimbus.Model.service_setup(val)}Nimbus.Auth.initialize();return Nimbus.Auth.authorize()}},initialize_service:function(){log("initializing service");return Nimbus.Auth.reinitialize()}};Nimbus.Auth.reinitialize();Nimbus.backbone_store=function(name,model){var k,k_arr,m,nimbus_model,store,v,_ref;log("Model on creation",model);this.name=name;m=new model;k_arr=[];_ref=m.attributes;for(k in _ref){v=_ref[k];k_arr.push(k)}nimbus_model=Nimbus.Model.setup(name,k_arr);store=nimbus_model;this.data=nimbus_model.all()||{};return store};Nimbus.backbone_sync=function(method,model,options){var a,resp,s,store;resp=void 0;store=model.nimbus||model.collection.nimbus;window.model=model;switch(method){case"read":if(model.id){resp=store.find(model)}else{store.sync_all(function(){resp=store.all();return options.success(resp)});return}break;case"create":console.log("create called");a=store.init(model.attributes);a.id=model.id;a.save();resp=a;break;case"update":s=store.find(model.id);s.updateAttributes(model.attributes);s.save();resp=s;
break;case"delete":console.log("deletion find",store.find(model.id));resp=store.find(model.id).destroy()}if(resp){return options.success(resp)}else{return options.error("Record not found")}};Nimbus.angularService=function(){var all_models,makeWatcher,setup;all_models={};setup=function(name,attrs,sync_callback){var store;store=Nimbus.Model.setup(name,attrs);store.sync_all(sync_callback);all_models["name"]=store;return store};makeWatcher=function(name){return function(){return localStorage[name]}};return{setup:setup,makeWatcher:makeWatcher}};mixpanel_token="57da9d172e8c2000bca77d9ebb935752";Nimbus.track={send_people_request:function(x){var encoded,xhr,_this=this;xhr=new XMLHttpRequest;log(JSON.stringify(x));encoded=Base64.encode(JSON.stringify(x));window.data="data="+encoded;xhr.open("POST","http://api.mixpanel.com/engage");xhr.setRequestHeader("Content-Type","application/x-www-form-urlencoded");xhr.onreadystatechange=function(status,response){if(xhr.readyState===4){try{log("xhr",xhr);log("mixpanel response done");return log("response: ",xhr.response)}catch(_error){}}};xhr.send(data);return window.xhr=xhr},registered_user:function(){var email;log("registered user");if(Nimbus.Auth.service==="Dropbox"){Nimbus.Client.Dropbox.getAccountInfo(function(info){var email,first,last,n,x,_ref;n=info.display_name;_ref=n.split(" "),first=_ref[0],last=_ref[1];email="";if(info.email!=null){email=info.email}x={$set:{$first_name:first,$last_name:last,$app:Nimbus.Auth.app_name,$service:Nimbus.Auth.service,$email:email,$url:window.location.href},$token:mixpanel_token,$distinct_id:email};log(x);return Nimbus.track.send_people_request(x)})}if(Nimbus.Auth.service==="GDrive"){email=Nimbus.Client.GDrive.get_user_email();return Nimbus.Client.GDrive.get_current_user(function(info){var first,last,n,x,_ref;n=info.name;_ref=n.split(" "),first=_ref[0],last=_ref[1];x={$set:{$first_name:first,$last_name:last,$app:Nimbus.Auth.app_name,$service:Nimbus.Auth.service,$email:email,$url:window.location.href},$token:mixpanel_token,$distinct_id:email};log(x);return Nimbus.track.send_people_request(x)})}},report_storage_stat:function(){var last_reported_date,now;log("report storage stat");now=new Date;if(localStorage["last_reported_date"]!=null){last_reported_date=localStorage["last_reported_date"]}if(last_reported_date){if(now-last_reported_date>864e5){log("start sending data")}return localStorage["last_reported_date"]=now}else{return log("start sending data")}}};this.Nimbus=Nimbus;baseUrl="http://www.google-analytics.com/collect?v=1&tid=UA-46950334-1&cid=001";Nimbus.track.google={data:{},send_page_tracking:function(url){var path,xhr;path=baseUrl+"&t=pageview&dp="+encodeURI(url);xhr=new XMLHttpRequest;xhr.open("GET",path,true);xhr.send(null)},send_event_tracking:function(dom,action,id,value){var path,xhr;if(dom==null){dom=0}if(action==null){action=0}if(id==null){id=0}if(value==null){value=0}path=baseUrl+"&t=event&ec="+encodeURI(dom)+"&ea="+encodeURI(action)+"&el="+encodeURI(id)+"&ev="+encodeURI(value);xhr=new XMLHttpRequest;xhr.open("GET",path,true);return xhr.send(null)},registered_user:function(){this.data["page_url"]=window.location.href;this.data["app_name"]=Nimbus.Auth.app_name;this.data["cloudType"]=Nimbus.Auth.service;this.send_page_tracking(this.data.page_url);setTimeout(function(){var count,data,i,len;count=0;for(i in Nimbus.dictModel){len=Nimbus.dictModel[i].all().length;count=count+len}Nimbus.track.google.data["sum"]=count;data=Nimbus.track.google.data;log("send to gogole analytic :",data);Nimbus.track.google.send_event_tracking(data.app_name,data.email,data.cloudType,data.sum)},5e3);if(Nimbus.Auth.service==="Dropbox"){Nimbus.Client.Dropbox.getAccountInfo(function(info){if(info.email!=null){return this.data["email"]=info.email}})}if(Nimbus.Auth.service==="GDrive"){return this.data["email"]=Nimbus.Client.GDrive.get_user_email()}}};window.onerror=function(msg,url,line){var app_name,cloudType,email,info;if(Nimbus.track.google.data.email!=null){email=Nimbus.track.google.data.email}if(Nimbus.track.google.data.app_name!=null){app_name=Nimbus.track.google.data.app_name}if(Nimbus.track.google.data.cloudType!=null){cloudType=Nimbus.track.google.data.cloudType}info="msg:"+msg+";  url:'"+url+"; line:"+line+"';  app_name:"+app_name+";  user_email:"+email+"; cloudType:"+cloudType;log("got error, send to  google analytic:",info);return Nimbus.track.google.send_event_tracking(app_name,"error",info)}}).call(this);