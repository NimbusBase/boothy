// Generated by CoffeeScript 1.6.2
(function(){var e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T,N,C,k,L,A,O,M,_,D,P,H,B,j,F,I,q,R,U,z,W,X,V,$,J,K,Q,G={}.hasOwnProperty,Y=function(e,t){return function(){return e.apply(t,arguments)}},Z=[].slice;window.handle_initialization=null,window.loaded=!1,window.handleClientLoad=function(){console.log("loaded CALLED"),window.loaded=!0;if(window.gdrive_initialized)return Nimbus.Auth.initialize()},B=document.getElementsByTagName("head")[0],I=document.createElement("script"),I.type="text/javascript",I.src="https://apis.google.com/js/client.js?onload=handleClientLoad",B.appendChild(I),n=function(){function e(e){this.client=new r(e)}return e}(),n.ApiError=function(){function e(e,t,n){var r,i;this.method=t,this.url=n,this.status=e.status,e.responseType?i=e.response||e.responseText:i=e.responseText;if(i)try{this.responseText=i.toString(),this.response=JSON.parse(i)}catch(s){r=s,this.response=null}else this.responseText="(no response)",this.response=null}return e.prototype.toString=function(){return"Dropbox API error "+this.status+" from "+this.method+" "+this.url+" :: "+this.responseText},e.prototype.inspect=function(){return this.toString()},e}(),typeof window!="undefined"&&window!==null?window.atob&&window.btoa?(p=function(e){return window.atob(e)},w=function(e){return window.btoa(e)}):(g="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",E=function(e,t,n){var r,i;i=3-t,e<<=i*8,r=3;while(r>=i)n.push(g.charAt(e>>r*6&63)),r-=1;r=t;while(r<3)n.push("="),r+=1;return null},d=function(e,t,n){var r,i;i=4-t,e<<=i*6,r=2;while(r>=i)n.push(String.fromCharCode(e>>8*r&255)),r-=1;return null},w=function(e){var t,n,r,i,s,o;i=[],t=0,n=0;for(r=s=0,o=e.length;0<=o?s<o:s>o;r=0<=o?++s:--s)t=t<<8|e.charCodeAt(r),n+=1,n===3&&(E(t,n,i),t=n=0);return n>0&&E(t,n,i),i.join("")},p=function(e){var t,n,r,i,s,o,u;s=[],t=0,r=0;for(i=o=0,u=e.length;0<=u?o<u:o>u;i=0<=u?++o:--o){n=e.charAt(i);if(n==="=")break;t=t<<6|g.indexOf(n),r+=1,r===4&&(d(t,r,s),t=r=0)}return r>0&&d(t,r,s),s.join("")}):(p=function(e){var t,n;return t=new Buffer(e,"base64"),function(){var e,r,i;i=[];for(n=e=0,r=t.length;0<=r?e<r:e>r;n=0<=r?++e:--e)i.push(String.fromCharCode(t[n]));return i}().join("")},w=function(e){var t,n;return t=new Buffer(function(){var t,r,i;i=[];for(n=t=0,r=e.length;0<=r?t<r:t>r;n=0<=r?++t:--t)i.push(e.charCodeAt(n));return i}()),t.toString("base64")}),n.Client=function(){function e(e){this.sandbox=e.sandbox||!1,this.apiServer=e.server||this.defaultApiServer(),this.authServer=e.authServer||this.defaultAuthServer(),this.fileServer=e.fileServer||this.defaultFileServer(),this.oauth=new i(e),this.uid=null,this.authState=null,this.authError=null,this._credentials=null,this.setCredentials(e),this.setupUrls()}return e.prototype.authDriver=function(e){return this.driver=e,this},e.prototype.dropboxUid=function(){return this.uid},e.prototype.credentials=function(){return this._credentials||this.computeCredentials(),this._credentials},e.prototype.authenticate=function(e){var t,i,s=this;return t=null,i=function(){var o;if(t!==s.authState){t=s.authState;if(s.driver.onAuthStateChange)return s.driver.onAuthStateChange(s,i)}switch(s.authState){case r.RESET:return s.requestToken(function(e,t){var n,o;return e?(s.authError=e,s.authState=r.ERROR):(n=t.oauth_token,o=t.oauth_token_secret,s.oauth.setToken(n,o),s.authState=r.REQUEST),s._credentials=null,i()});case r.REQUEST:return o=s.authorizeUrl(s.oauth.token),s.driver.doAuthorize(o,s.oauth.token,s.oauth.tokenSecret,function(){return s.authState=r.AUTHORIZED,s._credentials=null,i()});case r.AUTHORIZED:return s.getAccessToken(function(e,t){return e?(s.authError=e,s.authState=r.ERROR):(s.oauth.setToken(t.oauth_token,t.oauth_token_secret),s.uid=t.uid,s.authState=r.DONE),s._credentials=null,i()});case r.DONE:return e(null,s);case n.SIGNED_OFF:return s.reset(),i();case r.ERROR:return e(s.authError)}},i(),this},e.prototype.signOut=function(e){var t,i,s=this;return i=this.urls.signOut,t=this.oauth.addAuthParams("POST",i,{}),n.Xhr.request("POST",i,t,null,function(t){return t?e(t):(s.reset(),s.authState=r.SIGNED_OFF,s.driver.onAuthStateChange?s.driver.onAuthStateChange(s,function(){return e(t)}):e(t))})},e.prototype.signOff=function(e){return this.signOut(e)},e.prototype.getUserInfo=function(e){var t,r;return r=this.urls.accountInfo,t=this.oauth.addAuthParams("GET",r,{}),n.Xhr.request("GET",r,t,null,function(t,r){return e(t,n.UserInfo.parse(r),r)})},e.prototype.readFile=function(e,t,r){var i,s,o;return!r&&typeof t=="function"&&(r=t,t=null),o=""+this.urls.getFile+"/"+this.urlEncodePath(e),i={},s=null,t&&(t.versionTag?i.rev=t.versionTag:t.rev&&(i.rev=t.rev),t.blob&&(s="blob"),t.binary&&(s="b")),this.oauth.addAuthParams("GET",o,i),n.Xhr.request2("GET",o,i,null,null,s,function(e,t,i){return r(e,t,n.Stat.parse(i))})},e.prototype.writeFile=function(e,t,r,i){var s;return!i&&typeof r=="function"&&(i=r,r=null),s=n.Xhr.canSendForms&&typeof t=="object",s?this.writeFileUsingForm(e,t,r,i):this.writeFileUsingPut(e,t,r,i)},e.prototype.writeFileUsingForm=function(e,t,r,i){var s,o,u,a,f;a=e.lastIndexOf("/"),a===-1?(o=e,e=""):(o=e.substring(a),e=e.substring(0,a)),f=""+this.urls.postFile+"/"+this.urlEncodePath(e),u={file:o};if(r){r.noOverwrite&&(u.overwrite="false");if(r.lastVersionTag)u.parent_rev=r.lastVersionTag;else if(r.parentRev||r.parent_rev)u.parent_rev=r.parentRev||r.parent_rev}return this.oauth.addAuthParams("POST",f,u),delete u.file,s={name:"file",value:t,fileName:o,contentType:"application/octet-stream"},n.Xhr.multipartRequest(f,s,u,null,function(e,t){return i(e,n.Stat.parse(t))})},e.prototype.writeFileUsingPut=function(e,t,r,i){var s,o;o=""+this.urls.putFile+"/"+this.urlEncodePath(e),s={};if(r){r.noOverwrite&&(s.overwrite="false");if(r.lastVersionTag)s.parent_rev=r.lastVersionTag;else if(r.parentRev||r.parent_rev)s.parent_rev=r.parentRev||r.parent_rev}return this.oauth.addAuthParams("POST",o,s),n.Xhr.request2("POST",o,s,null,t,null,function(e,t){return i(e,n.Stat.parse(t))})},e.prototype.stat=function(e,t,r){var i,s;!r&&typeof t=="function"&&(r=t,t=null),s=""+this.urls.metadata+"/"+this.urlEncodePath(e),i={};if(t){t.version!=null&&(i.rev=t.version);if(t.removed||t.deleted)i.include_deleted="true";t.readDir&&(i.list="true",t.readDir!==!0&&(i.file_limit=t.readDir.toString())),t.cacheHash&&(i.hash=t.cacheHash)}return i.include_deleted||(i.include_deleted="false"),i.list||(i.list="false"),this.oauth.addAuthParams("GET",s,i),n.Xhr.request("GET",s,i,null,function(e,t){var i,s,o;return o=n.Stat.parse(t),(t!=null?t.contents:void 0)?i=function(){var e,r,i,o;i=t.contents,o=[];for(e=0,r=i.length;e<r;e++)s=i[e],o.push(n.Stat.parse(s));return o}():i=void 0,r(e,o,i)})},e.prototype.readdir=function(e,t,n){var r;return!n&&typeof t=="function"&&(n=t,t=null),r={readDir:!0},t&&(t.limit!=null&&(r.readDir=t.limit),t.versionTag&&(r.versionTag=t.versionTag)),this.stat(e,r,function(e,t,r){var i,s;return r?i=function(){var e,t,n;n=[];for(e=0,t=r.length;e<t;e++)s=r[e],n.push(s.name);return n}():i=null,n(e,i,t,r)})},e.prototype.metadata=function(e,t,n){return this.stat(e,t,n)},e.prototype.makeUrl=function(e,t,r){var i,s,o;return!r&&typeof t=="function"&&(r=t,t=null),e=this.urlEncodePath(e),t&&t.download?(i=!0,o=""+this.urls.media+"/"+e):(i=!1,o=""+this.urls.shares+"/"+e),t&&(t["long"]||t.longUrl)?s={short_url:"false"}:s={},this.oauth.addAuthParams("POST",o,s),n.Xhr.request("POST",o,s,null,function(e,t){return r(e,n.PublicUrl.parse(t,i))})},e.prototype.history=function(e,t,r){var i,s;return!r&&typeof t=="function"&&(r=t,t=null),s=""+this.urls.revisions+"/"+this.urlEncodePath(e),i={},t&&t.limit!=null&&(i.rev_limit=t.limit),this.oauth.addAuthParams("GET",s,i),n.Xhr.request("GET",s,i,null,function(e,t){var i,s;return t?s=function(){var e,r,s;s=[];for(e=0,r=t.length;e<r;e++)i=t[e],s.push(n.Stat.parse(i));return s}():s=void 0,r(e,s)})},e.prototype.revisions=function(e,t,n){return this.history(e,t,n)},e.prototype.thumbnailUrl=function(e,t){var r,i;return i=""+this.urls.thumbnails+"/"+this.urlEncodePath(e),r={},t&&(t.format?r.format=t.format:t.png&&(r.format="png"),t.size&&(r.size=t.size)),this.oauth.addAuthParams("GET",i,r),""+i+"?"+n.Xhr.urlEncode(r)},e.prototype.readThumbnail=function(e,t,r){var i,s;return!r&&typeof t=="function"&&(r=t,t=null),s=this.thumbnailUrl(e,t),i="b",t&&t.blob&&(i="blob"),n.Xhr.request2("GET",s,{},null,null,i,function(e,t,i){return r(e,t,n.Stat.parse(i))})},e.prototype.revertFile=function(e,t,r){var i,s;return s=""+this.urls.restore+"/"+this.urlEncodePath(e),i={rev:t},this.oauth.addAuthParams("POST",s,i),n.Xhr.request("POST",s,i,null,function(e,t){return r(e,n.Stat.parse(t))})},e.prototype.restore=function(e,t,n){return this.revertFile(e,t,n)},e.prototype.findByName=function(e,t,r,i){var s,o;!i&&typeof r=="function"&&(i=r,r=null),o=""+this.urls.search+"/"+this.urlEncodePath(e),s={query:t};if(r){r.limit!=null&&(s.file_limit=r.limit);if(r.removed||r.deleted)s.include_deleted=!0}return this.oauth.addAuthParams("GET",o,s),n.Xhr.request("GET",o,s,null,function(e,t){var r,s;return t?s=function(){var e,i,s;s=[];for(e=0,i=t.length;e<i;e++)r=t[e],s.push(n.Stat.parse(r));return s}():s=void 0,i(e,s)})},e.prototype.search=function(e,t,n,r){return this.findByName(e,t,n,r)},e.prototype.makeCopyReference=function(e,t){var r,i;return i=""+this.urls.copyRef+"/"+this.urlEncodePath(e),r=this.oauth.addAuthParams("GET",i,{}),n.Xhr.request("GET",i,r,null,function(e,r){return t(e,n.CopyReference.parse(r))})},e.prototype.copyRef=function(e,t){return this.makeCopyReference(e,t)},e.prototype.pullChanges=function(e,t){var r,i;return!t&&typeof e=="function"&&(t=e,e=null),i=this.urls.delta,r={},e?e.cursorTag?r={cursor:e.cursorTag}:r={cursor:e}:r={},this.oauth.addAuthParams("POST",i,r),n.Xhr.request("POST",i,r,null,function(e,r){return t(e,n.PulledChanges.parse(r))})},e.prototype.delta=function(e,t){return this.pullChanges(e,t)},e.prototype.mkdir=function(e,t){var r,i;return i=this.urls.fileopsCreateFolder,r={root:this.fileRoot,path:this.normalizePath(e)},this.oauth.addAuthParams("POST",i,r),n.Xhr.request("POST",i,r,null,function(e,r){return t(e,n.Stat.parse(r))})},e.prototype.remove=function(e,t){var r,i;return i=this.urls.fileopsDelete,r={root:this.fileRoot,path:this.normalizePath(e)},this.oauth.addAuthParams("POST",i,r),n.Xhr.request("POST",i,r,null,function(e,r){return t(e,n.Stat.parse(r))})},e.prototype.unlink=function(e,t){return this.remove(e,t)},e.prototype["delete"]=function(e,t){return this.remove(e,t)},e.prototype.copy=function(e,t,r){var i,s,o;return!r&&typeof i=="function"&&(r=i,i=null),s={root:this.fileRoot,to_path:this.normalizePath(t)},e instanceof n.CopyReference?s.from_copy_ref=e.tag:s.from_path=this.normalizePath(e),o=this.urls.fileopsCopy,this.oauth.addAuthParams("POST",o,s),n.Xhr.request("POST",o,s,null,function(e,t){return r(e,n.Stat.parse(t))})},e.prototype.move=function(e,t,r){var i,s,o;return!r&&typeof i=="function"&&(r=i,i=null),e=this.normalizePath(e),t=this.normalizePath(t),o=this.urls.fileopsMove,s={root:this.fileRoot,from_path:e,to_path:t},this.oauth.addAuthParams("POST",o,s),n.Xhr.request("POST",o,s,null,function(e,t){return r(e,n.Stat.parse(t))})},e.prototype.reset=function(){return this.uid=null,this.oauth.setToken(null,""),this.authState=r.RESET,this.authError=null,this._credentials=null,this},e.prototype.setCredentials=function(e){return this.oauth.reset(e),this.uid=e.uid||null,e.authState?this.authState=e.authState:e.token?this.authState=r.DONE:this.authState=r.RESET,this.authError=null,this._credentials=null,this},e.prototype.appHash=function(){return this.oauth.appHash()},e.prototype.setupUrls=function(){return this.fileRoot=this.sandbox?"sandbox":"dropbox",this.urls={requestToken:""+this.apiServer+"/1/oauth/request_token",authorize:""+this.authServer+"/1/oauth/authorize",accessToken:""+this.apiServer+"/1/oauth/access_token",signOut:""+this.apiServer+"/1/unlink_access_token",accountInfo:""+this.apiServer+"/1/account/info",getFile:""+this.fileServer+"/1/files/"+this.fileRoot,postFile:""+this.fileServer+"/1/files/"+this.fileRoot,putFile:""+this.fileServer+"/1/files_put/"+this.fileRoot,metadata:""+this.apiServer+"/1/metadata/"+this.fileRoot,delta:""+this.apiServer+"/1/delta",revisions:""+this.apiServer+"/1/revisions/"+this.fileRoot,restore:""+this.apiServer+"/1/restore/"+this.fileRoot,search:""+this.apiServer+"/1/search/"+this.fileRoot,shares:""+this.apiServer+"/1/shares/"+this.fileRoot,media:""+this.apiServer+"/1/media/"+this.fileRoot,copyRef:""+this.apiServer+"/1/copy_ref/"+this.fileRoot,thumbnails:""+this.fileServer+"/1/thumbnails/"+this.fileRoot,fileopsCopy:""+this.apiServer+"/1/fileops/copy",fileopsCreateFolder:""+this.apiServer+"/1/fileops/create_folder",fileopsDelete:""+this.apiServer+"/1/fileops/delete",fileopsMove:""+this.apiServer+"/1/fileops/move"}},e.ERROR=0,e.RESET=1,e.REQUEST=2,e.AUTHORIZED=3,e.DONE=4,e.SIGNED_OFF=5,e.prototype.urlEncodePath=function(e){return n.Xhr.urlEncodeValue(this.normalizePath(e)).replace(/%2F/gi,"/")},e.prototype.normalizePath=function(e){var t;if(e.substring(0,1)==="/"){t=1;while(e.substring(t,t+1)==="/")t+=1;return e.substring(t)}return e},e.prototype.requestToken=function(e){var t;return t=this.oauth.addAuthParams("POST",this.urls.requestToken,{}),n.Xhr.request("POST",this.urls.requestToken,t,null,e)},e.prototype.authorizeUrl=function(e){var t;return t={oauth_token:e,oauth_callback:this.driver.url()},""+this.urls.authorize+"?"+n.Xhr.urlEncode(t)},e.prototype.getAccessToken=function(e){var t;return t=this.oauth.addAuthParams("POST",this.urls.accessToken,{}),n.Xhr.request("POST",this.urls.accessToken,t,null,e)},e.prototype.defaultApiServer=function(){return"https://api.dropbox.com"},e.prototype.defaultAuthServer=function(){return this.apiServer.replace("api.","www.")},e.prototype.defaultFileServer=function(){return this.apiServer.replace("api.","api-content.")},e.prototype.computeCredentials=function(){var e;return e={key:this.oauth.key,sandbox:this.sandbox},this.oauth.secret&&(e.secret=this.oauth.secret),this.oauth.token&&(e.token=this.oauth.token,e.tokenSecret=this.oauth.tokenSecret),this.uid&&(e.uid=this.uid),this.authState!==r.ERROR&&this.authState!==r.RESET&&this.authState!==r.DONE&&this.authState!==r.SIGNED_OFF&&(e.authState=this.authState),this.apiServer!==this.defaultApiServer()&&(e.server=this.apiServer),this.authServer!==this.defaultAuthServer()&&(e.authServer=this.authServer),this.fileServer!==this.defaultFileServer()&&(e.fileServer=this.fileServer),this._credentials=e},e}(),r=n.Client,n.AuthDriver=function(){function e(){}return e.prototype.url=function(){return"https://some.url"},e.prototype.doAuthorize=function(e,t,n,r){return r("oauth-token")},e.prototype.onAuthStateChange=function(e,t){return t()},e}(),n.Drivers={},n.Drivers.Redirect=function(){function e(e){this.rememberUser=(e!=null?e.rememberUser:void 0)||!1,this.scope=(e!=null?e.scope:void 0)||"default",this.useQuery=(e!=null?e.useQuery:void 0)||!1,this.receiverUrl=this.computeUrl(e),this.tokenRe=new RegExp("(#|\\?|&)oauth_token=([^&#]+)(&|#|$)")}return e.prototype.url=function(){return this.receiverUrl},e.prototype.doAuthorize=function(e){return window.location.assign(e)},e.prototype.onAuthStateChange=function(e,t){var n,i=this;this.storageKey="dropbox-auth:"+this.scope+":"+e.appHash();switch(e.authState){case r.RESET:if(!(n=this.loadCredentials()))return t();if(n.authState)return n.token===this.locationToken()&&(n.authState===r.REQUEST&&(this.forgetCredentials(),n.authState=r.AUTHORIZED),e.setCredentials(n)),t();if(!this.rememberUser)return this.forgetCredentials(),t();return e.setCredentials(n),e.getUserInfo(function(n){return n&&(e.reset(),i.forgetCredentials()),t()});case r.REQUEST:return this.storeCredentials(e.credentials()),t();case r.DONE:return this.rememberUser&&this.storeCredentials(e.credentials()),t();case r.SIGNED_OFF:return this.forgetCredentials(),t();case r.ERROR:return this.forgetCredentials(),t();default:return t()}},e.prototype.computeUrl=function(){var e,t,r,i;return i="_dropboxjs_scope="+encodeURIComponent(this.scope),t=n.Drivers.Redirect.currentLocation(),t.indexOf("#")===-1?e=null:(r=t.split("#",2),t=r[0],e=r[1]),this.useQuery?t.indexOf("?")===-1?t+="?"+i:t+="&"+i:e="?"+i,e?t+"#"+e:t},e.prototype.locationToken=function(){var e,t,r;return e=n.Drivers.Redirect.currentLocation(),r="_dropboxjs_scope="+encodeURIComponent(this.scope)+"&",(typeof e.indexOf=="function"?e.indexOf(r):void 0)===-1?null:(t=this.tokenRe.exec(e),t?decodeURIComponent(t[2]):null)},e.currentLocation=function(){return window.location.href},e.prototype.storeCredentials=function(e){return localStorage.setItem(this.storageKey,JSON.stringify(e))},e.prototype.loadCredentials=function(){var e,t;t=localStorage.getItem(this.storageKey);if(!t)return null;try{return JSON.parse(t)}catch(n){return e=n,null}},e.prototype.forgetCredentials=function(){return localStorage.removeItem(this.storageKey)},e}(),n.Drivers.Popup=function(){function e(e){this.receiverUrl=this.computeUrl(e),this.tokenRe=new RegExp("(#|\\?|&)oauth_token=([^&#]+)(&|#|$)")}return e.prototype.doAuthorize=function(e,t,n,r){return this.listenForMessage(t,r),this.openWindow(e)},e.prototype.url=function(){return this.receiverUrl},e.prototype.computeUrl=function(e){var t;if(e){if(e.receiverUrl)return e.noFragment||e.receiverUrl.indexOf("#")!==-1?e.receiverUrl:e.receiverUrl+"#";if(e.receiverFile)return t=n.Drivers.Popup.currentLocation().split("/"),t[t.length-1]=e.receiverFile,e.noFragment?t.join("/"):t.join("/")+"#"}return n.Drivers.Popup.currentLocation()},e.currentLocation=function(){return window.location.href},e.prototype.openWindow=function(e){return window.open(e,"_dropboxOauthSigninWindow",this.popupWindowSpec(980,980))},e.prototype.popupWindowSpec=function(e,t){var n,r,i,s,o,u,a,f,l,c;return o=(a=window.screenX)!=null?a:window.screenLeft,u=(f=window.screenY)!=null?f:window.screenTop,s=(l=window.outerWidth)!=null?l:document.documentElement.clientWidth,n=(c=window.outerHeight)!=null?c:document.documentElement.clientHeight,r=Math.round(o+(s-e)/2),i=Math.round(u+(n-t)/2.5),"width="+e+",height="+t+","+("left="+r+",top="+i)+"dialog=yes,dependent=yes,scrollbars=yes,location=yes"},e.prototype.listenForMessage=function(e,t){var n,r;return r=this.tokenRe,n=function(i){var s;s=r.exec(i.data.toString());if(s&&decodeURIComponent(s[2])===e)return window.removeEventListener("message",n),t()},window.addEventListener("message",n,!1)},e}(),n.Drivers.NodeServer=function(){function e(e){this.port=(e!=null?e.port:void 0)||8912,this.faviconFile=(e!=null?e.favicon:void 0)||null,this.fs=require("fs"),this.http=require("http"),this.open=require("open"),this.callbacks={},this.urlRe=new RegExp("^/oauth_callback\\?"),this.tokenRe=new RegExp("(\\?|&)oauth_token=([^&]+)(&|$)"),this.createApp()}return e.prototype.url=function(){return"http://localhost:"+this.port+"/oauth_callback"},e.prototype.doAuthorize=function(e,t,n,r){return this.callbacks[t]=r,this.openBrowser(e)},e.prototype.openBrowser=function(e){if(!e.match(/^https?:\/\//))throw new Error("Not a http/https URL: "+e);return this.open(e)},e.prototype.createApp=function(){var e=this;return this.app=this.http.createServer(function(t,n){return e.doRequest(t,n)}),this.app.listen(this.port)},e.prototype.closeServer=function(){return this.app.close()},e.prototype.doRequest=function(e,t){var n,r,i,s=this;return this.urlRe.exec(e.url)&&(r=this.tokenRe.exec(e.url),r&&(i=decodeURIComponent(r[2]),this.callbacks[i]&&(this.callbacks[i](),delete this.callbacks[i]))),n="",e.on("data",function(e){return n+=e}),e.on("end",function(){return s.faviconFile&&e.url==="/favicon.ico"?s.sendFavicon(t):s.closeBrowser(t)})},e.prototype.closeBrowser=function(e){var t;return t='<!doctype html>\n<script type="text/javascript">window.close();</script>\n<p>Please close this window.</p>',e.writeHead(200,{"Content-Length":t.length,"Content-Type":"text/html"}),e.write(t),e.end},e.prototype.sendFavicon=function(e){return this.fs.readFile(this.faviconFile,function(t,n){return e.writeHead(200,{"Content-Length":n.length,"Content-Type":"image/x-icon"}),e.write(n),e.end})},e}(),y=function(e,t){return h(j(X(e),X(t),e.length,t.length))},b=function(e){return h(W(X(e),e.length))};if(typeof window=="undefined"||window===null)L=require("crypto"),y=function(e,t){var n;return n=L.createHmac("sha1",t),n.update(e),n.digest("base64")},b=function(e){var t;return t=L.createHash("sha1"),t.update(e),t.digest("base64")};j=function(e,t,n,r){var i,s,o,u;return t.length>16&&(t=W(t,r)),o=function(){var e,n;n=[];for(s=e=0;e<16;s=++e)n.push(t[s]^909522486);return n}(),u=function(){var e,n;n=[];for(s=e=0;e<16;s=++e)n.push(t[s]^1549556828);return n}(),i=W(o.concat(e),64+n),W(u.concat(i),84)},W=function(e,t){var n,r,i,s,o,u,a,f,l,h,p,d,v,m,g,y,b,w;e[t>>2]|=1<<31-((t&3)<<3),e[(t+8>>6<<4)+15]=t<<3,y=Array(80),n=1732584193,i=-271733879,o=-1732584194,a=271733878,l=-1009589776,d=0,g=e.length;while(d<g){r=n,s=i,u=o,f=a,h=l;for(v=w=0;w<80;v=++w)v<16?y[v]=e[d+v]:y[v]=z(y[v-3]^y[v-8]^y[v-14]^y[v-16],1),v<20?(p=i&o|~i&a,m=1518500249):v<40?(p=i^o^a,m=1859775393):v<60?(p=i&o|i&a|o&a,m=-1894007588):(p=i^o^a,m=-899497514),b=c(c(z(n,5),p),c(c(l,y[v]),m)),l=a,a=o,o=z(i,30),i=n,n=b;n=c(n,r),i=c(i,s),o=c(o,u),a=c(a,f),l=c(l,h),d+=16}return[n,i,o,a,l]},z=function(e,t){return e<<t|e>>>32-t},c=function(e,t){var n,r;return r=(e&65535)+(t&65535),n=(e>>16)+(t>>16)+(r>>16),n<<16|r&65535},h=function(e){var t,n,r,i,s;i="",t=0,r=e.length*4;while(t<r)n=t,s=(e[n>>2]>>(3-(n&3)<<3)&255)<<16,n+=1,s|=(e[n>>2]>>(3-(n&3)<<3)&255)<<8,n+=1,s|=e[n>>2]>>(3-(n&3)<<3)&255,i+=J[s>>18&63],i+=J[s>>12&63],t+=1,t>=r?i+="=":i+=J[s>>6&63],t+=1,t>=r?i+="=":i+=J[s&63],t+=1;return i},J="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",X=function(e){var t,n,r,i,s;t=[],r=255;for(n=i=0,s=e.length;0<=s?i<s:i>s;n=0<=s?++i:--i)t[n>>2]|=(e.charCodeAt(n)&r)<<(3-(n&3)<<3);return t},n.Oauth=function(){function e(e){this.key=this.k=null,this.secret=this.s=null,this.token=null,this.tokenSecret=null,this._appHash=null,this.reset(e)}return e.prototype.reset=function(e){var t,n,r,i;if(e.secret)this.k=this.key=e.key,this.s=this.secret=e.secret,this._appHash=null;else if(e.key)this.key=e.key,this.secret=null,r=p(O(this.key).split("|",2)[1]),i=r.split("?",2),t=i[0],n=i[1],this.k=decodeURIComponent(t),this.s=decodeURIComponent(n),this._appHash=null;else if(!this.k)throw new Error("No API key supplied");return e.token?this.setToken(e.token,e.tokenSecret):this.setToken(null,"")},e.prototype.setToken=function(e,t){if(e&&!t)throw new Error("No secret supplied with the user token");return this.token=e,this.tokenSecret=t||"",this.hmacKey=s.urlEncodeValue(this.s)+"&"+s.urlEncodeValue(t),null},e.prototype.authHeader=function(e,t,n){var r,i,o,u,a,f;this.addAuthParams(e,t,n),i=[];for(o in n)u=n[o],o.substring(0,6)==="oauth_"&&i.push(o);i.sort(),r=[];for(a=0,f=i.length;a<f;a++)o=i[a],r.push(s.urlEncodeValue(o)+'="'+s.urlEncodeValue(n[o])+'"'),delete n[o];return"OAuth "+r.join(",")},e.prototype.addAuthParams=function(e,t,n){return this.boilerplateParams(n),n.oauth_signature=this.signature(e,t,n),n},e.prototype.boilerplateParams=function(e){return e.oauth_consumer_key=this.k,e.oauth_nonce=this.nonce(),e.oauth_signature_method="HMAC-SHA1",this.token&&(e.oauth_token=this.token),e.oauth_timestamp=Math.floor(Date.now()/1e3),e.oauth_version="1.0",e},e.prototype.nonce=function(){return Date.now().toString(36)+Math.random().toString(36)},e.prototype.signature=function(e,t,n){var r;return r=e.toUpperCase()+"&"+s.urlEncodeValue(t)+"&"+s.urlEncodeValue(s.urlEncode(n)),y(r,this.hmacKey)},e.prototype.appHash=function(){return this._appHash?this._appHash:this._appHash=b(this.k).replace(/\=/g,"")},e}(),Date.now==null&&(Date.now=function(){return(new Date).getTime()}),i=n.Oauth,O=function(e,t){var n,r,i,s,o,u,a,f,l,c,h,d;t?(t=[encodeURIComponent(e),encodeURIComponent(t)].join("?"),e=function(){var t,r,i;i=[];for(n=t=0,r=e.length/2;0<=r?t<r:t>r;n=0<=r?++t:--t)i.push((e.charCodeAt(n*2)&15)*16+(e.charCodeAt(n*2+1)&15));return i}()):(c=e.split("|",2),e=c[0],t=c[1],e=p(e),e=function(){var t,r,i;i=[];for(n=t=0,r=e.length;0<=r?t<r:t>r;n=0<=r?++t:--t)i.push(e.charCodeAt(n));return i}(),t=p(t)),s=function(){d=[];for(f=0;f<256;f++)d.push(f);return d}.apply(this),u=0;for(o=l=0;l<256;o=++l)u=(u+s[n]+e[o%e.length])%256,h=[s[u],s[o]],s[o]=h[0],s[u]=h[1];return o=u=0,i=function(){var e,n,i,f;f=[];for(a=e=0,n=t.length;0<=n?e<n:e>n;a=0<=n?++e:--e)o=(o+1)%256,u=(u+s[o])%256,i=[s[u],s[o]],s[o]=i[0],s[u]=i[1],r=s[(s[o]+s[u])%256],f.push(String.fromCharCode((r^t.charCodeAt(a))%256));return f}(),e=function(){var t,r,i;i=[];for(n=t=0,r=e.length;0<=r?t<r:t>r;n=0<=r?++t:--t)i.push(String.fromCharCode(e[n]));return i}(),[w(e.join("")),w(i.join(""))].join("|")},n.PulledChanges=function(){function e(e){var t;this.blankSlate=e.reset||!1,this.cursorTag=e.cursor,this.shouldPullAgain=e.has_more,this.shouldBackOff=!this.shouldPullAgain,e.cursor&&e.cursor.length?this.changes=function(){var r,i,s,o;s=e.entries,o=[];for(r=0,i=s.length;r<i;r++)t=s[r],o.push(n.PullChange.parse(t));return o}():this.changes=[]}return e.parse=function(e){return e&&typeof e=="object"?new n.PulledChanges(e):e},e.prototype.blankSlate=void 0,e.prototype.cursorTag=void 0,e.prototype.changes=void 0,e.prototype.shouldPullAgain=void 0,e.prototype.shouldBackOff=void 0,e}(),n.PullChange=function(){function e(e){this.path=e[0],this.stat=n.Stat.parse(e[1]),this.stat?this.wasRemoved=!1:(this.stat=null,this.wasRemoved=!0)}return e.parse=function(e){return e&&typeof e=="object"?new n.PullChange(e):e},e.prototype.path=void 0,e.prototype.wasRemoved=void 0,e.prototype.stat=void 0,e}(),n.PublicUrl=function(){function e(e,t){this.url=e.url,this.expiresAt=new Date(Date.parse(e.expires)),t===!0?this.isDirect=!0:t===!1?this.isDirect=!1:this.isDirect=Date.now()-this.expiresAt<=864e5,this.isPreview=!this.isDirect}return e.parse=function(e,t){return e&&typeof e=="object"?new n.PublicUrl(e,t):e},e.prototype.url=void 0,e.prototype.expiresAt=void 0,e.prototype.isDirect=void 0,e.prototype.isPreview=void 0,e}(),n.CopyReference=function(){function e(e){typeof e=="object"?(this.tag=e.copy_ref,this.expiresAt=new Date(Date.parse(e.expires))):(this.tag=e,this.expiresAt=new Date)}return e.parse=function(e){return!e||typeof e!="object"&&typeof e!="string"?e:new n.CopyReference(e)},e.prototype.tag=void 0,e.prototype.expiresAt=void 0,e}(),n.Stat=function(){function e(e){var t,n,r,i;this.path=e.path,this.path.substring(0,1)!=="/"&&(this.path="/"+this.path),t=this.path.length-1,t>=0&&this.path.substring(t)==="/"&&(this.path=this.path.substring(0,t)),n=this.path.lastIndexOf("/"),this.name=this.path.substring(n+1),this.isFolder=e.is_dir||!1,this.isFile=!this.isFolder,this.isRemoved=e.is_deleted||!1,this.typeIcon=e.icon,((r=e.modified)!=null?r.length:void 0)?this.modifiedAt=new Date(Date.parse(e.modified)):this.modifiedAt=null,((i=e.client_mtime)!=null?i.length:void 0)?this.clientModifiedAt=new Date(Date.parse(e.client_mtime)):this.clientModifiedAt=null;switch(e.root){case"dropbox":this.inAppFolder=!1;break;case"app_folder":this.inAppFolder=!0;break;default:this.inAppFolder=null}this.size=e.bytes||0,this.humanSize=e.size||"",this.hasThumbnail=e.thumb_exists||!1,this.isFolder?(this.versionTag=e.hash,this.mimeType=e.mime_type||"inode/directory"):(this.versionTag=e.rev,this.mimeType=e.mime_type||"application/octet-stream")}return e.parse=function(e){return e&&typeof e=="object"?new n.Stat(e):e},e.prototype.path=null,e.prototype.name=null,e.prototype.inAppFolder=null,e.prototype.isFolder=null,e.prototype.isFile=null,e.prototype.isRemoved=null,e.prototype.typeIcon=null,e.prototype.versionTag=null,e.prototype.mimeType=null,e.prototype.size=null,e.prototype.humanSize=null,e.prototype.hasThumbnail=null,e.prototype.modifiedAt=null,e.prototype.clientModifiedAt=null,e}(),n.UserInfo=function(){function e(e){var t;this.name=e.display_name,this.email=e.email,this.countryCode=e.country||null,this.uid=e.uid.toString(),e.public_app_url?(this.publicAppUrl=e.public_app_url,t=this.publicAppUrl.length-1,t>=0&&this.publicAppUrl.substring(t)==="/"&&(this.publicAppUrl=this.publicAppUrl.substring(0,t))):this.publicAppUrl=null,this.referralUrl=e.referral_link,this.quota=e.quota_info.quota,this.privateBytes=e.quota_info.normal||0,this.sharedBytes=e.quota_info.shared||0,this.usedQuota=this.privateBytes+this.sharedBytes}return e.parse=function(e){return e&&typeof e=="object"?new n.UserInfo(e):e},e.prototype.name=null,e.prototype.email=null,e.prototype.countryCode=null,e.prototype.uid=null,e.prototype.referralUrl=null,e.prototype.publicAppUrl=null,e.prototype.quota=null,e.prototype.usedQuota=null,e.prototype.privateBytes=null,e.prototype.sharedBytes=null,e}(),typeof window!="undefined"&&window!==null?!window.XDomainRequest||"withCredentials"in new XMLHttpRequest?(a=window.XMLHttpRequest,u=!1,o=window.navigator.userAgent.indexOf("Firefox")===-1):(a=window.XDomainRequest,u=!0,o=!1):(a=require("xmlhttprequest").XMLHttpRequest,u=!1,o=!1),n.Xhr=function(){function e(){}return e.Request=a,e.ieMode=u,e.canSendForms=o,e.request=function(e,t,n,r,i){return this.request2(e,t,n,r,null,null,i)},e.request2=function(e,t,n,r,i,o,u){var a,f,l;return f=e==="GET"||i!=null||this.ieMode,f&&(l=s.urlEncode(n),l.length!==0&&(t=[t,"?",s.urlEncode(n)].join(""))),a={},r&&(a.Authorization=r),i!=null?typeof i=="string"&&(a["Content-Type"]="text/plain; charset=utf8"):f||(a["Content-Type"]="application/x-www-form-urlencoded",i=s.urlEncode(n)),s.xhrRequest(e,t,a,i,o,u)},e.multipartRequest=function(e,t,n,r,i){var o,u,a,f,l,c;return e=[e,"?",s.urlEncode(n)].join(""),a=t.value,c=typeof a=="object"&&(typeof Blob!="undefined"&&Blob!==null&&t.value instanceof Blob||typeof File!="undefined"&&File!==null&&t.value instanceof File),c?(l={},o=new FormData,o.append(t.name,a,t.fileName)):(f=t.contentType||"application/octet-stream",u=this.multipartBoundary(),l={"Content-Type":"multipart/form-data; boundary="+u},o=["--",u,"\r\n",'Content-Disposition: form-data; name="',t.name,'"; filename="',t.fileName,'"\r\n',"Content-Type: ",f,"\r\n","Content-Transfer-Encoding: binary\r\n\r\n",a,"\r\n","--",u,"--","\r\n"].join("")),r&&(l.Authorization=r),s.xhrRequest("POST",e,l,o,null,i)},e.multipartBoundary=function(){return[Date.now().toString(36),Math.random().toString(36)].join("----")},e.xhrRequest=function(e,t,n,r,i,o){var u,a,f;f=new this.Request,this.ieMode?(f.onload=function(){return s.onLoad(f,e,t,o)},f.onerror=function(){return s.onError(f,e,t,o)}):f.onreadystatechange=function(){return s.onReadyStateChange(f,e,t,i,o)},f.open(e,t,!0),i&&(i==="b"?f.overrideMimeType&&f.overrideMimeType("text/plain; charset=x-user-defined"):f.responseType=i);if(!this.ieMode)for(u in n){if(!G.call(n,u))continue;a=n[u],f.setRequestHeader(u,a)}return r!=null?f.send(r):f.send(),f},e.urlEncode=function(e){var t,n,r;t=[];for(n in e)r=e[n],t.push(this.urlEncodeValue(n)+"="+this.urlEncodeValue(r));return t.sort().join("&")},e.urlEncodeValue=function(e){return encodeURIComponent(e.toString()).replace(/\!/g,"%21").replace(/'/g,"%27").replace(/\(/g,"%28").replace(/\)/g,"%29").replace(/\*/g,"%2A")},e.urlDecode=function(e){var t,n,r,i,s,o;n={},o=e.split("&");for(i=0,s=o.length;i<s;i++)r=o[i],t=r.split("="),n[decodeURIComponent(t[0])]=decodeURIComponent(t[1]);return n},e.onReadyStateChange=function(e,t,r,i,o){var u,a,f,l,c,h,p,d,v,m;if(e.readyState!==4)return!0;if(e.status<200||e.status>=300)return u=new n.ApiError(e,t,r),o(u),!0;p=e.getResponseHeader("x-dropbox-metadata");if(p!=null?p.length:void 0)try{h=JSON.parse(p)}catch(g){l=g,h=void 0}else h=void 0;if(i){if(i==="b"){f=e.responseText!=null?e.responseText:e.response,a=[];for(c=v=0,m=f.length;0<=m?v<m:v>m;c=0<=m?++v:--v)a.push(String.fromCharCode(f.charCodeAt(c)&255));d=a.join(""),o(null,d,h)}else o(null,e.response,h);return!0}d=e.responseText!=null?e.responseText:e.response;switch(e.getResponseHeader("Content-Type")){case"application/x-www-form-urlencoded":o(null,s.urlDecode(d),h);break;case"application/json":case"text/javascript":o(null,JSON.parse(d),h);break;default:o(null,d,h)}return!0},e.onLoad=function(e,t,n,r){var i;i=e.responseText;switch(e.contentType){case"application/x-www-form-urlencoded":r(null,s.urlDecode(i),void 0);break;case"application/json":case"text/javascript":r(null,JSON.parse(i),void 0);break;default:r(null,i,void 0)}return!0},e.onError=function(e,t,r,i){var s;return s=new n.ApiError(e,t,r),i(s),!0},e}(),s=n.Xhr;if((typeof module!=="undefined"&&module!==null?module.exports:void 0)!=null)module.exports=n;else{if(typeof window=="undefined"||window===null)throw new Error("This library only supports node.js and modern browsers.");window.Dropbox=n}n.atob=p,n.btoa=w,n.hmac=y,n.sha1=b,n.encodeKey=O,function(){var e
,t,n,r,i,s,o,u,a,f,l,c,h;return typeof D!="undefined"?a=D:a=this.Nimbus={},a.version="0.0.1",e=a.$=this.jQuery||this.Zepto||function(){return arguments[0]},a.dictModel={},c=function(e){return Array.prototype.slice.call(e,0)},l=function(e){return Object.prototype.toString.call(e)==="[object Array]"},typeof Array.prototype.indexOf=="undefined"&&(Array.prototype.indexOf=function(e){var t;t=0;while(t<this.length){if(this[t]===e)return t;t++}return-1}),o={bind:function(e,t){var n,r,i;r=e.split(" "),n=this._callbacks||(this._callbacks={}),i=0;while(i<r.length)(this._callbacks[r[i]]||(this._callbacks[r[i]]=[])).push(t),i++;return this},trigger:function(){var e,t,n,r,i,s;e=c(arguments),n=e.shift();if(!(t=this._callbacks))return!1;if(!(s=this._callbacks[n]))return!1;r=0,i=s.length;while(r<i){if(s[r].apply(this,e)===!1)return!1;r++}return!0},unbind:function(e,t){var n,r,i,s;if(!e)return this._callbacks={},this;if(!(n=this._callbacks))return this;if(!(s=n[e]))return this;if(!t)return delete this._callbacks[e],this;r=0,i=s.length;while(r<i){if(t===s[r]){s=s.slice(),s.splice(r,1),n[e]=s;break}r++}return this}},typeof Object.create!="function"&&(Object.create=function(e){var t;return t=function(){},t.prototype=e,new t}),h=["included","extended"],r={inherited:function(){},created:function(){},prototype:{initialize:function(){},init:function(){}},create:function(e,t){var n;return n=Object.create(this),n.parent=this,n.prototype=n.fn=Object.create(this.prototype),e&&n.include(e),t&&n.extend(t),n.created(),this.inherited(n),n},init:function(){var e;return e=Object.create(this.prototype),e.parent=this,e.initialize.apply(e,arguments),e.init.apply(e,arguments),e},proxy:function(e){var t;return t=this,function(){return e.apply(t,arguments)}},proxyAll:function(){var e,t,n;e=c(arguments),t=0,n=[];while(t<e.length)this[e[t]]=this.proxy(this[e[t]]),n.push(t++);return n},include:function(e){var t,n;for(n in e)h.indexOf(n)===-1&&(this.fn[n]=e[n]);return t=e.included,t&&t.apply(this),this},extend:function(e){var t,n;for(n in e)h.indexOf(n)===-1&&(this[n]=e[n]);return t=e.extended,t&&t.apply(this),this}},r.prototype.proxy=r.proxy,r.prototype.proxyAll=r.proxyAll,r.inst=r.init,r.sub=r.create,a.guid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t,n;return t=Math.random()*16|0,n=e==="x"?t:t&3|8,n.toString(16)}).toUpperCase()},t=a.Auth=r.create(),t.extend({reinitialize:function(){log("reintialize called");if(localStorage["service"]!=null)return log("the service exists",localStorage.service),this.setup(localStorage.service,localStorage.d_key,localStorage.secret,localStorage.app_name),this.initialize()},setup:function(e,t,n,r,i){typeof e=="string"&&(t==null||n==null||r==null)&&(e=JSON.parse(Base64.decode(e)));if(typeof e=="string"){log("setup called"),this.service=e,this.key=t,this.secret=n,this.app_name=r,i!=null&&(this.client_secret=i),localStorage.service=this.service,localStorage.d_key=this.key,localStorage.secret=this.secret,localStorage.app_name=this.app_name,i!=null&&(localStorage.client_secret=this.client_secret);switch(this.service){case"Dropbox":this.extend(a.Auth.Dropbox_auth),this.authorize=this.proxy(this.authenticate_dropbox),this.initialize=this.proxy(this.initialize_dropbox),this.authorized=this.proxy(this.dropbox_authorized),this.logout=this.proxy(this.logout_dropbox),log("service is dropbox");break;case"GDrive":this.extend(a.Auth.GDrive),this.authorize=this.proxy(this.authenticate_gdrive),this.initialize=this.proxy(this.initialize_gdrive),this.authorized=this.proxy(this.gdrive_authorized),this.logout=this.proxy(this.logout_gdrive),log("service is GDrive"),a.Share.setup(this.service);break;default:log("Invalid service name")}a.Binary.setup(this.service)}else typeof e=="object"&&(log("new method for setup, the service is there"),this.sync_services=e,this.models={},localStorage["service"]!=null?localStorage.service==="GDrive"?this.setup(localStorage.service,localStorage.d_key,localStorage.secret,localStorage.app_name,localStorage.client_secret):this.setup(localStorage.service,localStorage.d_key,localStorage.secret,localStorage.app_name):(this.extend(a.Auth.Multi),this.authorize=this.proxy(this.authenticate_service),this.initialize=this.proxy(this.initialize_service)))},authorized:function(){return log("authorized not yet setup")},state:function(){return localStorage.state},authorize:function(){return log("authorize not yet setup")},initialize:function(){return log("initialize not setup")},authorized_callback:function(){return log("authorized callback undefined")},app_ready_func:function(){return log("app_ready"),this.app_ready=!0},set_app_ready:function(e){return log("set app ready"),this.app_ready!=null&&this.app_ready?e():this.app_ready_func=e},logout:function(){return log("logout not implemented")}}),i=a.Client=r.create(),f=a.Share=r.create(),f.extend({setup:function(e){switch(e){case"GDrive":return log("share api with GDrive"),this.extend(a.Client.GDrive),this.get_users=this.proxy(this.get_shared_users),this.add_user=this.proxy(this.add_share_user),this.remove_user=this.proxy(this.remove_share_user),this.get_me=this.proxy(this.get_current_user),this.get_spaces=this.proxy(this.get_app_folders),this.switch_spaces=this.proxy(this.switch_to_app_folder);default:return log("share not supported with this service")}},get_users:function(){return log("users not implemented")},add_user:function(e){return log("add a user")},remove_user:function(e){return log("removed user")},get_me:function(){return log("get currently logged user")},get_spaces:function(){return log("get current spaces")},switch_spaces:function(e){return log("switch space")}}),n=a.Binary=r.create(),n.extend({setup:function(e){log("binary setup called");switch(e){case"Dropbox":return this.extend(a.Client.Dropbox.Binary),a.Client.Dropbox.Binary.binary_setup(),log("service is dropbox");case"GDrive":return this.extend(a.Client.GDrive.Binary),a.Client.GDrive.Binary.binary_setup(),log("service is GDrive");default:return log("Invalid service name")}},upload_blob:function(e,t,n){return log("upload blob")},upload_file:function(e,t){return log("upload blob")},read_file:function(e,t){return log("read file")},share_link:function(e,t){return log("share link")},direct_link:function(e,t){return log("direct link")},delete_file:function(e){return log("delete file")}}),s=a.DB=r.create(),s.extend(o),s.extend({setup_db:function(e){log("setup db");switch(e){case"localStorage":return Storage.prototype.setItem=function(e,t){return this===window.localStorage?log("local storage called"):_setItem.apply(this,arguments)}}}}),u=a.Model=r.create(),u.extend(o),u.extend({service_setup:function(e){var t;log("service setup model",e),t=e.attributes;switch(a.Auth.service){case"Dropbox":log("extend as Dropbox"),e.extend(a.Model.general_sync),e.extend(a.Model.Dropbox),t.push("synced"),t.push("time"),e.attributes=t;break;case"GDrive":log("extend as GDrive"),e.extend(a.Model.general_sync),e.extend(a.Model.GDrive),t.push("gid"),t.push("synced"),t.push("time"),e.attributes=t,window.model_initialize(e);break;default:log("Invalid service name")}return e},setup:function(e,t){var n,r;return log("model setup"),r=u.sub(),e&&(r.name=e),t&&(r.attributes=t),r.extend(a.Model.Local),a.Auth.service!=null||a.Auth.sync_services!=null||e==="binary"||e==="binary_Deletion"?(log("model 1",r),e.indexOf("_Deletion")<0&&(r=this.service_setup(r))):(log("name:",e),log("Please setup Nimbus.Auth first before creating models")),e.indexOf("_Deletion")<0&&(n=a.Model.setup(e+"_"+"Deletion",["deletion_id","listid"]),n.extend(a.Model.Local),n.fetch(),r.DeletionStorage=n),log(r),r.fetch(),e.indexOf("_Deletion")<0&&(a.dictModel[e]=r),r},created:function(e){return this.records={},this.attributes=this.attributes?c(this.attributes):[]},find:function(e){var t;t=this.records[e];if(!t)throw"Unknown record";return t.clone()},exists:function(e){var t;try{return this.find(e)}catch(n){return t=n,!1}},refresh:function(e){var t,n,r;e=this.fromJSON(e),this.records={},t=0,n=e.length;while(t<n)r=e[t],r.newRecord=!1,this.records[r.id]=r,t++;return this.trigger("refresh"),this},select:function(e){var t,n;n=[];for(t in this.records)e(this.records[t])&&n.push(this.records[t]);return this.cloneArray(n)},findByAttribute:function(e,t){var n;for(n in this.records)if(this.records[n][e]===t)return this.records[n].clone()},findAllByAttribute:function(e,t){return this.select(function(n){return n[e]===t})},each:function(e){var t,n;n=[];for(t in this.records)n.push(e(this.records[t]));return n},all:function(){return this.cloneArray(this.recordsValues())},first:function(){var e;return e=this.recordsValues()[0],e&&e.clone()},last:function(){var e,t;return t=this.recordsValues(),e=t[t.length-1],e&&e.clone()},count:function(){return this.recordsValues().length},deleteAll:function(){var e,t;t=[];for(e in this.records)t.push(delete this.records[e]);return t},destroyAll:function(){var e,t;t=[];for(e in this.records)t.push(this.records[e].destroy());return t},update:function(e,t){return this.find(e).updateAttributes(t)},create:function(e){var t;return t=this.init(e),t.save()},destroy:function(e){return this.find(e).destroy()},sync:function(e){return this.bind("change",e)},fetch:function(e){return typeof e=="function"?this.bind("fetch",e):this.trigger.apply(this,["fetch"].concat(c(arguments)))},toJSON:function(){return this.recordsValues()},fromJSON:function(e){var t,n;if(!e)return;typeof e=="string"&&(e=JSON.parse(e));if(l(e)){n=[],t=0;while(t<e.length)n.push(this.init(e[t])),t++;return n}return this.init(e)},recordsValues:function(){var e,t;t=[];for(e in this.records)t.push(this.records[e]);return t},cloneArray:function(e){var t,n;n=[],t=0;while(t<e.length)n.push(e[t].clone()),t++;return n}}),u.include({model:!0,newRecord:!0,init:function(e){return e&&this.load(e),this.trigger("init",this)},isNew:function(){return this.newRecord},isValid:function(){return!this.validate()},validate:function(){},load:function(e){var t,n;n=[];for(t in e)n.push(this[t]=e[t]);return n},attributes:function(){var e,t,n;n={},t=0;while(t<this.parent.attributes.length)e=this.parent.attributes[t],n[e]=this[e],t++;return n.id=this.id,n},eql:function(e){return e&&e.id===this.id&&e.parent===this.parent},save:function(){var e;return e=this.validate(),e?(this.trigger("error",this,e),!1):(this.trigger("beforeSave",this),this.newRecord?this.create():this.update(),this.trigger("save",this),this)},updateAttribute:function(e,t){return this[e]=t,this.save()},updateAttributes:function(e){return this.load(e),this.save()},destroy:function(){return this.trigger("beforeDestroy",this),delete this.parent.records[this.id],this.destroyed=!0,this.trigger("destroy",this),this.trigger("change",this,"destroy")},dup:function(){var e;return e=this.parent.init(this.attributes()),e.newRecord=this.newRecord,e},clone:function(){return Object.create(this)},reload:function(){var e;return this.newRecord?this:(e=this.parent.find(this.id),this.load(e.attributes()),e)},toJSON:function(){return this.attributes()},exists:function(){return this.id&&this.id in this.parent.records},update:function(){var e,t;return this.trigger("beforeUpdate",this),t=this.parent.records,t[this.id].load(this.attributes()),e=t[this.id].clone(),this.trigger("update",e),this.trigger("change",e,"update")},create:function(){var e,t;return this.trigger("beforeCreate",this),this.id||(this.id=a.guid()),this.newRecord=!1,t=this.parent.records,t[this.id]=this.dup(),e=t[this.id].clone(),this.trigger("create",e),this.trigger("change",e,"create")},bind:function(e,t){return this.parent.bind(e,this.proxy(function(e){if(e&&this.eql(e))return t.apply(this,arguments)}))},trigger:function(){return this.parent.trigger.apply(this.parent,arguments)}})}(),l=function(){function e(e){this._set=e===void 0?[]:e,this.length=this._set.length,this.contains=function(e){return this._set.indexOf(e)!==-1}}return e.prototype.union=function(e){var t,n,r,i;t=e.length>this.length?e:this,n=e.length>this.length?this:e,i=t.copy(),r=0;while(r<n.length)i.add(n._set[r]),r++;return i},e.prototype.intersection=function(t){var n,r,i,s,o;o=new e,n=t.length>this.length?t:this,r=t.length>this.length?this:t,s=0;while(s<r.length)i=r._set[s],n.contains(i)&&o.add(i),s++;return o},e.prototype.difference=function(t){var n,r,i;i=new e,r=0;while(r<this.length)n=this._set[r],t.contains(n)||i.add(n),r++;return i},e.prototype.symmetricDifference=function(e){return this.union(e).difference(this.intersection(e))},e.prototype.isSuperSet=function(e){var t;t=0;while(t<e.length){if(!this.contains(e._set[t]))return!1;t++}return!0},e.prototype.isSubSet=function(e){var t;t=0;while(t<this.length){if(!e.contains(this._set[t]))return!1;t++}return!0},e.prototype.add=function(e){return this._set.indexOf(e)===-1&&(this._set.push(e),this.length++),this.length},e.prototype.remove=function(e){var t;return t=this._set.indexOf(e),t!==-1?(this.length--,this._set.splice(t,1)[0]):null},e.prototype.copy=function(){return new e(this._set.slice())},e.prototype.asArray=function(){return this._set},e}(),D=this,D.Set=l,e=function(){function e(e){this.callback=e,this.ready=Y(this.ready,this),this.ok=Y(this.ok,this),this.wait=Y(this.wait,this),this.count=1}return e.prototype.wait=function(){return this.count++},e.prototype.ok=function(){if(!--this.count)return this.callback()},e.prototype.ready=function(){return this.ok()},e}(),f=function(){function e(){this.execute_callback=Y(this.execute_callback,this),this.add_last_call=Y(this.add_last_call,this),this.add_call=Y(this.add_call,this),this.running=!1,this.callbacks=[]}return e.prototype.add_call=function(e){return this.running=!0,this.callbacks.push(e)},e.prototype.add_last_call=function(e){return this.last_callback=e},e.prototype.execute_callback=function(){var e,t,n,r;r=this.callbacks;for(t=0,n=r.length;t<n;t++)e=r[t],e();return this.callbacks=[],this.last_callback!=null&&this.last_callback(),this.running=!1},e}(),t=function(){function e(){this.ready=Y(this.ready,this),this.ok=Y(this.ok,this),this.wait=Y(this.wait,this),this.count=1}return e.prototype.wait=function(){return this.count++},e.prototype.ok=function(){if(!--this.count)return log("ok executed")},e.prototype.ready=function(){return this.ok()},e}(),D=this,D.DelayedOp=e,D.OneOp=f,D.DelayedSyncAnimation=t,window.debug=!1,window.log=function(){var e;e=1<=arguments.length?Z.call(arguments,0):[];if(window.debug)return console.log(e)},window.one_time_sync=!1,window.keys=function(e){var t,n,r;n=[];for(t in e)r=e[t],n.push(t);return n},Nimbus.Model.general_sync={cloudcache:{},create_object_dictionary:function(){var e,t,n,r,i;e={},log("object:",this),i=this.all();for(n=0,r=i.length;n<r;n++)t=i[n],e[t.id]=t;return e},sync_model_base_algo:function(){var e,t,n,r,i,s,o,u,a,f,c,h,p,d,v,m,g,y,b,w,E,S,x,T,N,C;log("#ONE TIME SYNC ALGO RUNNING",this.name),window.one_time_sync=!0,window.currently_syncing=!0,a=this.create_object_dictionary(),e=this.cloudcache,c=new l(keys(a)),t=new l(keys(e)),log("local_set",c),log("cloud_set",t),r=[],x=this.DeletionStorage.all();for(v=0,b=x.length;v<b;v++)s=x[v],this.delete_from_cloud(s.id),r.push(s.id),s.destroy();i=new l(r),log("deleted set",i),log("#the set of ids that are there locally but not there on the cloud",c.difference(t)._set),T=c.difference(t)._set;for(m=0,w=T.length;m<w;m++)u=T[m],f=a[u],f["synced"]!=null&&f.synced?(log("id for deletion",u),a[u].destroy()):this.add_to_cloud(f);log("#the set of ids that are there on the cloud but not there locally minus deletions",t.difference(c).difference(i)._set),N=t.difference(c).difference(i)._set;for(g=0,E=N.length;g<E;g++)u=N[g],this.add_from_cloud(u);log("#the set of ids that are there in the cloud and locally",t.intersection(c)._set),p=[],d=[],o=[],C=t.intersection(c)._set;for(y=0,S=C.length;y<S;y++)u=C[y],h=new Date(a[u].time),n=new Date(e[u].time),log("local_time",h.toString()),log("cloud_time",n.toString()),h-n===0?(log("equal time stamp do nothin",e[u].title),o.push(u)):h-n>0?(this.update_to_cloud(a[u]),p.push(u)):(this.update_to_local(a[u]),d.push(u));return window.currently_syncing=!1,window.one_time_sync=!1,log("updated to cloud",p.length,p),log("updated to local",d.length,d),log("equal timestamp",o.length,o)},real_time_sync:function(e,t,n){var r,i;log("method",t),log("record",e),this.saveLocal();if(window.currently_syncing)return!0;t==="update"&&(this.records[e.id].time=(new Date).toString()),i=navigator.onLine&&(localStorage.state==="Working"||Nimbus.Client.GDrive.check_auth());if(!i)return console.log("syncing is not setup correctly or the instance is not online"),!0;switch(t){case"destroy":if(e.synced)return i?(log("deletion in cloud"),this.delete_from_cloud(e.id)):(r=Deletion.init({id:e.id}),r.save());break;case"create":return this.add_to_cloud(e,function(){});case"update":return this.update_to_cloud(e,function(){});case"read":return this.update_to_local(e,function(){});default:return log("REAL TIME SYNCING FAILED, THIS METHOD NOT IMPLEMENTED")}},delta_update:function(){var e;return e=this.get_delta}},Nimbus.Model.Local={extended:function(){return this.sync(this.proxy(this.saveLocal)),this.fetch(this.proxy(this.loadLocal))},saveLocal:function(){var e;return e=JSON.stringify(this),localStorage[this.name]=e},loadLocal:function(){var e;e=localStorage[this.name];if(!e)return;return e=JSON.parse(e),this.refresh(e)}},Nimbus.Model.Dropbox={cloudcache:{},last_hash:"",hash:"",toCloudStructure:function(e){return log("local to cloud structure"),JSON.stringify(e)},fromCloudStructure:function(e){return log("changes cloud to local data in the form a dictionary"),e},diff_objects:function(e,t){var n,r,i;n={};for(r in e)i=e[r],t[r]!==e[r]&&(n[r]=[t[r],e[r]]);return e["parent_id"]!=null!=(t["parent_id"]!=null)&&(n.parent_id=["one of them is null"]),n},add_to_cloud:function(e,t){return log("add to cloud",e.name),Nimbus.Client.Dropbox.putFileContents("/"+Nimbus.Auth.app_name+("/"+this.name+"/"+e.id+".txt"),this.toCloudStructure(e),function(n){log(e.name,"finished being added to cloud"),log("resp",n),window.currently_syncing=!0,e.time=n.modified,e.synced=!0,e.save(),window.currently_syncing=!1;if(t!=null)return t(n)})},delete_from_cloud:function(e,t){return log("delete from cloud",e),log("delete route","/"+Nimbus.Auth.app_name+("/"+this.name+"/"+e+".txt")),Nimbus.Client.Dropbox.deletePath("/"+Nimbus.Auth.app_name+("/"+this.name+"/"+e+".txt"),function(){log("finished delete from cloud",e);if(t!=null)return t()})},update_to_cloud:function(e,t){return log("updated to cloud",e.name),Nimbus.Client.Dropbox.putFileContents("/"+Nimbus.Auth.app_name+("/"+this.name+"/"+e.id+".txt"),this.toCloudStructure(e),function(n){log(e.name,"finished being updated to cloud"),window.currently_syncing=!0,e.time=n.modified,e.synced=!0,e.save(),window.currently_syncing=!1;if(t!=null)return t(n)})},add_from_cloud:function(e,t){var n=this;return log("add from cloud",e),Nimbus.Client.Dropbox.getFileContents("/"+Nimbus.Auth.app_name+("/"+this.name+"/"+e+".txt"),function(r){var i,s;log("cloud read data",r),window.currently_syncing=!0,i=n.fromCloudStructure(r),s=n.init(i),s.synced=!0,s.time=n.cloudcache[e].time,s.save(),window.currently_syncing=!1;if(t!=null)return t(r)})},update_to_local:function(e,t){var n=this;return log("update to local",e.name),Nimbus.Client.Dropbox.getFileContents("/"+Nimbus.Auth.app_name+("/"+this.name+"/"+e.id+".txt"),function(t){var r,i;return log("cloud read data",t),window.currently_syncing=!0,r=n.fromCloudStructure(t),i=n.find(e.id),r.time=n.cloudcache[e.id].time,i.updateAttributes(r),window.currently_syncing=!1})},sync_all:function(t){var n=this;return log("syncs all the data, normally happens at the start of a program or coming back from offline"),window.current_syncing=new e(function(){return log("call back sync called"),window.current_syncing=new e(function(){window.current_syncing=null;if(t!=null)return t()}),n.sync_model_base_algo(),window.current_syncing.ready()}),this.load_all_from_cloud(),window.current_syncing.ready()},load_all_from_cloud:function(){var e,t=this;log("loads all the data from the cloud locally, probably not feasible with dropbox and changes need to happen"),this.cloudcache={};try{return Nimbus.Client.Dropbox.getMetadataList("/"+Nimbus.Auth.app_name+"/"+this.name,function(e){var n,r,i,s,o,u,a;log("call back load called"),log("data",e),u=e.contents,a=[];for(s=0,o=u.length;s<o;s++)i=u[s],r=i.path,n=r.replace("/"+Nimbus.Auth.app_name+"/"+(""+t.name+"/"),"").replace(".txt",""),a.push(t.cloudcache[n]={id:n,time:i.modified});return a},function(e){return console.log("ERROR: error called for metadataList, folder should be created"),Nimbus.Client.Dropbox.createFolder("/"+Nimbus.Auth.app_name+"/"+t.name,function(e){return log("call back create folder called",e)}),t.cloudcache={}})}catch(n){return e=n,log("trying to get the folder failed, probably cuz it don't exist",e)}},get_delta:function(){return log("get the delta for ",this.name," since last synced")},extended:function(){return this.sync(this.proxy(this.real_time_sync)),this.fetch(this.proxy(this.loadLocal))}},Nimbus.Auth.Dropbox_auth={authenticate_dropbox:function(){return localStorage.key=this.key,localStorage.secret=this.secret,localStorage.state="Auth",Nimbus.Client.Dropbox.get_request_token(this.key,this.secret,Nimbus.Client.Dropbox.authorize_token)},initialize_dropbox:function(){return log("initialization called"),document.URL.slice(0,6)==="chrome"&&(log("Chrome edition authentication"),chrome.tabs.onUpdated.addListener(function(e,t,n){if(n.title==="API Request Authorized - Dropbox")return chrome.tabs.remove(e),Nimbus.Client.Dropbox.get_access_token(function(e){return localStorage.state="Working",Nimbus.Auth.authorized_callback!=null&&Nimbus.Auth.authorized_callback(),Nimbus.Auth.app_ready_func(),console.log("NimbusBase is working! Chrome edition."),Nimbus.track.registered_user()})})),localStorage["state"]!=null&&localStorage.state==="Auth"?Nimbus.Client.Dropbox.get_access_token(function(e){return localStorage.state="Working",Nimbus.Auth.authorized_callback!=null&&Nimbus.Auth.authorized_callback(),Nimbus.Auth.app_ready_func(),console.log("NimbusBase is working!"),Nimbus.track.registered_user()}):Nimbus.Auth.app_ready_func()},dropbox_authorized:function(){return Nimbus.Auth.service==="Dropbox"?localStorage.state==="Working"?!0:!1:!1},logout_dropbox:function(e){var t,n,r;localStorage.clear();if(Nimbus.dictModel!=null){r=Nimbus.dictModel;for(t in r)n=r[t],n.records={}}this.sync_services!=null&&Nimbus.Auth.setup(this.sync_services);if(e!=null)return e()}},Nimbus.Client.Dropbox={get_request_token:function(e,t,n){var r,i;return i=new XMLHttpRequest,i.open("POST","https://api.dropbox.com/1/oauth/request_token",!0),r='OAuth oauth_version="1.0",oauth_signature_method="PLAINTEXT",oauth_consumer_key="'+e+'",oauth_signature="'+t+'&"',log(r),i.setRequestHeader("Authorization",r),i.onreadystatechange=function(){var e,t,r,i,s,o,u,a,f,l;if(this.readyState===4){if(this.status!==200){try{u=JSON.parse(u)}catch(c){}return error(u,this.status,this)}e=this.response,log(e),s=e.split(/&/),o={};for(f=0,l=s.length;f<l;f++)t=s[f],i=t.split(RegExp("="),2),o[i[0]]=i[1];log("Token result",o);for(r in o)a=o[r],localStorage[r]=a;window.request_token=o;if(n!=null)return n(o)}},i.send()},authorize_token:function(e){var t,n,r;return log("authorize url",document.URL),document.URL.slice(0,4)==="file"&&typeof cordova!="undefined"&&cordova!==null?(log("Phonegap login"),t="https://www.dropbox.com/1/oauth/authorize?oauth_token="+e.oauth_token,n=window.open(t,"_blank","location=yes"),window.ref=n,window.auth_count=0,n.addEventListener("loadstop",function(e){console.log(e),console.log("event",e.url.indexOf("https://www.dropbox.com/1/oauth/authorize?oauth_token="));if(e.url.indexOf("https://www.dropbox.com/1/oauth/authorize?oauth_token=")>=0){window.auth_count=window.auth_count+1;if(window.auth_count===2)return Nimbus.Auth.Dropbox_auth.initialize_dropbox(),window.ref.close()}}),n.addEventListener("exit",function(e){return Nimbus.Auth.logout_dropbox()})):document.URL.slice(0,4)==="http"?(r="&oauth_callback="+encodeURIComponent(document.URL),t="https://www.dropbox.com/1/oauth/authorize?oauth_token="+e.oauth_token+r,location.replace(t)):document.URL.slice(0,6)==="chrome"?(log("chrome app!"),t="https://www.dropbox.com/1/oauth/authorize?oauth_token="+e.oauth_token,chrome.tabs.create({url:t,selected:!0},function(e){return log("tab created",e.id)})):(t="https://www.dropbox.com/1/oauth/authorize?oauth_token="+e.oauth_token,location.replace(t))},get_access_token:function(e){var t,n,r,i;return n=localStorage.oauth_token,r=localStorage.oauth_token_secret,t='OAuth oauth_version="1.0",oauth_signature_method="PLAINTEXT",oauth_consumer_key="'+Nimbus.Auth.key+'",oauth_token="'+n+'",oauth_signature="'+Nimbus.Auth.secret+"&"+r+'"',log("auth_string:",t),i=new XMLHttpRequest,i.open("POST","https://api.dropbox.com/1/oauth/access_token",!0),i.setRequestHeader("Authorization",t),i.onreadystatechange=function(){var t,n,r,i,s,o,u,a,f,l;if(this.readyState===4){if(this.status!==200){try{u=JSON.parse(u)}catch(c){}return log(u,this.status,this)}n=this.response,log(n),o=n.split(/&/),t={};for(f=0,l=o.length;f<l;f++)r=o[f],s=r.split(RegExp("="),2),t[s[0]]=s[1];log("Access result",t);for(i in t)a=t[i],localStorage[i]=a;window.access_token=t;if(e!=null)return e(t)}},i.send()},send_request:function(e,t,n,r,i){var s,o,u,a,f,l;u=localStorage.oauth_token,a=localStorage.oauth_token_secret,s='OAuth oauth_version="1.0",oauth_signature_method="PLAINTEXT",oauth_consumer_key="'+Nimbus.Auth.key+'",oauth_token="'+u+'",oauth_signature="'+Nimbus.Auth.secret+"&"+a+'"',log("auth_string:",s),l=new XMLHttpRequest,l.open(e,t,!0),l.setRequestHeader("Authorization",s),l.onreadystatechange=function(){var e;if(this.readyState===4){if(this.status===200){e=this.response;try{e=JSON.parse(e)}catch(t){}log("REQUEST RESULT",e),r!=null&&r(e)}else{try{e=JSON.parse(e)}catch(t){}log(e,this.status,this),i!=null&&i(e)}if(window.current_syncing!=null)return window.current_syncing.ok()}};if(e==="POST"){l.setRequestHeader("Content-Type","application/x-www-form-urlencoded");if(n){f=[];for(o in n)f.push(encodeURIComponent(o)+"="+encodeURIComponent(n[o]));n=f.length>0?f.join("&").replace(/%20/g,"+"):null}log(n)}return log("send request params",e,t,n,r,i),window.current_syncing!=null&&window.current_syncing.wait(),l.send(n),window.xhr=l},send_request_without_delay:function(e,t,n,r,i){var s,o,u,a,f,l;u=localStorage.oauth_token,a=localStorage.oauth_token_secret,s='OAuth oauth_version="1.0",oauth_signature_method="PLAINTEXT",oauth_consumer_key="'+Nimbus.Auth.key+'",oauth_token="'+u+'",oauth_signature="'+Nimbus.Auth.secret+"&"+a+'"',log("auth_string:",s),l=new XMLHttpRequest,l.open(e,t,!0),l.setRequestHeader("Authorization",s),l.onreadystatechange=function(){var e;if(this.readyState===4)if(this.status===200){e=this.response;try{e=JSON.parse(e)}catch(t){}log("REQUEST RESULT",e);if(r!=null)return r(e)}else{try{e=JSON.parse(e)}catch(t){}log(e,this.status,this);if(i!=null)return i(e)}};if(e==="POST"){l.setRequestHeader("Content-Type","application/x-www-form-urlencoded");if(n){f=[];for(o in n)f.push(encodeURIComponent(o)+"="+encodeURIComponent(n[o]));n=f.length>0?f.join("&").replace(/%20/g,"+"):null}log(n)}return log("send request params",e,t,n,r,i),l.send(n)},putFileContents:function(e,t,n,r){return log("putFileContents"),Nimbus.Client.Dropbox.send_request("PUT","https://api-content.dropbox.com/1/files_put/sandbox"+e,t,n,r)},createFolder:function(e,t,n){return log("createFolder"),Nimbus.Client.Dropbox.send_request("POST","https://api.dropbox.com/1/fileops/create_folder",{root:"sandbox",path:e},t,n)},deletePath:function(e,t,n){return log("deletePath"),Nimbus.Client.Dropbox.send_request("POST","https://api.dropbox.com/1/fileops/delete",{root:"sandbox",path:e},t,n)},getFileContents:function(e,t,n){return log("getFileContents"),Nimbus.Client.Dropbox.send_request("GET","https://api-content.dropbox.com/1/files/sandbox"+e,"",t,n)},getMetadataList:function(e,t,n){return log("getMetadataList"),Nimbus.Client.Dropbox.send_request("GET","https://api.dropbox.com/1/metadata/sandbox"+e,"",t,n)},getAccountInfo:function(e,t){return log("getAccountInfo"),Nimbus.Client.Dropbox.send_request_without_delay("GET","https://api.dropbox.com/1/account/info","",e,t)}},window.client=null,Nimbus.Client.Dropbox.Binary={binary_setup:function(){return window.binary=Nimbus.Model.setup("binary",["name","path","copied","directlink","sharelink","expiration"])},initialize_client:function(){log("initializing second client");if(Nimbus.Auth.key==null)return log("can't upload file with no dropbox credentials");if(window.client==null)return window.client=new n.Client({key:Nimbus.Auth.key,secret:Nimbus.Auth.secret,sandbox:!0}),window.client.oauth.setToken(localStorage.oauth_token,localStorage.oauth_token_secret)},upload_blob:function(e,t,n){var r,i;return log("upload new blob"),Nimbus.Client.Dropbox.Binary.initialize_client(),window.client!=null?(i=binary.create({name:t,copied:!1}),r=function(e,t){console.log("wrote file to cloud"),console.log(e,t),i.copied=!0,i.path=t.path,i.save();if(n!=null)return n(i)},log("file name",t),window.client.writeFile(t,e,r)):log("client won't initialize")},upload_file:function(e,t){var n,r;return log("upload new file"),Nimbus.Client.Dropbox.Binary.initialize_client(),window.client!=null?(r=binary.create({name:e.name,copied:!1}),n=function(e,n){console.log("wrote file to cloud"),console.log(e,n),r.copied=!0,r.path=n.path,r.save();if(t!=null)return t(r)},log("file name",e.name),window.client.writeFile(e.name,e,n)):log("client won't initialize")},read_file:function(e,t){var n;return log("read a binary file from the server"),Nimbus.Client.Dropbox.Binary.initialize_client(),window.client!=null?(n=function(e,n,r){return console.log(e,n,r),t(n)},window.client.readFile(e.path,{blob:!0},n)):log("client won't initialize")},share_link:function(e,t){var n;log("get the share link"),Nimbus.Client.Dropbox.Binary.initialize_client();if(window.client!=null)return n=function(n,r){return console.log(n,r),e.sharelink=r.url,e.save(),t(r)},console.log(e.path),window.client.makeUrl(e.path,{},n)},direct_link:function(e,t){var n;log("get the share link"),Nimbus.Client.Dropbox.Binary.initialize_client();if(window.client!=null)return e.directlink!=null&&new Date(e.expiration)>new Date?t({url:e.directlink,expiresAt:e.expiration}):(n=function(n,r){return console.log(n,r),e.directlink=r.url,e.expiration=r.expiresAt.toString(),e.save(),t(r)},window.client.makeUrl(e.path,{download:!0,downloadHack:!0},n))},delete_file:function(e){var t;return log("delete file"),Nimbus.Client.Dropbox.Binary.initialize_client(),window.client!=null?(t=function(t,n){return e.destroy()},window.client.remove(e.path,t)):log("client won't initialize")}},window.debug=!0,window.log=function(){var e;e=1<=arguments.length?Z.call(arguments,0):[];if(window.debug)return console.log(e)},Nimbus.Client.GDrive={check_auth:function(){return log("checking if this is authenticated"),typeof gapi!="undefined"&&gapi!==null&&gapi.auth!=null&&gapi.auth.getToken()!==null},authorize:function(e,t,n){return log("authorized called"),gapi.auth.authorize({client_id:e,scope:t,immediate:!1},n)},insertFile:function(e,t,n,r,i){var s,o,u,a,f,l,c;return log("putFileContents"),o="-------314159265358979323846",a="\r\n--"+o+"\r\n",u="\r\n--"+o+"--",s=w(e),f={title:t,mimeType:n},r!=null&&(f.parents=[{kind:"drive#fileLink",id:r}]),l=a+"Content-Type: application/json\r\n\r\n"+JSON.stringify(f)+a+"Content-Type: "+n+"\r\n"+"Content-Transfer-Encoding: base64\r\n"+"\r\n"+s+u,log("MULTI: ",l),i||(i=function(e){return log("Update Complete ",e)}),c={path:"/upload/drive/v2/files",method:"POST",params:{uploadType:"multipart"},headers:{"Content-Type":'multipart/mixed; boundary="'+o+'"'},body:l},this.make_request(c,i)},deleteFile:function(e,t){var n,r=this;return log("deletePath"),t||(t=function(t){var n;return n={path:"/drive/v2/files/"+e,method:"DELETE"},r.make_request(n,function(e){return log("delete complete",e)}),log("Delete Complete ",t)}),n={path:"/drive/v2/files/"+e+"/trash",method:"POST"},this.make_request(n,t)},getFile:function(e,t){var n;return log("getFileContents"),t||(t=function(e){return log("Read Complete ",e)}),n={path:"/drive/v2/files/"+e,method:"GET"},this.make_request(n,t)},readFile:function(e,t){var n,r;return t||(t=function(e){return log("Read Complete ",e)}),n=gapi.auth.getToken().access_token,r=new XMLHttpRequest,r.open("GET",e),r.setRequestHeader("Authorization","Bearer "+n),r.onload=function(){t(r.responseText);if(window.current_syncing!=null)return window.current_syncing.ok()},r.onerror=function(){return t(null)},window.current_syncing!=null&&window.current_syncing.wait(),r.send()},updateFile:function(e,t,n,r,i,s)
{var o,u,a,f,l,c,h;return log("updateFileContents"),u="-------314159265358979323846",f="\r\n--"+u+"\r\n",a="\r\n--"+u+"--",n="text/html",l={mimeType:n},o=w(e),l={title:t,mimeType:n},c=f+"Content-Type: application/json\r\n\r\n"+JSON.stringify(l)+f+"Content-Type: "+n+"\r\n"+"Content-Transfer-Encoding: base64\r\n"+"\r\n"+o+a,s||(s=function(e){return log("Update Complete ",e)}),h={path:"/upload/drive/v2/files/"+r,method:"PUT",params:{fileId:r,uploadType:"multipart"},headers:{"Content-Type":'multipart/mixed; boundary="'+u+'"'},body:c},this.make_request(h,s)},getMetadataList:function(e,t){var n;return log("getMetadataList"),t||(t=function(e){return log("List of files",e)}),n={path:"/drive/v2/files",method:"GET",params:{q:e}},this.make_request(n,t)},make_request:function(e,t){return e.callback=function(e){t!=null&&t(e);if(window.current_syncing!=null)return window.current_syncing.ok()},window.current_syncing!=null&&window.current_syncing.wait(),gapi.client.request(e)},get_current_user:function(e){var t,n,r=this;return log("get current user"),n=function(t){var n;log("About called ",t),n={},n.name=t.user.displayName,n.id=t.user.permissionId,t["user"].picture!=null&&(n.pic=t.user.picture.url);if(e!=null)return e(n)},t={path:"/drive/v2/about",method:"GET"},this.make_request(t,n)},add_share_user:function(e,t){var n,r,i,s=this;return log("&&& add share user"),i=function(e){var n;log("Add Share user Complete ",e),n={id:e.id,name:e.name,role:e.role},e.photoLink!=null&&(n.pic=e.photoLink);if(t!=null)return t(n)},n=window.folder[Nimbus.Auth.app_name].id,r={path:"/drive/v2/files/"+n+"/permissions",method:"POST",params:{fileId:n},body:{role:"writer",type:"user",value:e}},this.make_request(r,i)},remove_share_user:function(e,t){var n,r;return log("&&& remove a user from sharing this app"),n=window.folder[Nimbus.Auth.app_name].id,t||(t=function(e){return log("Permission Removal Complete ",e)}),r={path:"/drive/v2/files/"+n+"/permissions/"+e,method:"DELETE"},this.make_request(r,t)},get_user_email:function(){var e,t,n;return window.user_email!=null?window.user_email:(e=gapi.auth.getToken().access_token,t=null,n=new XMLHttpRequest,n.onreadystatechange=function(){if(n.readyState===4)return n.status===200?t=JSON.parse(n.responseText):log("get user email failed with status "+n.status)},n.open("GET","https://www.googleapis.com/oauth2/v1/tokeninfo?access_token="+e,!1),n.send(null),(t!=null?t.email:void 0)!=null?(window.user_email=t.email,t.email):null)},get_shared_users:function(e){var t,n,r,i=this;return log("&&& get shared users"),t=window.folder[Nimbus.Auth.app_name].id,r=function(t){var n,r,i,s,o,u;log("Update Complete ",t),i=[],u=t.items;for(s=0,o=u.length;s<o;s++)n=u[s],r={id:n.id,name:n.name,role:n.role},n.photoLink!=null&&(r.pic=n.photoLink),i.push(r);log("permissions",i);if(e!=null)return e(i)},n={path:"/drive/v2/files/"+t+"/permissions",method:"GET"},this.make_request(n,r)},get_app_folders:function(e){return log("&&& get app folders"),Nimbus.Client.GDrive.getMetadataList("mimeType = 'application/vnd.google-apps.folder' and title = '"+Nimbus.Auth.app_name+"'",function(t){var n,r,i,s,o,u;log(t),r=t.items,s=[];if(t.items!=null)for(o=0,u=r.length;o<u;o++)n=r[o],i={},i.id=n.id,i.owner=n.ownerNames[0],s.push(i);log(s);if(e!=null)return e(s)})},switch_to_app_folder:function(t,n){var r=this;return log("###switch to app folder"),window.folder={},window.folder[Nimbus.Auth.app_name]={title:Nimbus.Auth.app_name,id:t},window.current_syncing=new e(function(){if(n!=null)return n()}),localStorage.main_folder_id=t,Nimbus.Client.GDrive.getMetadataList("mimeType = 'application/vnd.google-apps.folder'",function(e){var n,r,i,s,o,u,a,f;n=e.items,log("###rewriting folders",n);for(o=0,u=n.length;o<u;o++)s=n[o],log(s),s.parents.length>0&&s.parents[0].id===t&&(window.folder[s.title]=s);if(Nimbus.dictModel!=null){a=Nimbus.dictModel,f=[];for(r in a)i=a[r],f.push(i.records={});return f}}),window.current_syncing.ready()}},Nimbus.Client.GDrive.Binary={binary_setup:function(){return window.binary=Nimbus.Model.setup("binary",["name","path","copied","directlink","sharelink","expiration","file_id"])},initialize_client:function(e){log("initializing client");if(Nimbus.Auth.key==null)return log("can't upload file with no GDrive credentials");if(!Nimbus.Client.GDrive.check_auth())return Nimbus.Client.GDrive.authorize(Nimbus.Auth.key,Nimbus.Auth.secret,function(){log("GDrive authorized");if(e)return e()});if(e)return e()},upload_blob:function(e,t,n){return Nimbus.Client.GDrive.Binary.initialize_client(function(){var r;return log("upload new blob"),r=new FileReader,r.readAsBinaryString(e),r.onload=function(){var i,s,o,u,a;return s=r.result,o=e.type||"application/octet-stream",a=window.folder.binary_files.id,u=binary.create({name:t}),i=function(e){console.log("upload file to cloud"),console.log(e),u.copied=!0,u.file_id=e.id,u.directlink=e.webContentLink,u.save();if(n!=null)return n(u)},Nimbus.Client.GDrive.insertFile(s,t,o,a,i)}})},upload_file:function(e,t){return Nimbus.Client.GDrive.Binary.initialize_client(function(){var n;return log("upload new file"),n=new FileReader,n.readAsBinaryString(e),n.onload=function(){var r,i,s,o,u,a;return o=e.name,i=n.result,s=e.type||"application/octet-stream",a=window.folder.binary_files.id,u=binary.create({name:o}),r=function(e){console.log("upload file to cloud"),console.log(e),u.copied=!0,u.file_id=e.id,u.directlink=e.webContentLink,u.save();if(t!=null)return t(u)},Nimbus.Client.GDrive.insertFile(i,o,s,a,r)}})},read_file:function(e,t){return Nimbus.Client.GDrive.Binary.initialize_client(function(){var n;return log("read metadata of a file from the server"),n={path:"/drive/v2/files/"+e.file_id},Nimbus.Client.GDrive.make_request(n,function(e){console.log(e);if(t)return t(e)})})},share_link:function(e,t){return Nimbus.Client.GDrive.Binary.initialize_client(function(){return log("get the share link")})},direct_link:function(e,t){return Nimbus.Client.GDrive.Binary.initialize_client(function(){return log("get the direct link"),t(e.directlink)})},delete_file:function(e){return Nimbus.Client.GDrive.Binary.initialize_client(function(){return log("delete file",e),Nimbus.Client.GDrive.deleteFile(e.file_id,function(){return e.destroy()})})}},window.nimbus_error=[],Nimbus.Model.GDrive={cloudcache:{},last_hash:"",hash:"",toCloudStructure:function(e){return log("local to cloud structure"),JSON.stringify(e)},fromCloudStructure:function(e){return log("changes cloud to local data in the form a dictionary"),JSON.parse(e)},diff_objects:function(e,t){var n,r,i;n={};for(r in e)i=e[r],t[r]!==e[r]&&(n[r]=[t[r],e[r]]);return e["parent_id"]!=null!=(t["parent_id"]!=null)&&(n.parent_id=["one of them is null"]),n},add_to_cloud:function(e,t){var n,r;return log("add to cloud",e),r=e.parent.name,n=window.folder[r].id,Nimbus.Client.GDrive.insertFile(this.toCloudStructure(e),e.id,"text/plain",n,function(t){return log("logging data inserted",t),window.currently_syncing=!0,e.gid=t.id,e.time=t.modifiedDate,e.synced=!0,e.save(),window.currently_syncing=!1})},delete_from_cloud:function(e,t){return log("delete from cloud",e),Nimbus.Client.GDrive.getMetadataList("title = '"+e+"'",function(e){var n;log("data",e);if(!(e.items.length>0))return log("file to be deleted not there");n=e.items[0].id,Nimbus.Client.GDrive.deleteFile(n);if(t!=null)return t()})},update_to_cloud:function(e,t){var n,r,i,s,o=this;return log("updated to cloud",e.name),i=e.parent.name,r=window.folder[i].id,s=function(t){return log("logging data inserted",t),window.currently_syncing=!0,e.time=t.modifiedDate,e.save(),e.synced=!0,window.currently_syncing=!1},n=function(t){var n;return n=t.items[0].id,Nimbus.Client.GDrive.updateFile(o.toCloudStructure(e),e.id,"text/plain",n,r,function(t){return log("logging data inserted",t),window.currently_syncing=!0,e.time=t.modifiedDate,e.save(),window.currently_syncing=!1})},e.gid!=null?Nimbus.Client.GDrive.updateFile(this.toCloudStructure(e),e.id,"text/plain",e.gid,r,function(t){return log("logging data updated",t),window.currently_syncing=!0,e.time=t.modifiedDate,e.save(),window.currently_syncing=!1}):Nimbus.Client.GDrive.getMetadataList("title = '"+e.id+"'",n)},add_from_cloud:function(e,t){var n,r=this;return log("add from cloud GDrive",e),n=function(t){var n,i;return log("cloud url data",JSON.parse(t)),window.currently_syncing=!0,n=r.fromCloudStructure(t),i=r.init(n),i.synced=!0,i.time=r.cloudcache[e].time,i.save(),window.currently_syncing=!1},Nimbus.Client.GDrive.getMetadataList("title = '"+e+"'",function(e){var t;return log("cloud read data",e),window.data=e,e.items!=null&&e.items.length>=1?(t=window.data.items[0].downloadUrl,Nimbus.Client.GDrive.readFile(t,n)):log("This data is not there")})},update_to_local:function(e,t){var n,r=this;return log("update to local",e),n=function(t){var n,i;return log("cloud url data",JSON.parse(t)),window.currently_syncing=!0,n=r.fromCloudStructure(t),i=r.find(e.id),n.time=r.cloudcache[e.id].time,i.updateAttributes(n),window.currently_syncing=!1},Nimbus.Client.GDrive.getMetadataList("title = '"+e.id+"'",function(t){var r;return log("cloud read data",t),window.data=t,t.error!=null?(window.nimbus_error.push({error:t.error,object:e}),console.log("##ERROR writing back to local",t.error,"object: ",e)):t.items.length>=1?(r=window.data.items[0].downloadUrl,Nimbus.Client.GDrive.readFile(r,n)):log("This data is not there")})},sync_all:function(t){var n=this;return log("syncs all the data, normally happens at the start of a program or coming back from offline"),window.current_syncing=new e(function(){return log("call back sync called"),window.current_syncing=new e(function(){window.current_syncing=null;if(t!=null)return t()}),n.sync_model_base_algo(),window.current_syncing.ready()}),this.load_all_from_cloud(),window.current_syncing.ready()},load_all_from_cloud:function(){var e,t,n,r=this;return log("loads all the data from the cloud locally"),this.cloudcache={},n=this.name,log("object name",n),window.folder[n]!=null?(t=window.folder[n].id,e=function(e){var t,i,s,o,u;log("cloud read data",n,e),window.data=e;if(e.items!=null){o=e.items,u=[];for(i=0,s=o.length;i<s;i++)t=o[i],r.cloudcache[t.title]={id:t.title,time:t.modifiedDate},t.labels.trashed?u.push(console.log("##### this is trashed #####",t)):u.push(void 0);return u}return log("###ERROR, no return data")},Nimbus.Client.GDrive.getMetadataList("'"+t+"' in parents",e)):log("############################BIG ERROR no folder there for load from cloud")},get_delta:function(){return log("get the delta for ",this.name," since last synced")},extended:function(){return this.sync(this.proxy(this.real_time_sync)),this.fetch(this.proxy(this.loadLocal))}},window.folder=null,window.folder_creation=new f,window.creating={},window.handle_initialization=new f,window.gdrive_initialized=!1,window.folder_initialize=function(e){log("&&& folder initialize"),log("Nimbus.Client.GDrive.check_auth()",Nimbus.Client.GDrive.check_auth(),"Nimbus.Auth.service",Nimbus.Auth.service);if(Nimbus.Client.GDrive.check_auth()&&Nimbus.Auth.service==="GDrive")return log("this is authenticated and a GDrive app"),Nimbus.Client.GDrive.getMetadataList("mimeType = 'application/vnd.google-apps.folder'",function(t){var n,r,i,s,o,u;log("#data: ",t),window.folder===null&&(window.folder={}),n=t.items;if(localStorage["main_folder_id"]!=null)window.folder[Nimbus.Auth.app_name]={title:Nimbus.Auth.app_name,id:localStorage.main_folder_id};else for(i=0,o=n.length;i<o;i++)r=n[i],r.title===Nimbus.Auth.app_name&&(window.folder[r.title]=r);if(window.folder[Nimbus.Auth.app_name]==null)window.folder={},e!=null?Nimbus.Client.GDrive.insertFile("",Nimbus.Auth.app_name,"application/vnd.google-apps.folder",null,function(t){log("folder data",t),window.folder[t.title]=t;if(e!=null)return e()}):Nimbus.Client.GDrive.insertFile("",Nimbus.Auth.app_name,"application/vnd.google-apps.folder");else{log("base folder there: ",window.folder[Nimbus.Auth.app_name].id);for(s=0,u=n.length;s<u;s++)r=n[s],log(r),r.parents.length>0&&r.parents[0].id===window.folder[Nimbus.Auth.app_name].id&&(window.folder[r.title]=r);e!=null&&e()}if(window.folder["binary_files"]==null)return Nimbus.Client.GDrive.insertFile("","binary_files","application/vnd.google-apps.folder",window.folder[Nimbus.Auth.app_name].id,function(e){return log("binary_files folder data",e)})})},window.model_initialize=function(e){log("initialized model",e),log("#loaded",window.loaded,window.gdrive_initialized);if(!window.loaded||!Nimbus.Client.GDrive.check_auth()){log("initialization called later"),window.handle_initialization.add_call(function(){return window.model_initialize(e)});return}if(window.folder!==null)return window.folder[e.name]!=null?log("model folder there"):(log("creating model folder for",e.name),Nimbus.Client.GDrive.insertFile("",e.name,"application/vnd.google-apps.folder",window.folder[Nimbus.Auth.app_name].id,function(e){return window.folder[e.title]=e}));log("window.folder object not present"),log("#folder creation is running",window.folder_creation.running);if(window.creating[e.name]==null)return window.creating[e.name]=!0,window.folder_creation.running===!1&&window.folder_initialize(function(){return window.folder_creation.execute_callback()}),window.folder_creation.add_call(function(){log("THE CALLBACK IS CALLED","model.name exists",window.folder[e.name]!=null);if(window.folder[e.name]==null)return Nimbus.Client.GDrive.insertFile("",e.name,"application/vnd.google-apps.folder",window.folder[Nimbus.Auth.app_name].id,function(e){return window.folder[e.title]=e})})},Nimbus.Auth.GDrive={get_token_from_code:function(e){var t,n,r=this;return n=new XMLHttpRequest,t="code="+e+"&client_id="+this.key+"&client_secret="+this.client_secret+"&grant_type=authorization_code&redirect_uri=urn%3Aietf%3Awg%3Aoauth%3A2.0%3Aoob",window.data=t,n.open("POST","https://accounts.google.com/o/oauth2/token"),n.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),n.onreadystatechange=function(e,t){if(n.readyState===4)try{return console.log("xhr",n),console.log("TOKEN RETRIEVAL LOGGED"),console.log("response: ",n.response)}catch(r){}},n.send(t),window.xhr=n},authenticate_gdrive:function(){var t,n;return log("this should bring up a prompt to initialize into GDrive"),localStorage.d_key=this.key,localStorage.secret=this.secret,localStorage.state="Auth",document.URL.slice(0,4)==="file"&&typeof cordova!="undefined"&&cordova!==null?(log("Phonegap google login"),t="https://accounts.google.com/o/oauth2/auth?response_type=token&client_id="+this.key+"&scope="+this.secret+"&approval_prompt=auto&redirect_uri=http%3A%2F%2Fnimbusbase.com",console.log(t),window.auth_url=t,n=window.open(t,"_blank","location=yes"),window.ref=n,n.addEventListener("loadstop",function(t){var n,r=this;console.log(t),console.log("event",t.url.indexOf("http://nimbusbase.com/"));if(t.url.indexOf("http://nimbusbase.com/")>=0){n=t.url.split("access_token=")[1].split("&token_type")[0],gapi.auth.setToken({access_token:n,scope:"https://www.googleapis.com/auth/drive",client_id:localStorage.d_key}),window.current_syncing=new e(function(){return log("CURRENT SYNCING CALLBACK"),Nimbus.Auth.app_ready_func()}),log("handle_initialization",window.handle_initialization),window.handle_initialization!=null&&window.handle_initialization.execute_callback(),window.current_syncing.ready(),window.ref.close(),Nimbus.track.registered_user();if(Nimbus.Auth.authorized_callback!=null)return Nimbus.Auth.authorized_callback()}}),n.addEventListener("exit",function(e){return Nimbus.Auth.logout_gdrive()})):gapi.auth.authorize({client_id:this.key,scope:this.secret,immediate:!1},function(t){var n=this;log("client load handled GDrive"),log(t);if(t!==null){window.current_syncing=new e(function(){return log("CURRENT SYNCING CALLBACK"),Nimbus.Auth.app_ready_func()}),Nimbus.track.registered_user(),log("handle_initialization",window.handle_initialization),window.handle_initialization!=null&&window.handle_initialization.execute_callback(),window.current_syncing.ready();if(Nimbus.Auth.authorized_callback!=null)return Nimbus.Auth.authorized_callback()}})},initialize_gdrive:function(){log("This part should reflect what initialization needs to be done for GDrive auth"),window.gdrive_initialized=!0;if(window.loaded)return console.log("GDrive loaded"),gapi.auth.init(),gapi.auth.authorize({client_id:this.key,scope:this.secret,immediate:!0},function(t){var n=this;log("client load handled GDrive"),log(t);if(t!==null){window.current_syncing=new e(function(){return log("CURRENT SYNCING CALLBACK"),Nimbus.Auth.app_ready_func()}),window.handle_initialization!=null&&window.handle_initialization.execute_callback(),window.current_syncing.ready();if(Nimbus.Auth.authorized_callback!=null)return Nimbus.Auth.authorized_callback()}})},gdrive_authorized:function(){return Nimbus.Client.GDrive.check_auth()},logout_gdrive:function(e){var t,n,r;localStorage.clear(),gapi.auth.setToken(null);if(Nimbus.dictModel!=null){r=Nimbus.dictModel;for(t in r)n=r[t],n.records={}}this.sync_services!=null&&Nimbus.Auth.setup(this.sync_services);if(e!=null)return e()}},Nimbus.Auth.Multi={authenticate_service:function(e){var t,n,r,i,s;log("authenticate a single service",e),t=Array.isArray||function(e){return{}.toString.call(e)==="[object Array]"};if(this.sync_services!=null&&this.sync_services[e]!=null){i=this.sync_services[e],e==="Dropbox"&&Nimbus.Auth.setup(e,i.key,i.secret,i.app_name),e==="GDrive"&&(t(i.scope)&&(i.scope=i.scope.join(" ")),i.client_secret!=null?Nimbus.Auth.setup(e,i.key,i.scope,i.app_name,i.client_secret):Nimbus.Auth.setup(e,i.key,i.scope,i.app_name)),s=Nimbus.dictModel;for(n in s)r=s[n],Nimbus.Model.service_setup(r);return Nimbus.Auth.authorize()}},initialize_service:function(){return log("initializing service")}},Nimbus.Auth.reinitialize(),Nimbus.backbone_store=function(e,t){var n,r,i,s,o,u,a;log("Model on creation",t),this.name=e,i=new t,r=[],a=i.attributes;for(n in a)u=a[n],r.push(n);return s=Nimbus.Model.setup(e,r),o=s,this.data=s.all()||{},o},Nimbus.backbone_sync=function(e,t,n){var r,i,s,o;i=void 0,o=t.nimbus||t.collection.nimbus,window.model=t;switch(e){case"read":if(!t.id){o.sync_all(function(){return i=o.all(),n.success(i)});return}i=o.find(t);break;case"create":console.log("create called"),r=o.init(t.attributes),r.id=t.id,r.save(),i=r;break;case"update":s=o.find(t.id),s.updateAttributes(t.attributes),s.save(),i=s;break;case"delete":console.log("deletion find",o.find(t.id)),i=o.find(t.id).destroy()}return i?n.success(i):n.error("Record not found")},Nimbus.angularService=function(){var e,t,n;return e={},n=function(t,n,r){var i;return i=Nimbus.Model.setup(t,n),i.sync_all(r),e.name=i,i},t=function(e){return function(){return localStorage[e]}},{setup:n,makeWatcher:t}},"use strict",H=this;if(H.Base64)return;$="2.1.2",x=void 0,typeof module!="undefined"&&module.exports&&(x=require("buffer").Buffer),v="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",m=function(e){var t,n,r;r={},t=0,n=e.length;while(t<n)r[e.charAt(t)]=t,t++;return r},v,P=String.fromCharCode,k=function(e){var t;return e.length<2?(t=e.charCodeAt(0),t<128?e:t<2048?P(192|t>>>6)+P(128|t&63):P(224|t>>>12&15)+P(128|t>>>6&63)+P(128|t&63)):(t=65536+(e.charCodeAt(0)-55296)*1024+(e.charCodeAt(1)-56320),P(240|t>>>18&7)+P(128|t>>>12&63)+P(128|t>>>6&63)+P(128|t&63))},U=/[\uD800-\uDBFF][\uDC00-\uDFFFF]|[^\x00-\x7F]/g,V=function(e){return e.replace(U,k)},C=function(e){var t,n,r;return r=[0,2,1][e.length%3],n=e.charCodeAt(0)<<16|(e.length>1?e.charCodeAt(1):0)<<8|(e.length>2?e.charCodeAt(2):0),t=[v.charAt(n>>>18),v.charAt(n>>>12&63),r>=2?"=":v.charAt(n>>>6&63),r>=1?"=":v.charAt(n&63)],t.join("")},w=H.btoa||function(e){return e.replace(/[\s\S]{1,3}/g,C)},Q=x?function(e){return(new x(e)).toString("base64")}:function(e){return w(V(e))},M=function(e,t){return t?Q(e).replace(/[+\/]/g,function(e){return e==="+"?"-":"_"}).replace(RegExp("=","g"),""):Q(e)},_=function(e){return M(e,!0)},R=R=new RegExp(["[-][-]","[-][-]{2}","[-][-]{3}"].join("|"),"g"),T=function(e){var t,n;switch(e.length){case 4:return t=(7&e.charCodeAt(0))<<18|(63&e.charCodeAt(1))<<12|(63&e.charCodeAt(2))<<6|63&e.charCodeAt(3),n=t-65536,P((n>>>10)+55296)+P((n&1023)+56320);case 3:return P((15&e.charCodeAt(0))<<12|(63&e.charCodeAt(1))<<6|63&e.charCodeAt(2));default:return P((31&e.charCodeAt(0))<<6|63&e.charCodeAt(1))}},S=function(e){return e.replace(R,T)},N=function(e){var t,n,r,i;return n=e.length,i=n%4,r=(n>0?m[e.charAt(0)]<<18:0)|(n>1?m[e.charAt(1)]<<12:0)|(n>2?m[e.charAt(2)]<<6:0)|(n>3?m[e.charAt(3)]:0),t=[P(r>>>16),P(r>>>8&255),P(r&255)],t.length-=[0,0,2,1][i],t.join("")},p=H.atob||function(e){return e.replace(/[\s\S]{1,4}/g,N)},K=x?function(e){return(new x(e,"base64")).toString()}:function(e){return S(p(e))},A=function(e){return K(e.replace(/[-_]/g,function(e){return e==="-"?"+":"/"}).replace(/[^A-Za-z0-9\+\/]/g,""))},H.Base64={VERSION:$,atob:p,btoa:w,fromBase64:A,toBase64:M,utob:V,encode:M,encodeURI:_,btou:S,decode:A},typeof Object.defineProperty=="function"&&(q=function(e){return{value:e,enumerable:!1,writable:!0,configurable:!0}},H.Base64.extendString=function(){return Object.defineProperty(String.prototype,"fromBase64",q(function(){return A(this)})),Object.defineProperty(String.prototype,"toBase64",q(function(e){return M(this,e)})),Object.defineProperty(String.prototype,"toBase64URI",q(function(){return M(this,!0)}))}),F="57da9d172e8c2000bca77d9ebb935752",Nimbus.track={send_people_request:function(e){var t,n,r=this;return n=new XMLHttpRequest,log(JSON.stringify(e)),t=Base64.encode(JSON.stringify(e)),window.data="data="+t,n.open("POST","http://api.mixpanel.com/engage"),n.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),n.onreadystatechange=function(e,t){if(n.readyState===4)try{return log("xhr",n),log("mixpanel response done"),log("response: ",n.response)}catch(r){}},n.send(data),window.xhr=n},registered_user:function(){log("registered user"),Nimbus.Auth.service==="Dropbox"&&Nimbus.Client.Dropbox.getAccountInfo(function(e){var t,n,r,i,s,o;return i=e.display_name,o=i.split(" "),n=o[0],r=o[1],t="",e.email!=null&&(t=e.email),s={$set:{$first_name:n,$last_name:r,$app:Nimbus.Auth.app_name,$service:Nimbus.Auth.service,$email:t},$token:F,$distinct_id:t},log(s),Nimbus.track.send_people_request(s)});if(Nimbus.Auth.service==="GDrive")return Nimbus.Client.GDrive.get_current_user(function(e){var t,n,r,i,s;return r=e.name,s=r.split(" "),t=s[0],n=s[1],i={$set:{$first_name:t,$last_name:n,$app:Nimbus.Auth.app_name,$service:Nimbus.Auth.service},$token:F,$distinct_id:e.name},log(i),Nimbus.track.send_people_request(i)})},report_storage_stat:function(){var e,t;return log("report storage stat"),t=new Date,localStorage["last_reported_date"]!=null&&(e=localStorage.last_reported_date),e?(t-e>864e5&&log("start sending data"),localStorage.last_reported_date=t):log("start sending data")}},this.Nimbus=Nimbus}).call(this);